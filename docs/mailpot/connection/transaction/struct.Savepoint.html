<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A savepoint handle."><title>Savepoint in mailpot::connection::transaction - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-d1c027e9fb12379c.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="mailpot" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0-nightly (3b2073f07 2023-06-17)" data-search-js="search-1e8f84b2d523d42b.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../../../static.files/storage-62ce34ea385b278a.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-190c35055d2a8300.js"></script><script defer src="../../../static.files/scrape-examples-ef1e698c1d417c0c.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc struct"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><style>
.rustdoc { flex-wrap: wrap; }
@media (prefers-color-scheme: light) {
    :root {
        --border-primary: #cdcdcd;
        --border-secondary: #cdcdcd;
        --a-normal-text: #034575;
        --a-normal-underline: #bbb;
        --a-visited-underline: #707070;
        --a-hover-bg: #bfbfbf40;
        --a-active-text: #c00;
        --a-active-underline: #c00;
        --accent-primary: #0085f2;
        --accent-primary-engage: #0085f21a;
        --accent-secondary: #0085f2;
        --accent-tertiary: #0085f21a;
        color-scheme: light;
    }
}

@media (prefers-color-scheme: dark) {
    :root {
        --border-primary: #858585;
        --border-secondary: #696969;
        --a-normal-text: #4db4ff;
        --a-normal-underline: #8b8b8b;
        --a-visited-underline: #707070;
        --a-hover-bg: #bfbfbf40;
        --a-active-text: #c00;
        --a-active-underline: #c00;
        --accent-primary: #5e9eff;
        --accent-primary-engage: #5e9eff1a;
        --accent-secondary: #5e9eff;
        --accent-tertiary: #0085f21a;
        color-scheme: dark;
    }
}

nav.main-nav {
  padding: 0rem 1rem;
  border: 0.1rem solid var(--border-secondary);
  border-left: none;
  border-right: none;
  border-radius: 2px;
  padding: 10px 14px 10px 10px;
  margin-bottom: 10px;
  /*! width: 100%; */
  height: max-content;
  width: 100vw;
}

nav.main-nav * {
  padding: 0;
  margin: 0;
}

nav.main-nav > ul {
  display: flex;
  flex-wrap: wrap;
  row-gap: 1rem;
  list-style: none;
}

nav.main-nav > ul > li > a {
  padding: 1rem;
}
nav.main-nav a[href] {
  text-decoration: underline;
    text-decoration-color: currentcolor;
  color: #034575;
  color: var(--a-normal-text);
  text-decoration-color: #707070;
  text-decoration-color: var(--accent-secondary);
  text-decoration-skip-ink: none;
  font-synthesis: none;
font-feature-settings: "onum" 1;
text-rendering: optimizeLegibility;
font-family: -apple-system,BlinkMacSystemFont,Roboto,Roboto Slab,Droid Serif,Segoe UI,system-ui,Arial,sans-serif;
font-size: 1.125em;
}
nav.main-nav > ul > li > a:hover {
  outline: 0.1rem solid;
  outline-offset: -0.5rem;
}
a[href]:focus, a[href]:hover {
  text-decoration-thickness: 2px;
  text-decoration-skip-ink: none;
}
</style>
<nav class="main-nav">
  <ul>
    <li><a href="https://git.meli.delivery/meli/mailpot">Gitea Repository</a></li>
    <li><a href="https://github.com/meli/mailpot">Github Repository</a></li>
    <li><a href="https://lists.meli.delivery/">Official Instance</a></li>
    <li><a href="https://meli.github.io/mailpot/lists/2/">Static Demo</a></li>
  </ul>
</nav>

<nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../mailpot/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../mailpot/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Savepoint</a></h2><div class="sidebar-elems"><section><h3><a href="#fields">Fields</a></h3><ul class="block"><li><a href="#structfield.committed">committed</a></li><li><a href="#structfield.conn">conn</a></li><li><a href="#structfield.drop_behavior">drop_behavior</a></li><li><a href="#structfield.name">name</a></li></ul><h3><a href="#implementations">Methods</a></h3><ul class="block"><li><a href="#method.commit">commit</a></li><li><a href="#method.commit_">commit_</a></li><li><a href="#method.finish">finish</a></li><li><a href="#method.finish_">finish_</a></li><li><a href="#method.rollback">rollback</a></li><li><a href="#method.rollback_">rollback_</a></li><li><a href="#method.set_drop_behavior">set_drop_behavior</a></li></ul><h3><a href="#deref-methods-Connection">Methods from Deref&lt;Target=Connection&gt;</a></h3><ul class="block"><li><a href="#method.accept_candidate_subscription">accept_candidate_subscription</a></li><li><a href="#method.account">account</a></li><li><a href="#method.account_by_address">account_by_address</a></li><li><a href="#method.account_subscriptions">account_subscriptions</a></li><li><a href="#method.accounts">accounts</a></li><li><a href="#method.add_account">add_account</a></li><li><a href="#method.add_candidate_subscription">add_candidate_subscription</a></li><li><a href="#method.add_list_owner">add_list_owner</a></li><li><a href="#method.add_subscription">add_subscription</a></li><li><a href="#method.add_template">add_template</a></li><li><a href="#method.candidate_subscription">candidate_subscription</a></li><li><a href="#method.conf">conf</a></li><li><a href="#method.create_list">create_list</a></li><li><a href="#method.delete_from_queue">delete_from_queue</a></li><li><a href="#method.fetch_template">fetch_template</a></li><li><a href="#method.fetch_templates">fetch_templates</a></li><li><a href="#method.get_settings">get_settings</a></li><li><a href="#method.inner_post">inner_post</a></li><li><a href="#method.insert_post">insert_post</a></li><li><a href="#method.insert_to_queue">insert_to_queue</a></li><li><a href="#method.list">list</a></li><li><a href="#method.list_by_id">list_by_id</a></li><li><a href="#method.list_filters">list_filters</a></li><li><a href="#method.list_owners">list_owners</a></li><li><a href="#method.list_post_by_message_id">list_post_by_message_id</a></li><li><a href="#method.list_post_policy">list_post_policy</a></li><li><a href="#method.list_posts">list_posts</a></li><li><a href="#method.list_subscription">list_subscription</a></li><li><a href="#method.list_subscription_by_address">list_subscription_by_address</a></li><li><a href="#method.list_subscription_policy">list_subscription_policy</a></li><li><a href="#method.list_subscriptions">list_subscriptions</a></li><li><a href="#method.lists">lists</a></li><li><a href="#method.load_archives">load_archives</a></li><li><a href="#method.migrate">migrate</a></li><li><a href="#method.months">months</a></li><li><a href="#method.new_smtp_connection">new_smtp_connection</a></li><li><a href="#method.post">post</a></li><li><a href="#method.queue">queue</a></li><li><a href="#method.remove_account">remove_account</a></li><li><a href="#method.remove_list_owner">remove_list_owner</a></li><li><a href="#method.remove_list_post_policy">remove_list_post_policy</a></li><li><a href="#method.remove_list_subscription_policy">remove_list_subscription_policy</a></li><li><a href="#method.remove_subscription">remove_subscription</a></li><li><a href="#method.remove_template">remove_template</a></li><li><a href="#method.request">request</a></li><li><a href="#method.savepoint">savepoint</a></li><li><a href="#method.schema_version">schema_version</a></li><li><a href="#method.send_reply_with_list_template">send_reply_with_list_template</a></li><li><a href="#method.set_list_post_policy">set_list_post_policy</a></li><li><a href="#method.set_list_subscription_policy">set_list_subscription_policy</a></li><li><a href="#method.update_account">update_account</a></li><li><a href="#method.update_list">update_list</a></li><li><a href="#method.update_subscription">update_subscription</a></li></ul><h3><a href="#trait-implementations">Trait Implementations</a></h3><ul class="block"><li><a href="#impl-Debug-for-Savepoint%3C'conn%3E">Debug</a></li><li><a href="#impl-Deref-for-Savepoint%3C'_%3E">Deref</a></li><li><a href="#impl-Drop-for-Savepoint%3C'_%3E">Drop</a></li></ul><h3><a href="#synthetic-implementations">Auto Trait Implementations</a></h3><ul class="block"><li><a href="#impl-RefUnwindSafe-for-Savepoint%3C'conn%3E">!RefUnwindSafe</a></li><li><a href="#impl-Send-for-Savepoint%3C'conn%3E">!Send</a></li><li><a href="#impl-Sync-for-Savepoint%3C'conn%3E">!Sync</a></li><li><a href="#impl-UnwindSafe-for-Savepoint%3C'conn%3E">!UnwindSafe</a></li><li><a href="#impl-Unpin-for-Savepoint%3C'conn%3E">Unpin</a></li></ul><h3><a href="#blanket-implementations">Blanket Implementations</a></h3><ul class="block"><li><a href="#impl-Any-for-Savepoint%3C'conn%3E">Any</a></li><li><a href="#impl-Borrow%3CT%3E-for-Savepoint%3C'conn%3E">Borrow&lt;T&gt;</a></li><li><a href="#impl-BorrowMut%3CT%3E-for-Savepoint%3C'conn%3E">BorrowMut&lt;T&gt;</a></li><li><a href="#impl-From%3CT%3E-for-Savepoint%3C'conn%3E">From&lt;T&gt;</a></li><li><a href="#impl-Into%3CU%3E-for-Savepoint%3C'conn%3E">Into&lt;U&gt;</a></li><li><a href="#impl-TryFrom%3CU%3E-for-Savepoint%3C'conn%3E">TryFrom&lt;U&gt;</a></li><li><a href="#impl-TryInto%3CU%3E-for-Savepoint%3C'conn%3E">TryInto&lt;U&gt;</a></li></ul></section><h2><a href="index.html">In mailpot::connection::transaction</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Struct <a href="../../index.html">mailpot</a>::<wbr><a href="../index.html">connection</a>::<wbr><a href="index.html">transaction</a>::<wbr><a class="struct" href="#">Savepoint</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/mailpot/connection.rs.html#891-896">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>pub struct Savepoint&lt;'conn&gt; {
    pub(super) conn: &amp;'conn <a class="struct" href="../struct.Connection.html" title="struct mailpot::connection::Connection">Connection</a>,
    pub(super) drop_behavior: <a class="enum" href="enum.DropBehavior.html" title="enum mailpot::connection::transaction::DropBehavior">DropBehavior</a>,
    pub(super) name: <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;&amp;'static <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>, <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.usize.html">usize</a>&gt;,
    pub(super) committed: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.bool.html">bool</a>,
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A savepoint handle.</p>
</div></details><h2 id="fields" class="fields small-section-header">Fields<a href="#fields" class="anchor">§</a></h2><span id="structfield.conn" class="structfield small-section-header"><a href="#structfield.conn" class="anchor field">§</a><code>conn: &amp;'conn <a class="struct" href="../struct.Connection.html" title="struct mailpot::connection::Connection">Connection</a></code></span><span id="structfield.drop_behavior" class="structfield small-section-header"><a href="#structfield.drop_behavior" class="anchor field">§</a><code>drop_behavior: <a class="enum" href="enum.DropBehavior.html" title="enum mailpot::connection::transaction::DropBehavior">DropBehavior</a></code></span><span id="structfield.name" class="structfield small-section-header"><a href="#structfield.name" class="anchor field">§</a><code>name: <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;&amp;'static <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>, <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.usize.html">usize</a>&gt;</code></span><span id="structfield.committed" class="structfield small-section-header"><a href="#structfield.committed" class="anchor field">§</a><code>committed: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.bool.html">bool</a></code></span><h2 id="implementations" class="small-section-header">Implementations<a href="#implementations" class="anchor">§</a></h2><div id="implementations-list"><details class="toggle implementors-toggle" open><summary><section id="impl-Savepoint%3C'_%3E" class="impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#904-978">source</a><a href="#impl-Savepoint%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'_&gt;</h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.commit" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#906-908">source</a><h4 class="code-header">pub fn <a href="#method.commit" class="fn">commit</a>(self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Commit and consume savepoint.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples"><a href="#scraped-examples">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[28,28],&quot;../../../src/mailpot/connection.rs.html#302&quot;,&quot;line 302&quot;],[[142,142],&quot;../../../src/mailpot/connection.rs.html#416&quot;,&quot;line 416&quot;],[[451,451],&quot;../../../src/mailpot/connection.rs.html#725&quot;,&quot;line 725&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#302">line 302</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>migrate(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="kw-2">mut </span>from: u32, to: u32) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">if </span>from == to {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>undo = from &gt; to;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(migrate)))<span class="question-mark">?</span>;

        <span class="kw">while </span>from != to {
            <span class="macro">log::trace!</span>(
                <span class="string">&quot;exec migration from {from} to {to}, type: {}do&quot;</span>,
                <span class="kw">if </span>undo { <span class="string">&quot;un &quot; </span>} <span class="kw">else </span>{ <span class="string">&quot;re&quot; </span>}
            );
            <span class="kw">if </span>undo {
                <span class="macro">trace!</span>(<span class="string">&quot;{}&quot;</span>, <span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">2</span>);
                tx.connection
                    .execute_batch(<span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">2</span>)<span class="question-mark">?</span>;
                from -= <span class="number">1</span>;
            } <span class="kw">else </span>{
                <span class="macro">trace!</span>(<span class="string">&quot;{}&quot;</span>, <span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize].<span class="number">1</span>);
                tx.connection
                    .execute_batch(<span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize].<span class="number">1</span>)<span class="question-mark">?</span>;
                from += <span class="number">1</span>;
            }
        }
        tx.connection
            .pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;user_version&quot;</span>, <span class="self">Self</span>::MIGRATIONS[to <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">0</span>)<span class="question-mark">?</span>;

        tx.<span class="highlight focus">commit</span>()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Removes operational limits from this connection. (see
    /// [`Connection::untrusted`])
    </span><span class="attr">#[must_use]
    </span><span class="kw">pub fn </span>trusted(<span class="self">self</span>) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.connection
            .authorizer::&lt;<span class="kw">fn</span>(rusqlite::hooks::AuthContext&lt;<span class="lifetime">&#39;_</span>&gt;) -&gt; rusqlite::hooks::Authorization&gt;(
                <span class="prelude-val">None</span>,
            );
        <span class="self">self
    </span>}

    <span class="comment">// [tag:sync_auth_doc]
    </span><span class="doccomment">/// Sets operational limits for this connection.
    ///
    /// - Allow `INSERT`, `DELETE` only for &quot;queue&quot;, &quot;candidate_subscription&quot;,
    ///   &quot;subscription&quot;.
    /// - Allow `UPDATE` only for &quot;subscription&quot; user facing settings.
    /// - Allow `INSERT` only for &quot;post&quot;.
    /// - Allow read access to all tables.
    /// - Allow `SELECT`, `TRANSACTION`, `SAVEPOINT`, and the `strftime`
    ///   function.
    /// - Deny everything else.
    </span><span class="kw">pub fn </span>untrusted(<span class="self">self</span>) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.connection.authorizer(<span class="prelude-val">Some</span>(user_authorizer_callback));
        <span class="self">self
    </span>}

    <span class="doccomment">/// Create a database if it doesn&#39;t exist and then open it.
    </span><span class="kw">pub fn </span>open_or_create_db(conf: Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>&gt; {
        <span class="kw">if </span>!conf.db_path.exists() {
            <span class="kw">let </span>db_path = <span class="kw-2">&amp;</span>conf.db_path;
            <span class="kw">use </span>std::os::unix::fs::PermissionsExt;

            <span class="macro">info!</span>(<span class="string">&quot;Creating database in {}&quot;</span>, db_path.display());
            std::fs::File::create(db_path).context(<span class="string">&quot;Could not create db path&quot;</span>)<span class="question-mark">?</span>;

            <span class="kw">let </span><span class="kw-2">mut </span>child = Command::new(std::env::var(<span class="string">&quot;SQLITE_BIN&quot;</span>).unwrap_or(<span class="string">&quot;sqlite3&quot;</span>.into()))
                .arg(db_path)
                .stdin(Stdio::piped())
                .stdout(Stdio::piped())
                .stderr(Stdio::piped())
                .spawn()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().unwrap();
            std::thread::spawn(<span class="kw">move </span>|| {
                stdin
                    .write_all(<span class="self">Self</span>::SCHEMA.as_bytes())
                    .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                <span class="kw">if </span>!<span class="self">Self</span>::MIGRATIONS.is_empty() {
                    stdin
                        .write_all(<span class="string">b&quot;\nPRAGMA user_version = &quot;</span>)
                        .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                    stdin
                        .write_all(
                            <span class="self">Self</span>::MIGRATIONS[<span class="self">Self</span>::MIGRATIONS.len() - <span class="number">1</span>]
                                .<span class="number">0
                                </span>.to_string()
                                .as_bytes(),
                        )
                        .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                    stdin.write_all(<span class="string">b&quot;;&quot;</span>).expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                }
                stdin.flush().expect(<span class="string">&quot;could not flush stdin&quot;</span>);
            });
            <span class="kw">let </span>output = child.wait_with_output()<span class="question-mark">?</span>;
            <span class="kw">if </span>!output.status.success() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                    <span class="string">&quot;Could not initialize sqlite3 database at {}: sqlite3 returned exit code {} \
                     and stderr {} {}&quot;</span>,
                    db_path.display(),
                    output.status.code().unwrap_or_default(),
                    String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                    String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                )
                .into());
            }

            <span class="kw">let </span>file = std::fs::File::open(db_path)<span class="question-mark">?</span>;
            <span class="kw">let </span>metadata = file.metadata()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>permissions = metadata.permissions();

            permissions.set_mode(<span class="number">0o600</span>); <span class="comment">// Read/write for owner only.
            </span>file.set_permissions(permissions)<span class="question-mark">?</span>;
        }
        <span class="self">Self</span>::open_db(conf)
    }

    <span class="doccomment">/// Returns a connection&#39;s configuration.
    </span><span class="kw">pub fn </span>conf(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>Configuration {
        <span class="kw-2">&amp;</span><span class="self">self</span>.conf
    }

    <span class="doccomment">/// Loads archive databases from [`Configuration::data_path`], if any.
    </span><span class="kw">pub fn </span>load_archives(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(load_archives)))<span class="question-mark">?</span>;
        {
            <span class="kw">let </span><span class="kw-2">mut </span>stmt = tx.connection.prepare(<span class="string">&quot;ATTACH ? AS ?;&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">for </span>archive <span class="kw">in </span>std::fs::read_dir(<span class="kw-2">&amp;</span><span class="self">self</span>.conf.data_path)<span class="question-mark">? </span>{
                <span class="kw">let </span>archive = archive<span class="question-mark">?</span>;
                <span class="kw">let </span>path = archive.path();
                <span class="kw">let </span>name = path.file_name().unwrap_or_default();
                <span class="kw">if </span>path == <span class="self">self</span>.conf.db_path {
                    <span class="kw">continue</span>;
                }
                stmt.execute(<span class="macro">rusqlite::params!</span>[
                    path.to_str().unwrap(),
                    name.to_str().unwrap()
                ])<span class="question-mark">?</span>;
            }
        }
        tx.<span class="highlight">commit</span>()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Returns a vector of existing mailing lists.
    </span><span class="kw">pub fn </span>lists(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(<span class="string">&quot;SELECT * FROM list;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                MailingList {
                    pk,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                    topics,
                    archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch a mailing list by primary key.
    </span><span class="kw">pub fn </span>list(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM list WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row([<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch a mailing list by id.
    </span><span class="kw">pub fn </span>list_by_id&lt;S: AsRef&lt;str&gt;&gt;(<span class="kw-2">&amp;</span><span class="self">self</span>, id: S) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span>id = id.as_ref();
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM list WHERE id = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row([<span class="kw-2">&amp;</span>id], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Create a new list.
    </span><span class="kw">pub fn </span>create_list(<span class="kw-2">&amp;</span><span class="self">self</span>, new_val: MailingList) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;MailingList&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT INTO list(name, id, address, description, archive_url, topics) VALUES(?, ?, \
             ?, ?, ?, ?) RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[
                <span class="kw-2">&amp;</span>new_val.name,
                <span class="kw-2">&amp;</span>new_val.id,
                <span class="kw-2">&amp;</span>new_val.address,
                new_val.description.as_ref(),
                new_val.archive_url.as_ref(),
                <span class="macro">serde_json::json!</span>(new_val.topics.as_slice()),
            ],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;create_list {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all posts of a mailing list.
    </span><span class="kw">pub fn </span>list_posts(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        _date_range: <span class="prelude-ty">Option</span>&lt;(String, String)&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;Post&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT *, strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) AS month_year \
             FROM post WHERE list = ? ORDER BY timestamp ASC;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>iter = stmt.query_map(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                Post {
                    pk,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    envelope_from: row.get(<span class="string">&quot;envelope_from&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    message_id: row.get(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                    message: row.get(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                    timestamp: row.get(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                    datetime: row.get(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
                    month_year: row.get(<span class="string">&quot;month_year&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>post <span class="kw">in </span>iter {
            <span class="kw">let </span>post = post<span class="question-mark">?</span>;
            ret.push(post);
        }

        <span class="macro">trace!</span>(<span class="string">&quot;list_posts {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch the owners of a mailing list.
    </span><span class="kw">pub fn </span>list_owners(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;ListOwner&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM owner WHERE list = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([<span class="kw-2">&amp;</span>pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                ListOwner {
                    pk,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Remove an owner of a mailing list.
    </span><span class="kw">pub fn </span>remove_list_owner(<span class="kw-2">&amp;</span><span class="self">self</span>, list_pk: i64, owner_pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="self">self</span>.connection
            .query_row(
                <span class="string">&quot;DELETE FROM owner WHERE list = ? AND pk = ? RETURNING *;&quot;</span>,
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>owner_pk],
                |<span class="kw">_</span>| <span class="prelude-val">Ok</span>(()),
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;list or list owner not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Add an owner of a mailing list.
    </span><span class="kw">pub fn </span>add_list_owner(<span class="kw-2">&amp;</span><span class="self">self</span>, list_owner: ListOwner) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListOwner&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT OR REPLACE INTO owner(list, address, name) VALUES (?, ?, ?) RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>list_pk = list_owner.list;
        <span class="kw">let </span>ret = stmt
            .query_row(
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>list_owner.address, <span class="kw-2">&amp;</span>list_owner.name,],
                |row| {
                    <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                    <span class="prelude-val">Ok</span>(DbVal(
                        ListOwner {
                            pk,
                            list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                            address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                            name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        },
                        pk,
                    ))
                },
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(
                    err,
                    rusqlite::Error::SqliteFailure(
                        rusqlite::ffi::Error {
                            code: rusqlite::ffi::ErrorCode::ConstraintViolation,
                            extended_code: <span class="number">787
                        </span>},
                        <span class="kw">_
                    </span>)
                ) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;Could not find a list with this pk.&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;add_list_owner {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Update a mailing list.
    </span><span class="kw">pub fn </span>update_list(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: MailingListChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            MailingListChangeset {
                pk: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                id: <span class="prelude-val">None</span>,
                address: <span class="prelude-val">None</span>,
                description: <span class="prelude-val">None</span>,
                archive_url: <span class="prelude-val">None</span>,
                owner_local_part: <span class="prelude-val">None</span>,
                request_local_part: <span class="prelude-val">None</span>,
                verify: <span class="prelude-val">None</span>,
                hidden: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="self">self</span>.list(change_set.pk).map(|<span class="kw">_</span>| ());
        }

        <span class="kw">let </span>MailingListChangeset {
            pk,
            name,
            id,
            address,
            description,
            archive_url,
            owner_local_part,
            request_local_part,
            verify,
            hidden,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_list)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(<span class="string">&quot;UPDATE list SET &quot;</span>, <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>), <span class="string">&quot; = ? WHERE pk = ?;&quot;</span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(id);
        <span class="macro">update!</span>(address);
        <span class="macro">update!</span>(description);
        <span class="macro">update!</span>(archive_url);
        <span class="macro">update!</span>(owner_local_part);
        <span class="macro">update!</span>(request_local_part);
        <span class="macro">update!</span>(verify);
        <span class="macro">update!</span>(hidden);
        <span class="macro">update!</span>(enabled);

        tx.<span class="highlight">commit</span>()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[44,44],&quot;../../../src/mailpot/queue.rs.html#283&quot;,&quot;line 283&quot;]]"><div class="scraped-example-title">core/src/queue.rs (<a href="../../../src/mailpot/queue.rs.html#283">line 283</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>delete_from_queue(<span class="kw-2">&amp;</span><span class="self">self</span>, queue: Queue, index: Vec&lt;i64&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;QueueEntry&gt;&gt; {
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(delete_from_queue)))<span class="question-mark">?</span>;

        <span class="kw">let </span>cl = |row: <span class="kw-2">&amp;</span>rusqlite::Row&lt;<span class="lifetime">&#39;_</span>&gt;| {
            <span class="prelude-val">Ok</span>(QueueEntry {
                pk: -<span class="number">1</span>,
                queue,
                list: row.get::&lt;<span class="kw">_</span>, <span class="prelude-ty">Option</span>&lt;i64&gt;&gt;(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                comment: row.get::&lt;<span class="kw">_</span>, <span class="prelude-ty">Option</span>&lt;String&gt;&gt;(<span class="string">&quot;comment&quot;</span>)<span class="question-mark">?</span>,
                to_addresses: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;to_addresses&quot;</span>)<span class="question-mark">?</span>,
                from_address: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;from_address&quot;</span>)<span class="question-mark">?</span>,
                subject: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;subject&quot;</span>)<span class="question-mark">?</span>,
                message_id: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                message: row.get::&lt;<span class="kw">_</span>, Vec&lt;u8&gt;&gt;(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                timestamp: row.get::&lt;<span class="kw">_</span>, u64&gt;(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                datetime: row.get::&lt;<span class="kw">_</span>, DateTime&gt;(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
            })
        };
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="kw">if </span>index.is_empty() {
            tx.connection
                .prepare(<span class="string">&quot;DELETE FROM queue WHERE which = ? RETURNING *;&quot;</span>)<span class="question-mark">?
        </span>} <span class="kw">else </span>{
            tx.connection
                .prepare(<span class="string">&quot;DELETE FROM queue WHERE which = ? AND pk IN rarray(?) RETURNING *;&quot;</span>)<span class="question-mark">?
        </span>};
        <span class="kw">let </span>iter = <span class="kw">if </span>index.is_empty() {
            stmt.query_map([<span class="kw-2">&amp;</span>queue.as_str()], cl)<span class="question-mark">?
        </span>} <span class="kw">else </span>{
            <span class="comment">// Note: A `Rc&lt;Vec&lt;Value&gt;&gt;` must be used as the parameter.
            </span><span class="kw">let </span>index = std::rc::Rc::new(
                index
                    .into_iter()
                    .map(rusqlite::types::Value::from)
                    .collect::&lt;Vec&lt;rusqlite::types::Value&gt;&gt;(),
            );
            stmt.query_map(<span class="macro">rusqlite::params!</span>[queue.as_str(), index], cl)<span class="question-mark">?
        </span>};

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>item <span class="kw">in </span>iter {
            <span class="kw">let </span>item = item<span class="question-mark">?</span>;
            ret.push(item);
        }
        drop(stmt);
        tx.<span class="highlight focus">commit</span>()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div><div class="scraped-example " data-locs="[[[62,62],&quot;../../../src/mailpot/subscriptions.rs.html#376&quot;,&quot;line 376&quot;],[[282,282],&quot;../../../src/mailpot/subscriptions.rs.html#596&quot;,&quot;line 596&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#376">line 376</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>update_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: ListSubscriptionChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>pk = <span class="self">self
            </span>.list_subscription_by_address(change_set.list, <span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">?
            </span>.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            ListSubscriptionChangeset {
                list: <span class="kw">_</span>,
                address: <span class="kw">_</span>,
                account: <span class="prelude-val">None</span>,
                name: <span class="prelude-val">None</span>,
                digest: <span class="prelude-val">None</span>,
                verified: <span class="prelude-val">None</span>,
                hide_address: <span class="prelude-val">None</span>,
                receive_duplicates: <span class="prelude-val">None</span>,
                receive_own_posts: <span class="prelude-val">None</span>,
                receive_confirmation: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>ListSubscriptionChangeset {
            list,
            address: <span class="kw">_</span>,
            name,
            account,
            digest,
            enabled,
            verified,
            hide_address,
            receive_duplicates,
            receive_own_posts,
            receive_confirmation,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_subscription)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE subscription SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE list = ? AND pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>list, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(account);
        <span class="macro">update!</span>(digest);
        <span class="macro">update!</span>(enabled);
        <span class="macro">update!</span>(verified);
        <span class="macro">update!</span>(hide_address);
        <span class="macro">update!</span>(receive_duplicates);
        <span class="macro">update!</span>(receive_own_posts);
        <span class="macro">update!</span>(receive_confirmation);

        tx.<span class="highlight focus">commit</span>()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Fetch account by pk.
    </span><span class="kw">pub fn </span>account(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>_pk: i64 = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="macro">debug_assert_eq!</span>(pk, _pk);
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch account by address.
    </span><span class="kw">pub fn </span>account_by_address(<span class="kw-2">&amp;</span><span class="self">self</span>, address: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account WHERE address = ?;&quot;</span>)<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>address], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all subscriptions of an account by primary key.
    </span><span class="kw">pub fn </span>account_subscriptions(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;ListSubscription&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM subscription WHERE account = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([<span class="kw-2">&amp;</span>pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                ListSubscription {
                    pk: row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    account: row.get(<span class="string">&quot;account&quot;</span>)<span class="question-mark">?</span>,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    digest: row.get(<span class="string">&quot;digest&quot;</span>)<span class="question-mark">?</span>,
                    enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    verified: row.get(<span class="string">&quot;verified&quot;</span>)<span class="question-mark">?</span>,
                    hide_address: row.get(<span class="string">&quot;hide_address&quot;</span>)<span class="question-mark">?</span>,
                    receive_duplicates: row.get(<span class="string">&quot;receive_duplicates&quot;</span>)<span class="question-mark">?</span>,
                    receive_own_posts: row.get(<span class="string">&quot;receive_own_posts&quot;</span>)<span class="question-mark">?</span>,
                    receive_confirmation: row.get(<span class="string">&quot;receive_confirmation&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all accounts.
    </span><span class="kw">pub fn </span>accounts(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account ORDER BY pk ASC;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                Account {
                    pk,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                    password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                    enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Add account.
    </span><span class="kw">pub fn </span>add_account(<span class="kw-2">&amp;</span><span class="self">self</span>, new_val: Account) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;Account&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(
                <span class="string">&quot;INSERT INTO account(name, address, public_key, password, enabled) VALUES(?, ?, \
                 ?, ?, ?) RETURNING *;&quot;</span>,
            )
            .unwrap();
        <span class="kw">let </span>ret = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[
                <span class="kw-2">&amp;</span>new_val.name,
                <span class="kw-2">&amp;</span>new_val.address,
                <span class="kw-2">&amp;</span>new_val.public_key,
                <span class="kw-2">&amp;</span>new_val.password,
                <span class="kw-2">&amp;</span>new_val.enabled,
            ],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;add_account {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Remove an account by their address.
    </span><span class="kw">pub fn </span>remove_account(<span class="kw-2">&amp;</span><span class="self">self</span>, address: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="self">self</span>.connection
            .query_row(
                <span class="string">&quot;DELETE FROM account WHERE address = ? RETURNING *;&quot;</span>,
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>address],
                |<span class="kw">_</span>| <span class="prelude-val">Ok</span>(()),
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;account not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Update an account.
    </span><span class="kw">pub fn </span>update_account(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: AccountChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span><span class="prelude-val">Some</span>(acc) = <span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">? </span><span class="kw">else </span>{
            <span class="kw">return </span><span class="prelude-val">Err</span>(NotFound(<span class="string">&quot;account with this address not found!&quot;</span>).into());
        };
        <span class="kw">let </span>pk = acc.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            AccountChangeset {
                address: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                public_key: <span class="prelude-val">None</span>,
                password: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>AccountChangeset {
            address: <span class="kw">_</span>,
            name,
            public_key,
            password,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_account)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE account SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(public_key);
        <span class="macro">update!</span>(password);
        <span class="macro">update!</span>(enabled);

        tx.<span class="highlight">commit</span>()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.commit_" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#910-925">source</a><h4 class="code-header">fn <a href="#method.commit_" class="fn">commit_</a>(&amp;mut self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-1"><a href="#scraped-examples-1">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/connection.rs.html#907&quot;,&quot;line 907&quot;],[[66,66],&quot;../../../src/mailpot/connection.rs.html#972&quot;,&quot;line 972&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#907">line 907</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
<span>960</span>
<span>961</span>
<span>962</span>
<span>963</span>
<span>964</span>
<span>965</span>
<span>966</span>
<span>967</span>
<span>968</span>
<span>969</span>
<span>970</span>
<span>971</span>
<span>972</span>
<span>973</span>
<span>974</span>
<span>975</span>
<span>976</span>
<span>977</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>        <span class="kw">pub fn </span>commit(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.<span class="highlight focus">commit_</span>()
        }

        <span class="kw">fn </span>commit_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span>!<span class="self">self</span>.committed {
                <span class="kw">match </span><span class="self">self</span>.name {
                    <span class="prelude-val">Ok</span>(<span class="kw-2">ref </span>n) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;RELEASE SAVEPOINT {n}&quot;</span>))<span class="question-mark">?</span>,
                    <span class="prelude-val">Err</span>(<span class="kw-2">ref </span>i) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;RELEASE SAVEPOINT _{i}&quot;</span>))<span class="question-mark">?</span>,
                };
                <span class="self">self</span>.committed = <span class="bool-val">true</span>;
            }
            <span class="prelude-val">Ok</span>(())
        }

        <span class="doccomment">/// Configure the savepoint to perform the specified action when it is
        /// dropped.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>set_drop_behavior(<span class="kw-2">&amp;mut </span><span class="self">self</span>, drop_behavior: DropBehavior) {
            <span class="self">self</span>.drop_behavior = drop_behavior;
        }

        <span class="doccomment">/// A convenience method which consumes and rolls back a savepoint.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>rollback(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.rollback_()
        }

        <span class="kw">fn </span>rollback_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span>!<span class="self">self</span>.committed {
                <span class="kw">match </span><span class="self">self</span>.name {
                    <span class="prelude-val">Ok</span>(<span class="kw-2">ref </span>n) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT {n}&quot;</span>))<span class="question-mark">?</span>,
                    <span class="prelude-val">Err</span>(<span class="kw-2">ref </span>i) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT _{i}&quot;</span>))<span class="question-mark">?</span>,
                };
            }
            <span class="prelude-val">Ok</span>(())
        }

        <span class="doccomment">/// Consumes the savepoint, committing or rolling back according to
        /// the current setting (see `drop_behavior`).
        ///
        /// Functionally equivalent to the `Drop` implementation, but allows
        /// callers to see any errors that occur.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>finish(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.finish_()
        }

        <span class="attr">#[inline]
        </span><span class="kw">fn </span>finish_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span><span class="self">self</span>.conn.connection.is_autocommit() {
                <span class="kw">return </span><span class="prelude-val">Ok</span>(());
            }
            <span class="kw">match </span><span class="self">self</span>.drop_behavior {
                DropBehavior::Commit =&gt; <span class="self">self</span>.<span class="highlight">commit_</span>().or_else(|<span class="kw">_</span>| <span class="self">self</span>.rollback_()),
                DropBehavior::Rollback =&gt; <span class="self">self</span>.rollback_(),
                DropBehavior::Ignore =&gt; <span class="prelude-val">Ok</span>(()),
                DropBehavior::Panic =&gt; <span class="macro">panic!</span>(<span class="string">&quot;Savepoint dropped unexpectedly.&quot;</span>),
            }
        }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.set_drop_behavior" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#930-932">source</a><h4 class="code-header">pub fn <a href="#method.set_drop_behavior" class="fn">set_drop_behavior</a>(&amp;mut self, drop_behavior: <a class="enum" href="enum.DropBehavior.html" title="enum mailpot::connection::transaction::DropBehavior">DropBehavior</a>)</h4></section></summary><div class="docblock"><p>Configure the savepoint to perform the specified action when it is
dropped.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.rollback" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#936-938">source</a><h4 class="code-header">pub fn <a href="#method.rollback" class="fn">rollback</a>(self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>A convenience method which consumes and rolls back a savepoint.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.rollback_" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#940-954">source</a><h4 class="code-header">fn <a href="#method.rollback_" class="fn">rollback_</a>(&amp;mut self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-2"><a href="#scraped-examples-2">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/connection.rs.html#937&quot;,&quot;line 937&quot;],[[36,36],&quot;../../../src/mailpot/connection.rs.html#972&quot;,&quot;line 972&quot;],[[37,37],&quot;../../../src/mailpot/connection.rs.html#973&quot;,&quot;line 973&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#937">line 937</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
<span>960</span>
<span>961</span>
<span>962</span>
<span>963</span>
<span>964</span>
<span>965</span>
<span>966</span>
<span>967</span>
<span>968</span>
<span>969</span>
<span>970</span>
<span>971</span>
<span>972</span>
<span>973</span>
<span>974</span>
<span>975</span>
<span>976</span>
<span>977</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>        <span class="kw">pub fn </span>rollback(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.<span class="highlight focus">rollback_</span>()
        }

        <span class="kw">fn </span>rollback_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span>!<span class="self">self</span>.committed {
                <span class="kw">match </span><span class="self">self</span>.name {
                    <span class="prelude-val">Ok</span>(<span class="kw-2">ref </span>n) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT {n}&quot;</span>))<span class="question-mark">?</span>,
                    <span class="prelude-val">Err</span>(<span class="kw-2">ref </span>i) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT _{i}&quot;</span>))<span class="question-mark">?</span>,
                };
            }
            <span class="prelude-val">Ok</span>(())
        }

        <span class="doccomment">/// Consumes the savepoint, committing or rolling back according to
        /// the current setting (see `drop_behavior`).
        ///
        /// Functionally equivalent to the `Drop` implementation, but allows
        /// callers to see any errors that occur.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>finish(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.finish_()
        }

        <span class="attr">#[inline]
        </span><span class="kw">fn </span>finish_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span><span class="self">self</span>.conn.connection.is_autocommit() {
                <span class="kw">return </span><span class="prelude-val">Ok</span>(());
            }
            <span class="kw">match </span><span class="self">self</span>.drop_behavior {
                DropBehavior::Commit =&gt; <span class="self">self</span>.commit_().or_else(|<span class="kw">_</span>| <span class="self">self</span>.<span class="highlight">rollback_</span>()),
                DropBehavior::Rollback =&gt; <span class="self">self</span>.<span class="highlight">rollback_</span>(),
                DropBehavior::Ignore =&gt; <span class="prelude-val">Ok</span>(()),
                DropBehavior::Panic =&gt; <span class="macro">panic!</span>(<span class="string">&quot;Savepoint dropped unexpectedly.&quot;</span>),
            }
        }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.finish" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#962-964">source</a><h4 class="code-header">pub fn <a href="#method.finish" class="fn">finish</a>(self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Consumes the savepoint, committing or rolling back according to
the current setting (see <code>drop_behavior</code>).</p>
<p>Functionally equivalent to the <code>Drop</code> implementation, but allows
callers to see any errors that occur.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.finish_" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#967-977">source</a><h4 class="code-header">fn <a href="#method.finish_" class="fn">finish_</a>(&amp;mut self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-3"><a href="#scraped-examples-3">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/connection.rs.html#900&quot;,&quot;line 900&quot;],[[64,64],&quot;../../../src/mailpot/connection.rs.html#963&quot;,&quot;line 963&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#900">line 900</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
<span>960</span>
<span>961</span>
<span>962</span>
<span>963</span>
<span>964</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>        <span class="kw">fn </span>drop(<span class="kw-2">&amp;mut </span><span class="self">self</span>) {
            <span class="kw">_ </span>= <span class="self">self</span>.<span class="highlight focus">finish_</span>();
        }
    }

    <span class="kw">impl </span>Savepoint&lt;<span class="lifetime">&#39;_</span>&gt; {
        <span class="doccomment">/// Commit and consume savepoint.
        </span><span class="kw">pub fn </span>commit(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.commit_()
        }

        <span class="kw">fn </span>commit_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span>!<span class="self">self</span>.committed {
                <span class="kw">match </span><span class="self">self</span>.name {
                    <span class="prelude-val">Ok</span>(<span class="kw-2">ref </span>n) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;RELEASE SAVEPOINT {n}&quot;</span>))<span class="question-mark">?</span>,
                    <span class="prelude-val">Err</span>(<span class="kw-2">ref </span>i) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;RELEASE SAVEPOINT _{i}&quot;</span>))<span class="question-mark">?</span>,
                };
                <span class="self">self</span>.committed = <span class="bool-val">true</span>;
            }
            <span class="prelude-val">Ok</span>(())
        }

        <span class="doccomment">/// Configure the savepoint to perform the specified action when it is
        /// dropped.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>set_drop_behavior(<span class="kw-2">&amp;mut </span><span class="self">self</span>, drop_behavior: DropBehavior) {
            <span class="self">self</span>.drop_behavior = drop_behavior;
        }

        <span class="doccomment">/// A convenience method which consumes and rolls back a savepoint.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>rollback(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.rollback_()
        }

        <span class="kw">fn </span>rollback_(<span class="kw-2">&amp;mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="kw">if </span>!<span class="self">self</span>.committed {
                <span class="kw">match </span><span class="self">self</span>.name {
                    <span class="prelude-val">Ok</span>(<span class="kw-2">ref </span>n) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT {n}&quot;</span>))<span class="question-mark">?</span>,
                    <span class="prelude-val">Err</span>(<span class="kw-2">ref </span>i) =&gt; <span class="self">self
                        </span>.conn
                        .connection
                        .execute_batch(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;ROLLBACK TO SAVEPOINT _{i}&quot;</span>))<span class="question-mark">?</span>,
                };
            }
            <span class="prelude-val">Ok</span>(())
        }

        <span class="doccomment">/// Consumes the savepoint, committing or rolling back according to
        /// the current setting (see `drop_behavior`).
        ///
        /// Functionally equivalent to the `Drop` implementation, but allows
        /// callers to see any errors that occur.
        </span><span class="attr">#[inline]
        </span><span class="kw">pub fn </span>finish(<span class="kw-2">mut </span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
            <span class="self">self</span>.<span class="highlight">finish_</span>()
        }</code></pre></div></div></div></div></details></div></details></div><h2 id="deref-methods-Connection" class="small-section-header"><span>Methods from <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/deref/trait.Deref.html" title="trait core::ops::deref::Deref">Deref</a>&lt;Target = <a class="struct" href="../struct.Connection.html" title="struct mailpot::connection::Connection">Connection</a>&gt;</span><a href="#deref-methods-Connection" class="anchor">§</a></h2><div id="deref-methods-Connection-1" class="impl-items"><section id="associatedconstant.SCHEMA" class="associatedconstant"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#131">source</a><h4 class="code-header">pub const <a href="#associatedconstant.SCHEMA" class="constant">SCHEMA</a>: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a> = _</h4></section><section id="associatedconstant.MIGRATIONS" class="associatedconstant"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#134-135">source</a><h4 class="code-header">pub const <a href="#associatedconstant.MIGRATIONS" class="constant">MIGRATIONS</a>: &amp;'static [(<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u32.html">u32</a>, &amp;'static <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>, &amp;'static <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>)] = _</h4></section><details class="toggle method-toggle" open><summary><section id="method.schema_version" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#261-269">source</a><h4 class="code-header">pub fn <a href="#method.schema_version" class="fn">schema_version</a>(&amp;self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u32.html">u32</a>&gt;</h4></section></summary><div class="docblock"><p>The version of the current schema.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-4"><a href="#scraped-examples-4">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[69,69],&quot;../../../src/mailpot/connection.rs.html#246&quot;,&quot;line 246&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#246">line 246</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>open_db(conf: Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>&gt; {
        <span class="kw">use </span>std::sync::Once;

        <span class="kw">use </span>rusqlite::config::DbConfig;

        <span class="kw">static </span>INIT_SQLITE_LOGGING: Once = Once::new();

        <span class="kw">if </span>!conf.db_path.exists() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Database doesn&#39;t exist&quot;</span>.into());
        }
        INIT_SQLITE_LOGGING.call_once(|| {
            <span class="kw">_ </span>= <span class="kw">unsafe </span>{ rusqlite::trace::config_log(<span class="prelude-val">Some</span>(log_callback)) };
        });
        <span class="kw">let </span>conn = DbConnection::open(conf.db_path.to_str().unwrap())<span class="question-mark">?</span>;
        rusqlite::vtab::array::load_module(<span class="kw-2">&amp;</span>conn)<span class="question-mark">?</span>;
        conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;journal_mode&quot;</span>, <span class="string">&quot;WAL&quot;</span>)<span class="question-mark">?</span>;
        conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;foreign_keys&quot;</span>, <span class="string">&quot;on&quot;</span>)<span class="question-mark">?</span>;
        <span class="comment">// synchronise less often to the filesystem
        </span>conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;synchronous&quot;</span>, <span class="string">&quot;normal&quot;</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_ENABLE_FKEY, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_ENABLE_TRIGGER, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_DEFENSIVE, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_TRUSTED_SCHEMA, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.busy_timeout(core::time::Duration::from_millis(<span class="number">500</span>))<span class="question-mark">?</span>;
        conn.busy_handler(<span class="prelude-val">Some</span>(|times: i32| -&gt; bool { times &lt; <span class="number">5 </span>}))<span class="question-mark">?</span>;
        conn.create_scalar_function(
            <span class="string">&quot;validate_json_schema&quot;</span>,
            <span class="number">2</span>,
            FunctionFlags::SQLITE_INNOCUOUS
                | FunctionFlags::SQLITE_UTF8
                | FunctionFlags::SQLITE_DETERMINISTIC,
            |ctx| {
                <span class="kw">if </span><span class="macro">log::log_enabled!</span>(log::Level::Trace) {
                    rusqlite::trace::log(
                        rusqlite::ffi::SQLITE_NOTICE,
                        <span class="string">&quot;validate_json_schema RUNNING&quot;</span>,
                    );
                }
                <span class="kw">let </span>map_err = rusqlite::Error::UserFunctionError;
                <span class="kw">let </span>schema = ctx.get::&lt;String&gt;(<span class="number">0</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>value = ctx.get::&lt;String&gt;(<span class="number">1</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>schema_val: serde_json::Value = serde_json::from_str(<span class="kw-2">&amp;</span>schema)
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>value: serde_json::Value = serde_json::from_str(<span class="kw-2">&amp;</span>value)
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>compiled = JSONSchema::compile(<span class="kw-2">&amp;</span>schema_val)
                    .map_err(|err| err.to_string())
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>x = <span class="kw">if let </span><span class="prelude-val">Err</span>(errors) = compiled.validate(<span class="kw-2">&amp;</span>value) {
                    <span class="kw">for </span>err <span class="kw">in </span>errors {
                        rusqlite::trace::log(rusqlite::ffi::SQLITE_WARNING, <span class="kw-2">&amp;</span>err.to_string());
                        drop(err);
                    }
                    <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>)
                } <span class="kw">else </span>{
                    <span class="prelude-val">Ok</span>(<span class="bool-val">true</span>)
                };
                x
            },
        )<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = <span class="self">Self </span>{
            conf,
            connection: conn,
        };
        <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(latest, <span class="kw">_</span>, <span class="kw">_</span>)) = <span class="self">Self</span>::MIGRATIONS.last() {
            <span class="kw">let </span>version = ret.<span class="highlight focus">schema_version</span>()<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(
                <span class="string">&quot;SQLITE user_version PRAGMA returned {version}. Most recent migration is {latest}.&quot;
            </span>);
            <span class="kw">if </span>version &lt; latest {
                <span class="macro">info!</span>(<span class="string">&quot;Updating database schema from version {version} to {latest}...&quot;</span>);
            }
            ret.migrate(version, latest)<span class="question-mark">?</span>;
        }

        ret.connection.authorizer(<span class="prelude-val">Some</span>(user_authorizer_callback));
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.migrate" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#274-305">source</a><h4 class="code-header">pub fn <a href="#method.migrate" class="fn">migrate</a>(&amp;self, from: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u32.html">u32</a>, to: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u32.html">u32</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Migrate from version <code>from</code> to <code>to</code>.</p>
<p>See <a href="../struct.Connection.html#associatedconstant.MIGRATIONS" title="associated constant mailpot::connection::Connection::MIGRATIONS">Self::MIGRATIONS</a>.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-5"><a href="#scraped-examples-5">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[76,76],&quot;../../../src/mailpot/connection.rs.html#253&quot;,&quot;line 253&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#253">line 253</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>open_db(conf: Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>&gt; {
        <span class="kw">use </span>std::sync::Once;

        <span class="kw">use </span>rusqlite::config::DbConfig;

        <span class="kw">static </span>INIT_SQLITE_LOGGING: Once = Once::new();

        <span class="kw">if </span>!conf.db_path.exists() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Database doesn&#39;t exist&quot;</span>.into());
        }
        INIT_SQLITE_LOGGING.call_once(|| {
            <span class="kw">_ </span>= <span class="kw">unsafe </span>{ rusqlite::trace::config_log(<span class="prelude-val">Some</span>(log_callback)) };
        });
        <span class="kw">let </span>conn = DbConnection::open(conf.db_path.to_str().unwrap())<span class="question-mark">?</span>;
        rusqlite::vtab::array::load_module(<span class="kw-2">&amp;</span>conn)<span class="question-mark">?</span>;
        conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;journal_mode&quot;</span>, <span class="string">&quot;WAL&quot;</span>)<span class="question-mark">?</span>;
        conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;foreign_keys&quot;</span>, <span class="string">&quot;on&quot;</span>)<span class="question-mark">?</span>;
        <span class="comment">// synchronise less often to the filesystem
        </span>conn.pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;synchronous&quot;</span>, <span class="string">&quot;normal&quot;</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_ENABLE_FKEY, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_ENABLE_TRIGGER, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_DEFENSIVE, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.set_db_config(DbConfig::SQLITE_DBCONFIG_TRUSTED_SCHEMA, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
        conn.busy_timeout(core::time::Duration::from_millis(<span class="number">500</span>))<span class="question-mark">?</span>;
        conn.busy_handler(<span class="prelude-val">Some</span>(|times: i32| -&gt; bool { times &lt; <span class="number">5 </span>}))<span class="question-mark">?</span>;
        conn.create_scalar_function(
            <span class="string">&quot;validate_json_schema&quot;</span>,
            <span class="number">2</span>,
            FunctionFlags::SQLITE_INNOCUOUS
                | FunctionFlags::SQLITE_UTF8
                | FunctionFlags::SQLITE_DETERMINISTIC,
            |ctx| {
                <span class="kw">if </span><span class="macro">log::log_enabled!</span>(log::Level::Trace) {
                    rusqlite::trace::log(
                        rusqlite::ffi::SQLITE_NOTICE,
                        <span class="string">&quot;validate_json_schema RUNNING&quot;</span>,
                    );
                }
                <span class="kw">let </span>map_err = rusqlite::Error::UserFunctionError;
                <span class="kw">let </span>schema = ctx.get::&lt;String&gt;(<span class="number">0</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>value = ctx.get::&lt;String&gt;(<span class="number">1</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>schema_val: serde_json::Value = serde_json::from_str(<span class="kw-2">&amp;</span>schema)
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>value: serde_json::Value = serde_json::from_str(<span class="kw-2">&amp;</span>value)
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>compiled = JSONSchema::compile(<span class="kw-2">&amp;</span>schema_val)
                    .map_err(|err| err.to_string())
                    .map_err(Into::into)
                    .map_err(map_err)<span class="question-mark">?</span>;
                <span class="kw">let </span>x = <span class="kw">if let </span><span class="prelude-val">Err</span>(errors) = compiled.validate(<span class="kw-2">&amp;</span>value) {
                    <span class="kw">for </span>err <span class="kw">in </span>errors {
                        rusqlite::trace::log(rusqlite::ffi::SQLITE_WARNING, <span class="kw-2">&amp;</span>err.to_string());
                        drop(err);
                    }
                    <span class="prelude-val">Ok</span>(<span class="bool-val">false</span>)
                } <span class="kw">else </span>{
                    <span class="prelude-val">Ok</span>(<span class="bool-val">true</span>)
                };
                x
            },
        )<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = <span class="self">Self </span>{
            conf,
            connection: conn,
        };
        <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span>(latest, <span class="kw">_</span>, <span class="kw">_</span>)) = <span class="self">Self</span>::MIGRATIONS.last() {
            <span class="kw">let </span>version = ret.schema_version()<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(
                <span class="string">&quot;SQLITE user_version PRAGMA returned {version}. Most recent migration is {latest}.&quot;
            </span>);
            <span class="kw">if </span>version &lt; latest {
                <span class="macro">info!</span>(<span class="string">&quot;Updating database schema from version {version} to {latest}...&quot;</span>);
            }
            ret.<span class="highlight focus">migrate</span>(version, latest)<span class="question-mark">?</span>;
        }

        ret.connection.authorizer(<span class="prelude-val">Some</span>(user_authorizer_callback));
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.conf" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#394-396">source</a><h4 class="code-header">pub fn <a href="#method.conf" class="fn">conf</a>(&amp;self) -&gt; &amp;<a class="struct" href="../../config/struct.Configuration.html" title="struct mailpot::config::Configuration">Configuration</a></h4></section></summary><div class="docblock"><p>Returns a connection’s configuration.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-6"><a href="#scraped-examples-6">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[472,472],&quot;../../../src/mpot/main.rs.html#533&quot;,&quot;line 533&quot;],[[501,501],&quot;../../../src/mpot/main.rs.html#562&quot;,&quot;line 562&quot;],[[724,724],&quot;../../../src/mpot/main.rs.html#785&quot;,&quot;line 785&quot;],[[725,725],&quot;../../../src/mpot/main.rs.html#786&quot;,&quot;line 786&quot;],[[755,755],&quot;../../../src/mpot/main.rs.html#816&quot;,&quot;line 816&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#533">line 533</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.<span class="highlight focus">conf</span>().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.<span class="highlight">conf</span>().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.<span class="highlight">conf</span>())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.<span class="highlight">conf</span>(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.<span class="highlight">conf</span>(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example expanded" data-locs="[[[1,1],&quot;../../../src/mailpot/submission.rs.html#34&quot;,&quot;line 34&quot;]]"><div class="scraped-example-title">core/src/submission.rs (<a href="../../../src/mailpot/submission.rs.html#34">line 34</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
</pre></div><pre class="rust"><code>    <span class="kw">pub fn </span>new_smtp_connection(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; ResultFuture&lt;SmtpConnection&gt; {
        <span class="kw">if let </span><span class="kw">crate</span>::SendMail::Smtp(<span class="kw-2">ref </span>smtp_conf) = <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="highlight focus">conf</span>().send_mail {
            <span class="kw">let </span>smtp_conf = smtp_conf.clone();
            <span class="prelude-val">Ok</span>(Box::pin(<span class="kw">async move </span>{
                <span class="prelude-val">Ok</span>(SmtpConnection::new_connection(smtp_conf).<span class="kw">await</span><span class="question-mark">?</span>)
            }))
        } <span class="kw">else </span>{
            <span class="prelude-val">Err</span>(<span class="string">&quot;No SMTP configuration found: use the shell command instead.&quot;</span>.into())
        }
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.load_archives" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#399-419">source</a><h4 class="code-header">pub fn <a href="#method.load_archives" class="fn">load_archives</a>(&amp;self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Loads archive databases from <a href="../../config/struct.Configuration.html#structfield.data_path" title="field mailpot::config::Configuration::data_path"><code>Configuration::data_path</code></a>, if any.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.lists" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#422-448">source</a><h4 class="code-header">pub fn <a href="#method.lists" class="fn">lists</a>(&amp;self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Returns a vector of existing mailing lists.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-7"><a href="#scraped-examples-7">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[6,6],&quot;../../../src/mpot_web/main.rs.html#190&quot;,&quot;line 190&quot;]]"><div class="scraped-example-title">web/src/main.rs (<a href="../../../src/mpot_web/main.rs.html#190">line 190</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">async fn </span>root(
    <span class="kw-2">mut </span>session: WritableSession,
    auth: AuthContext,
    State(state): State&lt;Arc&lt;AppState&gt;&gt;,
) -&gt; <span class="prelude-ty">Result</span>&lt;Html&lt;String&gt;, ResponseError&gt; {
    <span class="kw">let </span>db = Connection::open_db(state.conf.clone())<span class="question-mark">?</span>;
    <span class="kw">let </span>lists_values = db.<span class="highlight focus">lists</span>()<span class="question-mark">?</span>;
    <span class="kw">let </span>lists = lists_values
        .iter()
        .map(|list| {
            <span class="kw">let </span>months = db.months(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>posts = db.list_posts(list.pk, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>newest = posts.last().and_then(|p| {
                chrono::Utc
                    .timestamp_opt(p.timestamp <span class="kw">as </span>i64, <span class="number">0</span>)
                    .earliest()
                    .map(|d| d.to_string())
            });
            <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>list_obj = MailingList::from(list.clone());
            list_obj.set_safety(list_owners.as_slice(), <span class="kw-2">&amp;</span>state.conf.administrators);
            <span class="prelude-val">Ok</span>(<span class="macro">minijinja::context! </span>{
                newest,
                posts =&gt; <span class="kw-2">&amp;</span>posts,
                months =&gt; <span class="kw-2">&amp;</span>months,
                list =&gt; Value::from_object(list_obj),
            })
        })
        .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;<span class="kw">_</span>&gt;, mailpot::Error&gt;&gt;()<span class="question-mark">?</span>;
    <span class="kw">let </span>crumbs = <span class="macro">vec!</span>[Crumb {
        label: <span class="string">&quot;Home&quot;</span>.into(),
        url: <span class="string">&quot;/&quot;</span>.into(),
    }];

    <span class="kw">let </span>context = <span class="macro">minijinja::context! </span>{
        page_title =&gt; <span class="prelude-ty">Option</span>::&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str&gt;::None,
        lists =&gt; <span class="kw-2">&amp;</span>lists,
        current_user =&gt; auth.current_user,
        messages =&gt; session.drain_messages(),
        crumbs =&gt; crumbs,
    };
    <span class="prelude-val">Ok</span>(Html(TEMPLATES.get_template(<span class="string">&quot;lists.html&quot;</span>)<span class="question-mark">?</span>.render(context)<span class="question-mark">?</span>))
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[45,45],&quot;../../../src/mpot/main.rs.html#106&quot;,&quot;line 106&quot;],[[53,53],&quot;../../../src/mpot/main.rs.html#114&quot;,&quot;line 114&quot;],[[746,746],&quot;../../../src/mpot/main.rs.html#807&quot;,&quot;line 807&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#106">line 106</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.<span class="highlight focus">lists</span>()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.<span class="highlight">lists</span>()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.<span class="highlight">lists</span>()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><div class="scraped-example " data-locs="[[[5,5],&quot;../../../src/mailpot/postfix.rs.html#286&quot;,&quot;line 286&quot;]]"><div class="scraped-example-title">core/src/postfix.rs (<a href="../../../src/mailpot/postfix.rs.html#286">line 286</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>save_maps(<span class="kw-2">&amp;</span><span class="self">self</span>, config: <span class="kw-2">&amp;</span>Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>db = Connection::open_db(config.clone())<span class="question-mark">?</span>;
        <span class="kw">let </span><span class="prelude-val">Some</span>(postmap) = find_binary_in_path(<span class="string">&quot;postmap&quot;</span>) <span class="kw">else </span>{
            <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(<span class="string">&quot;Could not find postmap binary in PATH.&quot;</span>))));
        };
        <span class="kw">let </span>lists = db.<span class="highlight focus">lists</span>()<span class="question-mark">?</span>;
        <span class="kw">let </span>lists_post_policies = lists
            .into_iter()
            .map(|l| {
                <span class="kw">let </span>pk = l.pk;
                <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
            })
            .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
        <span class="kw">let </span>content = <span class="self">self</span>.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
        <span class="kw">let </span>path = <span class="self">self
            </span>.map_output_path
            .as_deref()
            .unwrap_or(<span class="kw-2">&amp;</span>config.data_path)
            .join(<span class="string">&quot;mailpot_postfix_map&quot;</span>);
        <span class="kw">let </span><span class="kw-2">mut </span>file = BufWriter::new(
            OpenOptions::new()
                .read(<span class="bool-val">true</span>)
                .write(<span class="bool-val">true</span>)
                .create(<span class="bool-val">true</span>)
                .truncate(<span class="bool-val">true</span>)
                .open(<span class="kw-2">&amp;</span>path)
                .context(<span class="macro">format!</span>(<span class="string">&quot;Could not open {}&quot;</span>, path.display()))<span class="question-mark">?</span>,
        );
        file.write_all(content.as_bytes())
            .context(<span class="macro">format!</span>(<span class="string">&quot;Could not write to {}&quot;</span>, path.display()))<span class="question-mark">?</span>;
        file.flush()
            .context(<span class="macro">format!</span>(<span class="string">&quot;Could not write to {}&quot;</span>, path.display()))<span class="question-mark">?</span>;

        <span class="kw">let </span>output = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
            .arg(<span class="string">&quot;-c&quot;</span>)
            .arg(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;{} {}&quot;</span>, postmap.display(), path.display()))
            .output()
            .with_context(|| {
                <span class="macro">format!</span>(
                    <span class="string">&quot;Could not execute `postmap` binary in path {}&quot;</span>,
                    postmap.display()
                )
            })<span class="question-mark">?</span>;
        <span class="kw">if </span>!output.status.success() {
            <span class="kw">use </span>std::os::unix::process::ExitStatusExt;
            <span class="kw">if let </span><span class="prelude-val">Some</span>(code) = output.status.code() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} exited with {}.\nstderr was:\n---{}---\nstdout was\n---{}---\n&quot;</span>,
                        code,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            } <span class="kw">else if let </span><span class="prelude-val">Some</span>(signum) = output.status.signal() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} was killed with signal {}.\nstderr was:\n---{}---\nstdout \
                         was\n---{}---\n&quot;</span>,
                        signum,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            } <span class="kw">else </span>{
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} failed for unknown reason.\nstderr was:\n---{}---\nstdout \
                         was\n---{}---\n&quot;</span>,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><div class="scraped-example " data-locs="[[[9,9],&quot;../../../src/mailpot/posts.rs.html#131&quot;,&quot;line 131&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#131">line 131</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.<span class="highlight focus">lists</span>()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.list" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#451-475">source</a><h4 class="code-header">pub fn <a href="#method.list" class="fn">list</a>(&amp;self, pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch a mailing list by primary key.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-8"><a href="#scraped-examples-8">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[777,777],&quot;../../../src/mpot/main.rs.html#838&quot;,&quot;line 838&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#838">line 838</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .<span class="highlight focus">list</span>(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[17,17],&quot;../../../src/mailpot/connection.rs.html#686&quot;,&quot;line 686&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#686">line 686</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>update_list(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: MailingListChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            MailingListChangeset {
                pk: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                id: <span class="prelude-val">None</span>,
                address: <span class="prelude-val">None</span>,
                description: <span class="prelude-val">None</span>,
                archive_url: <span class="prelude-val">None</span>,
                owner_local_part: <span class="prelude-val">None</span>,
                request_local_part: <span class="prelude-val">None</span>,
                verify: <span class="prelude-val">None</span>,
                hidden: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="self">self</span>.<span class="highlight focus">list</span>(change_set.pk).map(|<span class="kw">_</span>| ());
        }

        <span class="kw">let </span>MailingListChangeset {
            pk,
            name,
            id,
            address,
            description,
            archive_url,
            owner_local_part,
            request_local_part,
            verify,
            hidden,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_list)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(<span class="string">&quot;UPDATE list SET &quot;</span>, <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>), <span class="string">&quot; = ? WHERE pk = ?;&quot;</span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(id);
        <span class="macro">update!</span>(address);
        <span class="macro">update!</span>(description);
        <span class="macro">update!</span>(archive_url);
        <span class="macro">update!</span>(owner_local_part);
        <span class="macro">update!</span>(request_local_part);
        <span class="macro">update!</span>(verify);
        <span class="macro">update!</span>(hidden);
        <span class="macro">update!</span>(enabled);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.list_by_id" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#478-504">source</a><h4 class="code-header">pub fn <a href="#method.list_by_id" class="fn">list_by_id</a>&lt;S: <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.AsRef.html" title="trait core::convert::AsRef">AsRef</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>&gt;&gt;(
    &amp;self,
    id: S
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch a mailing list by id.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.create_list" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#507-542">source</a><h4 class="code-header">pub fn <a href="#method.create_list" class="fn">create_list</a>(&amp;self, new_val: <a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Create a new list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-9"><a href="#scraped-examples-9">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[433,441],&quot;../../../src/mpot/main.rs.html#494-502&quot;,&quot;lines 494-502&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#494-502">lines 494-502</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.<span class="highlight focus">create_list</span>(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_posts" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#545-579">source</a><h4 class="code-header">pub fn <a href="#method.list_posts" class="fn">list_posts</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    _date_range: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;(<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>, <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>)&gt;
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Post.html" title="struct mailpot::models::Post">Post</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all posts of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-10"><a href="#scraped-examples-10">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[11,11],&quot;../../../src/mpot_web/main.rs.html#195&quot;,&quot;line 195&quot;]]"><div class="scraped-example-title">web/src/main.rs (<a href="../../../src/mpot_web/main.rs.html#195">line 195</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">async fn </span>root(
    <span class="kw-2">mut </span>session: WritableSession,
    auth: AuthContext,
    State(state): State&lt;Arc&lt;AppState&gt;&gt;,
) -&gt; <span class="prelude-ty">Result</span>&lt;Html&lt;String&gt;, ResponseError&gt; {
    <span class="kw">let </span>db = Connection::open_db(state.conf.clone())<span class="question-mark">?</span>;
    <span class="kw">let </span>lists_values = db.lists()<span class="question-mark">?</span>;
    <span class="kw">let </span>lists = lists_values
        .iter()
        .map(|list| {
            <span class="kw">let </span>months = db.months(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>posts = db.<span class="highlight focus">list_posts</span>(list.pk, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>newest = posts.last().and_then(|p| {
                chrono::Utc
                    .timestamp_opt(p.timestamp <span class="kw">as </span>i64, <span class="number">0</span>)
                    .earliest()
                    .map(|d| d.to_string())
            });
            <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>list_obj = MailingList::from(list.clone());
            list_obj.set_safety(list_owners.as_slice(), <span class="kw-2">&amp;</span>state.conf.administrators);
            <span class="prelude-val">Ok</span>(<span class="macro">minijinja::context! </span>{
                newest,
                posts =&gt; <span class="kw-2">&amp;</span>posts,
                months =&gt; <span class="kw-2">&amp;</span>months,
                list =&gt; Value::from_object(list_obj),
            })
        })
        .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;<span class="kw">_</span>&gt;, mailpot::Error&gt;&gt;()<span class="question-mark">?</span>;
    <span class="kw">let </span>crumbs = <span class="macro">vec!</span>[Crumb {
        label: <span class="string">&quot;Home&quot;</span>.into(),
        url: <span class="string">&quot;/&quot;</span>.into(),
    }];

    <span class="kw">let </span>context = <span class="macro">minijinja::context! </span>{
        page_title =&gt; <span class="prelude-ty">Option</span>::&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str&gt;::None,
        lists =&gt; <span class="kw-2">&amp;</span>lists,
        current_user =&gt; auth.current_user,
        messages =&gt; session.drain_messages(),
        crumbs =&gt; crumbs,
    };
    <span class="prelude-val">Ok</span>(Html(TEMPLATES.get_template(<span class="string">&quot;lists.html&quot;</span>)<span class="question-mark">?</span>.render(context)<span class="question-mark">?</span>))
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_owners" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#582-605">source</a><h4 class="code-header">pub fn <a href="#method.list_owners" class="fn">list_owners</a>(&amp;self, pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListOwner.html" title="struct mailpot::models::ListOwner">ListOwner</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch the owners of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-11"><a href="#scraped-examples-11">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[18,18],&quot;../../../src/mpot_web/main.rs.html#202&quot;,&quot;line 202&quot;]]"><div class="scraped-example-title">web/src/main.rs (<a href="../../../src/mpot_web/main.rs.html#202">line 202</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">async fn </span>root(
    <span class="kw-2">mut </span>session: WritableSession,
    auth: AuthContext,
    State(state): State&lt;Arc&lt;AppState&gt;&gt;,
) -&gt; <span class="prelude-ty">Result</span>&lt;Html&lt;String&gt;, ResponseError&gt; {
    <span class="kw">let </span>db = Connection::open_db(state.conf.clone())<span class="question-mark">?</span>;
    <span class="kw">let </span>lists_values = db.lists()<span class="question-mark">?</span>;
    <span class="kw">let </span>lists = lists_values
        .iter()
        .map(|list| {
            <span class="kw">let </span>months = db.months(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>posts = db.list_posts(list.pk, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>newest = posts.last().and_then(|p| {
                chrono::Utc
                    .timestamp_opt(p.timestamp <span class="kw">as </span>i64, <span class="number">0</span>)
                    .earliest()
                    .map(|d| d.to_string())
            });
            <span class="kw">let </span>list_owners = db.<span class="highlight focus">list_owners</span>(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>list_obj = MailingList::from(list.clone());
            list_obj.set_safety(list_owners.as_slice(), <span class="kw-2">&amp;</span>state.conf.administrators);
            <span class="prelude-val">Ok</span>(<span class="macro">minijinja::context! </span>{
                newest,
                posts =&gt; <span class="kw-2">&amp;</span>posts,
                months =&gt; <span class="kw-2">&amp;</span>months,
                list =&gt; Value::from_object(list_obj),
            })
        })
        .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;<span class="kw">_</span>&gt;, mailpot::Error&gt;&gt;()<span class="question-mark">?</span>;
    <span class="kw">let </span>crumbs = <span class="macro">vec!</span>[Crumb {
        label: <span class="string">&quot;Home&quot;</span>.into(),
        url: <span class="string">&quot;/&quot;</span>.into(),
    }];

    <span class="kw">let </span>context = <span class="macro">minijinja::context! </span>{
        page_title =&gt; <span class="prelude-ty">Option</span>::&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str&gt;::None,
        lists =&gt; <span class="kw-2">&amp;</span>lists,
        current_user =&gt; auth.current_user,
        messages =&gt; session.drain_messages(),
        crumbs =&gt; crumbs,
    };
    <span class="prelude-val">Ok</span>(Html(TEMPLATES.get_template(<span class="string">&quot;lists.html&quot;</span>)<span class="question-mark">?</span>.render(context)<span class="question-mark">?</span>))
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[59,59],&quot;../../../src/mpot/main.rs.html#120&quot;,&quot;line 120&quot;],[[155,155],&quot;../../../src/mpot/main.rs.html#216&quot;,&quot;line 216&quot;],[[178,178],&quot;../../../src/mpot/main.rs.html#239&quot;,&quot;line 239&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#120">line 120</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.<span class="highlight focus">list_owners</span>(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><div class="scraped-example " data-locs="[[[56,56],&quot;../../../src/mailpot/posts.rs.html#178&quot;,&quot;line 178&quot;],[[270,270],&quot;../../../src/mailpot/posts.rs.html#392&quot;,&quot;line 392&quot;],[[313,313],&quot;../../../src/mailpot/posts.rs.html#435&quot;,&quot;line 435&quot;],[[356,356],&quot;../../../src/mailpot/posts.rs.html#478&quot;,&quot;line 478&quot;],[[420,420],&quot;../../../src/mailpot/posts.rs.html#542&quot;,&quot;line 542&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#178">line 178</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.<span class="highlight focus">list_owners</span>(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Process a new mailing list request.
    </span><span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.<span class="highlight">list_owners</span>(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.remove_list_owner" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#608-623">source</a><h4 class="code-header">pub fn <a href="#method.remove_list_owner" class="fn">remove_list_owner</a>(&amp;self, list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>, owner_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Remove an owner of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-12"><a href="#scraped-examples-12">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[303,303],&quot;../../../src/mpot/main.rs.html#364&quot;,&quot;line 364&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#364">line 364</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.<span class="highlight focus">remove_list_owner</span>(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.add_list_owner" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#626-666">source</a><h4 class="code-header">pub fn <a href="#method.add_list_owner" class="fn">add_list_owner</a>(&amp;self, list_owner: <a class="struct" href="../../models/struct.ListOwner.html" title="struct mailpot::models::ListOwner">ListOwner</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListOwner.html" title="struct mailpot::models::ListOwner">ListOwner</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Add an owner of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-13"><a href="#scraped-examples-13">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[299,299],&quot;../../../src/mpot/main.rs.html#360&quot;,&quot;line 360&quot;],[[418,418],&quot;../../../src/mpot/main.rs.html#479&quot;,&quot;line 479&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#360">line 360</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.<span class="highlight focus">add_list_owner</span>(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.<span class="highlight">add_list_owner</span>(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.update_list" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#669-727">source</a><h4 class="code-header">pub fn <a href="#method.update_list" class="fn">update_list</a>(&amp;self, change_set: <a class="struct" href="../../models/changesets/struct.MailingListChangeset.html" title="struct mailpot::models::changesets::MailingListChangeset">MailingListChangeset</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Update a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-14"><a href="#scraped-examples-14">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[367,367],&quot;../../../src/mpot/main.rs.html#428&quot;,&quot;line 428&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#428">line 428</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.<span class="highlight focus">update_list</span>(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.savepoint" class="method"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#749-770">source</a><h4 class="code-header">pub fn <a href="#method.savepoint" class="fn">savepoint</a>(&amp;self, name: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;&amp;'static <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>&gt;) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'_&gt;&gt;</h4></section></summary><div class="docblock"><p>Execute operations inside an SQL savepoint.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-15"><a href="#scraped-examples-15">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[6,6],&quot;../../../src/mailpot/connection.rs.html#280&quot;,&quot;line 280&quot;],[[126,126],&quot;../../../src/mailpot/connection.rs.html#400&quot;,&quot;line 400&quot;],[[428,428],&quot;../../../src/mailpot/connection.rs.html#702&quot;,&quot;line 702&quot;]]"><div class="scraped-example-title">core/src/connection.rs (<a href="../../../src/mailpot/connection.rs.html#280">line 280</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>migrate(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="kw-2">mut </span>from: u32, to: u32) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">if </span>from == to {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>undo = from &gt; to;
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight focus">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(migrate)))<span class="question-mark">?</span>;

        <span class="kw">while </span>from != to {
            <span class="macro">log::trace!</span>(
                <span class="string">&quot;exec migration from {from} to {to}, type: {}do&quot;</span>,
                <span class="kw">if </span>undo { <span class="string">&quot;un &quot; </span>} <span class="kw">else </span>{ <span class="string">&quot;re&quot; </span>}
            );
            <span class="kw">if </span>undo {
                <span class="macro">trace!</span>(<span class="string">&quot;{}&quot;</span>, <span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">2</span>);
                tx.connection
                    .execute_batch(<span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">2</span>)<span class="question-mark">?</span>;
                from -= <span class="number">1</span>;
            } <span class="kw">else </span>{
                <span class="macro">trace!</span>(<span class="string">&quot;{}&quot;</span>, <span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize].<span class="number">1</span>);
                tx.connection
                    .execute_batch(<span class="self">Self</span>::MIGRATIONS[from <span class="kw">as </span>usize].<span class="number">1</span>)<span class="question-mark">?</span>;
                from += <span class="number">1</span>;
            }
        }
        tx.connection
            .pragma_update(<span class="prelude-val">None</span>, <span class="string">&quot;user_version&quot;</span>, <span class="self">Self</span>::MIGRATIONS[to <span class="kw">as </span>usize - <span class="number">1</span>].<span class="number">0</span>)<span class="question-mark">?</span>;

        tx.commit()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Removes operational limits from this connection. (see
    /// [`Connection::untrusted`])
    </span><span class="attr">#[must_use]
    </span><span class="kw">pub fn </span>trusted(<span class="self">self</span>) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.connection
            .authorizer::&lt;<span class="kw">fn</span>(rusqlite::hooks::AuthContext&lt;<span class="lifetime">&#39;_</span>&gt;) -&gt; rusqlite::hooks::Authorization&gt;(
                <span class="prelude-val">None</span>,
            );
        <span class="self">self
    </span>}

    <span class="comment">// [tag:sync_auth_doc]
    </span><span class="doccomment">/// Sets operational limits for this connection.
    ///
    /// - Allow `INSERT`, `DELETE` only for &quot;queue&quot;, &quot;candidate_subscription&quot;,
    ///   &quot;subscription&quot;.
    /// - Allow `UPDATE` only for &quot;subscription&quot; user facing settings.
    /// - Allow `INSERT` only for &quot;post&quot;.
    /// - Allow read access to all tables.
    /// - Allow `SELECT`, `TRANSACTION`, `SAVEPOINT`, and the `strftime`
    ///   function.
    /// - Deny everything else.
    </span><span class="kw">pub fn </span>untrusted(<span class="self">self</span>) -&gt; <span class="self">Self </span>{
        <span class="self">self</span>.connection.authorizer(<span class="prelude-val">Some</span>(user_authorizer_callback));
        <span class="self">self
    </span>}

    <span class="doccomment">/// Create a database if it doesn&#39;t exist and then open it.
    </span><span class="kw">pub fn </span>open_or_create_db(conf: Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>&gt; {
        <span class="kw">if </span>!conf.db_path.exists() {
            <span class="kw">let </span>db_path = <span class="kw-2">&amp;</span>conf.db_path;
            <span class="kw">use </span>std::os::unix::fs::PermissionsExt;

            <span class="macro">info!</span>(<span class="string">&quot;Creating database in {}&quot;</span>, db_path.display());
            std::fs::File::create(db_path).context(<span class="string">&quot;Could not create db path&quot;</span>)<span class="question-mark">?</span>;

            <span class="kw">let </span><span class="kw-2">mut </span>child = Command::new(std::env::var(<span class="string">&quot;SQLITE_BIN&quot;</span>).unwrap_or(<span class="string">&quot;sqlite3&quot;</span>.into()))
                .arg(db_path)
                .stdin(Stdio::piped())
                .stdout(Stdio::piped())
                .stderr(Stdio::piped())
                .spawn()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().unwrap();
            std::thread::spawn(<span class="kw">move </span>|| {
                stdin
                    .write_all(<span class="self">Self</span>::SCHEMA.as_bytes())
                    .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                <span class="kw">if </span>!<span class="self">Self</span>::MIGRATIONS.is_empty() {
                    stdin
                        .write_all(<span class="string">b&quot;\nPRAGMA user_version = &quot;</span>)
                        .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                    stdin
                        .write_all(
                            <span class="self">Self</span>::MIGRATIONS[<span class="self">Self</span>::MIGRATIONS.len() - <span class="number">1</span>]
                                .<span class="number">0
                                </span>.to_string()
                                .as_bytes(),
                        )
                        .expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                    stdin.write_all(<span class="string">b&quot;;&quot;</span>).expect(<span class="string">&quot;failed to write to stdin&quot;</span>);
                }
                stdin.flush().expect(<span class="string">&quot;could not flush stdin&quot;</span>);
            });
            <span class="kw">let </span>output = child.wait_with_output()<span class="question-mark">?</span>;
            <span class="kw">if </span>!output.status.success() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                    <span class="string">&quot;Could not initialize sqlite3 database at {}: sqlite3 returned exit code {} \
                     and stderr {} {}&quot;</span>,
                    db_path.display(),
                    output.status.code().unwrap_or_default(),
                    String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                    String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                )
                .into());
            }

            <span class="kw">let </span>file = std::fs::File::open(db_path)<span class="question-mark">?</span>;
            <span class="kw">let </span>metadata = file.metadata()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>permissions = metadata.permissions();

            permissions.set_mode(<span class="number">0o600</span>); <span class="comment">// Read/write for owner only.
            </span>file.set_permissions(permissions)<span class="question-mark">?</span>;
        }
        <span class="self">Self</span>::open_db(conf)
    }

    <span class="doccomment">/// Returns a connection&#39;s configuration.
    </span><span class="kw">pub fn </span>conf(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>Configuration {
        <span class="kw-2">&amp;</span><span class="self">self</span>.conf
    }

    <span class="doccomment">/// Loads archive databases from [`Configuration::data_path`], if any.
    </span><span class="kw">pub fn </span>load_archives(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(load_archives)))<span class="question-mark">?</span>;
        {
            <span class="kw">let </span><span class="kw-2">mut </span>stmt = tx.connection.prepare(<span class="string">&quot;ATTACH ? AS ?;&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">for </span>archive <span class="kw">in </span>std::fs::read_dir(<span class="kw-2">&amp;</span><span class="self">self</span>.conf.data_path)<span class="question-mark">? </span>{
                <span class="kw">let </span>archive = archive<span class="question-mark">?</span>;
                <span class="kw">let </span>path = archive.path();
                <span class="kw">let </span>name = path.file_name().unwrap_or_default();
                <span class="kw">if </span>path == <span class="self">self</span>.conf.db_path {
                    <span class="kw">continue</span>;
                }
                stmt.execute(<span class="macro">rusqlite::params!</span>[
                    path.to_str().unwrap(),
                    name.to_str().unwrap()
                ])<span class="question-mark">?</span>;
            }
        }
        tx.commit()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Returns a vector of existing mailing lists.
    </span><span class="kw">pub fn </span>lists(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(<span class="string">&quot;SELECT * FROM list;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                MailingList {
                    pk,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                    topics,
                    archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch a mailing list by primary key.
    </span><span class="kw">pub fn </span>list(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM list WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row([<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch a mailing list by id.
    </span><span class="kw">pub fn </span>list_by_id&lt;S: AsRef&lt;str&gt;&gt;(<span class="kw-2">&amp;</span><span class="self">self</span>, id: S) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;MailingList&gt;&gt;&gt; {
        <span class="kw">let </span>id = id.as_ref();
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM list WHERE id = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row([<span class="kw-2">&amp;</span>id], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Create a new list.
    </span><span class="kw">pub fn </span>create_list(<span class="kw-2">&amp;</span><span class="self">self</span>, new_val: MailingList) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;MailingList&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT INTO list(name, id, address, description, archive_url, topics) VALUES(?, ?, \
             ?, ?, ?, ?) RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[
                <span class="kw-2">&amp;</span>new_val.name,
                <span class="kw-2">&amp;</span>new_val.id,
                <span class="kw-2">&amp;</span>new_val.address,
                new_val.description.as_ref(),
                new_val.archive_url.as_ref(),
                <span class="macro">serde_json::json!</span>(new_val.topics.as_slice()),
            ],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics: serde_json::Value = row.get(<span class="string">&quot;topics&quot;</span>)<span class="question-mark">?</span>;
                <span class="kw">let </span>topics = MailingList::topics_from_json_value(topics)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    MailingList {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        id: row.get(<span class="string">&quot;id&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        description: row.get(<span class="string">&quot;description&quot;</span>)<span class="question-mark">?</span>,
                        topics,
                        archive_url: row.get(<span class="string">&quot;archive_url&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;create_list {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all posts of a mailing list.
    </span><span class="kw">pub fn </span>list_posts(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        _date_range: <span class="prelude-ty">Option</span>&lt;(String, String)&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;Post&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT *, strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) AS month_year \
             FROM post WHERE list = ? ORDER BY timestamp ASC;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>iter = stmt.query_map(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                Post {
                    pk,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    envelope_from: row.get(<span class="string">&quot;envelope_from&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    message_id: row.get(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                    message: row.get(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                    timestamp: row.get(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                    datetime: row.get(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
                    month_year: row.get(<span class="string">&quot;month_year&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>post <span class="kw">in </span>iter {
            <span class="kw">let </span>post = post<span class="question-mark">?</span>;
            ret.push(post);
        }

        <span class="macro">trace!</span>(<span class="string">&quot;list_posts {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch the owners of a mailing list.
    </span><span class="kw">pub fn </span>list_owners(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;ListOwner&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM owner WHERE list = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([<span class="kw-2">&amp;</span>pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                ListOwner {
                    pk,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Remove an owner of a mailing list.
    </span><span class="kw">pub fn </span>remove_list_owner(<span class="kw-2">&amp;</span><span class="self">self</span>, list_pk: i64, owner_pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="self">self</span>.connection
            .query_row(
                <span class="string">&quot;DELETE FROM owner WHERE list = ? AND pk = ? RETURNING *;&quot;</span>,
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>owner_pk],
                |<span class="kw">_</span>| <span class="prelude-val">Ok</span>(()),
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;list or list owner not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Add an owner of a mailing list.
    </span><span class="kw">pub fn </span>add_list_owner(<span class="kw-2">&amp;</span><span class="self">self</span>, list_owner: ListOwner) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListOwner&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT OR REPLACE INTO owner(list, address, name) VALUES (?, ?, ?) RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>list_pk = list_owner.list;
        <span class="kw">let </span>ret = stmt
            .query_row(
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>list_owner.address, <span class="kw-2">&amp;</span>list_owner.name,],
                |row| {
                    <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                    <span class="prelude-val">Ok</span>(DbVal(
                        ListOwner {
                            pk,
                            list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                            address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                            name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        },
                        pk,
                    ))
                },
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(
                    err,
                    rusqlite::Error::SqliteFailure(
                        rusqlite::ffi::Error {
                            code: rusqlite::ffi::ErrorCode::ConstraintViolation,
                            extended_code: <span class="number">787
                        </span>},
                        <span class="kw">_
                    </span>)
                ) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;Could not find a list with this pk.&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;add_list_owner {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Update a mailing list.
    </span><span class="kw">pub fn </span>update_list(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: MailingListChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            MailingListChangeset {
                pk: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                id: <span class="prelude-val">None</span>,
                address: <span class="prelude-val">None</span>,
                description: <span class="prelude-val">None</span>,
                archive_url: <span class="prelude-val">None</span>,
                owner_local_part: <span class="prelude-val">None</span>,
                request_local_part: <span class="prelude-val">None</span>,
                verify: <span class="prelude-val">None</span>,
                hidden: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="self">self</span>.list(change_set.pk).map(|<span class="kw">_</span>| ());
        }

        <span class="kw">let </span>MailingListChangeset {
            pk,
            name,
            id,
            address,
            description,
            archive_url,
            owner_local_part,
            request_local_part,
            verify,
            hidden,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_list)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(<span class="string">&quot;UPDATE list SET &quot;</span>, <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>), <span class="string">&quot; = ? WHERE pk = ?;&quot;</span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(id);
        <span class="macro">update!</span>(address);
        <span class="macro">update!</span>(description);
        <span class="macro">update!</span>(archive_url);
        <span class="macro">update!</span>(owner_local_part);
        <span class="macro">update!</span>(request_local_part);
        <span class="macro">update!</span>(verify);
        <span class="macro">update!</span>(hidden);
        <span class="macro">update!</span>(enabled);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/queue.rs.html#240&quot;,&quot;line 240&quot;]]"><div class="scraped-example-title">core/src/queue.rs (<a href="../../../src/mailpot/queue.rs.html#240">line 240</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>delete_from_queue(<span class="kw-2">&amp;</span><span class="self">self</span>, queue: Queue, index: Vec&lt;i64&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;QueueEntry&gt;&gt; {
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight focus">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(delete_from_queue)))<span class="question-mark">?</span>;

        <span class="kw">let </span>cl = |row: <span class="kw-2">&amp;</span>rusqlite::Row&lt;<span class="lifetime">&#39;_</span>&gt;| {
            <span class="prelude-val">Ok</span>(QueueEntry {
                pk: -<span class="number">1</span>,
                queue,
                list: row.get::&lt;<span class="kw">_</span>, <span class="prelude-ty">Option</span>&lt;i64&gt;&gt;(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                comment: row.get::&lt;<span class="kw">_</span>, <span class="prelude-ty">Option</span>&lt;String&gt;&gt;(<span class="string">&quot;comment&quot;</span>)<span class="question-mark">?</span>,
                to_addresses: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;to_addresses&quot;</span>)<span class="question-mark">?</span>,
                from_address: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;from_address&quot;</span>)<span class="question-mark">?</span>,
                subject: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;subject&quot;</span>)<span class="question-mark">?</span>,
                message_id: row.get::&lt;<span class="kw">_</span>, String&gt;(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                message: row.get::&lt;<span class="kw">_</span>, Vec&lt;u8&gt;&gt;(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                timestamp: row.get::&lt;<span class="kw">_</span>, u64&gt;(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                datetime: row.get::&lt;<span class="kw">_</span>, DateTime&gt;(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
            })
        };
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="kw">if </span>index.is_empty() {
            tx.connection
                .prepare(<span class="string">&quot;DELETE FROM queue WHERE which = ? RETURNING *;&quot;</span>)<span class="question-mark">?
        </span>} <span class="kw">else </span>{
            tx.connection
                .prepare(<span class="string">&quot;DELETE FROM queue WHERE which = ? AND pk IN rarray(?) RETURNING *;&quot;</span>)<span class="question-mark">?
        </span>};
        <span class="kw">let </span>iter = <span class="kw">if </span>index.is_empty() {
            stmt.query_map([<span class="kw-2">&amp;</span>queue.as_str()], cl)<span class="question-mark">?
        </span>} <span class="kw">else </span>{
            <span class="comment">// Note: A `Rc&lt;Vec&lt;Value&gt;&gt;` must be used as the parameter.
            </span><span class="kw">let </span>index = std::rc::Rc::new(
                index
                    .into_iter()
                    .map(rusqlite::types::Value::from)
                    .collect::&lt;Vec&lt;rusqlite::types::Value&gt;&gt;(),
            );
            stmt.query_map(<span class="macro">rusqlite::params!</span>[queue.as_str(), index], cl)<span class="question-mark">?
        </span>};

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>item <span class="kw">in </span>iter {
            <span class="kw">let </span>item = item<span class="question-mark">?</span>;
            ret.push(item);
        }
        drop(stmt);
        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div><div class="scraped-example " data-locs="[[[36,36],&quot;../../../src/mailpot/subscriptions.rs.html#350&quot;,&quot;line 350&quot;],[[261,261],&quot;../../../src/mailpot/subscriptions.rs.html#575&quot;,&quot;line 575&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#350">line 350</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>update_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: ListSubscriptionChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>pk = <span class="self">self
            </span>.list_subscription_by_address(change_set.list, <span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">?
            </span>.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            ListSubscriptionChangeset {
                list: <span class="kw">_</span>,
                address: <span class="kw">_</span>,
                account: <span class="prelude-val">None</span>,
                name: <span class="prelude-val">None</span>,
                digest: <span class="prelude-val">None</span>,
                verified: <span class="prelude-val">None</span>,
                hide_address: <span class="prelude-val">None</span>,
                receive_duplicates: <span class="prelude-val">None</span>,
                receive_own_posts: <span class="prelude-val">None</span>,
                receive_confirmation: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>ListSubscriptionChangeset {
            list,
            address: <span class="kw">_</span>,
            name,
            account,
            digest,
            enabled,
            verified,
            hide_address,
            receive_duplicates,
            receive_own_posts,
            receive_confirmation,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight focus">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_subscription)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE subscription SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE list = ? AND pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>list, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(account);
        <span class="macro">update!</span>(digest);
        <span class="macro">update!</span>(enabled);
        <span class="macro">update!</span>(verified);
        <span class="macro">update!</span>(hide_address);
        <span class="macro">update!</span>(receive_duplicates);
        <span class="macro">update!</span>(receive_own_posts);
        <span class="macro">update!</span>(receive_confirmation);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Fetch account by pk.
    </span><span class="kw">pub fn </span>account(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>_pk: i64 = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="macro">debug_assert_eq!</span>(pk, _pk);
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch account by address.
    </span><span class="kw">pub fn </span>account_by_address(<span class="kw-2">&amp;</span><span class="self">self</span>, address: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account WHERE address = ?;&quot;</span>)<span class="question-mark">?</span>;

        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>address], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all subscriptions of an account by primary key.
    </span><span class="kw">pub fn </span>account_subscriptions(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;ListSubscription&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM subscription WHERE account = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([<span class="kw-2">&amp;</span>pk], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                ListSubscription {
                    pk: row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>,
                    list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    account: row.get(<span class="string">&quot;account&quot;</span>)<span class="question-mark">?</span>,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    digest: row.get(<span class="string">&quot;digest&quot;</span>)<span class="question-mark">?</span>,
                    enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    verified: row.get(<span class="string">&quot;verified&quot;</span>)<span class="question-mark">?</span>,
                    hide_address: row.get(<span class="string">&quot;hide_address&quot;</span>)<span class="question-mark">?</span>,
                    receive_duplicates: row.get(<span class="string">&quot;receive_duplicates&quot;</span>)<span class="question-mark">?</span>,
                    receive_own_posts: row.get(<span class="string">&quot;receive_own_posts&quot;</span>)<span class="question-mark">?</span>,
                    receive_confirmation: row.get(<span class="string">&quot;receive_confirmation&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Fetch all accounts.
    </span><span class="kw">pub fn </span>accounts(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;DbVal&lt;Account&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM account ORDER BY pk ASC;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>list_iter = stmt.query_map([], |row| {
            <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(DbVal(
                Account {
                    pk,
                    name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                    address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                    public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                    password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                    enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                },
                pk,
            ))
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>list <span class="kw">in </span>list_iter {
            <span class="kw">let </span>list = list<span class="question-mark">?</span>;
            ret.push(list);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Add account.
    </span><span class="kw">pub fn </span>add_account(<span class="kw-2">&amp;</span><span class="self">self</span>, new_val: Account) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;Account&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(
                <span class="string">&quot;INSERT INTO account(name, address, public_key, password, enabled) VALUES(?, ?, \
                 ?, ?, ?) RETURNING *;&quot;</span>,
            )
            .unwrap();
        <span class="kw">let </span>ret = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[
                <span class="kw-2">&amp;</span>new_val.name,
                <span class="kw-2">&amp;</span>new_val.address,
                <span class="kw-2">&amp;</span>new_val.public_key,
                <span class="kw-2">&amp;</span>new_val.password,
                <span class="kw-2">&amp;</span>new_val.enabled,
            ],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Account {
                        pk,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        public_key: row.get(<span class="string">&quot;public_key&quot;</span>)<span class="question-mark">?</span>,
                        password: row.get(<span class="string">&quot;password&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;add_account {:?}.&quot;</span>, <span class="kw-2">&amp;</span>ret);
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Remove an account by their address.
    </span><span class="kw">pub fn </span>remove_account(<span class="kw-2">&amp;</span><span class="self">self</span>, address: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="self">self</span>.connection
            .query_row(
                <span class="string">&quot;DELETE FROM account WHERE address = ? RETURNING *;&quot;</span>,
                <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>address],
                |<span class="kw">_</span>| <span class="prelude-val">Ok</span>(()),
            )
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err).chain_err(|| NotFound(<span class="string">&quot;account not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Update an account.
    </span><span class="kw">pub fn </span>update_account(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: AccountChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span><span class="prelude-val">Some</span>(acc) = <span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">? </span><span class="kw">else </span>{
            <span class="kw">return </span><span class="prelude-val">Err</span>(NotFound(<span class="string">&quot;account with this address not found!&quot;</span>).into());
        };
        <span class="kw">let </span>pk = acc.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            AccountChangeset {
                address: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                public_key: <span class="prelude-val">None</span>,
                password: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>AccountChangeset {
            address: <span class="kw">_</span>,
            name,
            public_key,
            password,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.<span class="highlight">savepoint</span>(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_account)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE account SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(public_key);
        <span class="macro">update!</span>(password);
        <span class="macro">update!</span>(enabled);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.get_settings" class="method"><a class="srclink rightside" href="../../../src/mailpot/message_filters/settings.rs.html#32-43">source</a><h4 class="code-header">pub fn <a href="#method.get_settings" class="fn">get_settings</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/std/collections/hash/map/struct.HashMap.html" title="struct std::collections::hash::map::HashMap">HashMap</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>, <a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="enum" href="https://docs.rs/serde_json/1.0.96/serde_json/value/enum.Value.html" title="enum serde_json::value::Value">Value</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Get json settings.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-16"><a href="#scraped-examples-16">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[64,64],&quot;../../../src/mailpot/posts.rs.html#186&quot;,&quot;line 186&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#186">line 186</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.<span class="highlight focus">get_settings</span>(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_filters" class="method"><a class="srclink rightside" href="../../../src/mailpot/message_filters.rs.html#55-64">source</a><h4 class="code-header">pub fn <a href="#method.list_filters" class="fn">list_filters</a>(
    &amp;self,
    _list: &amp;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;
) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="../../message_filters/trait.PostFilter.html" title="trait mailpot::message_filters::PostFilter">PostFilter</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Return the post filters of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-17"><a href="#scraped-examples-17">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[54,54],&quot;../../../src/mailpot/posts.rs.html#176&quot;,&quot;line 176&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#176">line 176</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.<span class="highlight focus">list_filters</span>(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_post_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#37-60">source</a><h4 class="code-header">pub fn <a href="#method.list_post_policy" class="fn">list_post_policy</a>(&amp;self, pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.PostPolicy.html" title="struct mailpot::models::PostPolicy">PostPolicy</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch the post policy of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-18"><a href="#scraped-examples-18">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[68,68],&quot;../../../src/mpot/main.rs.html#129&quot;,&quot;line 129&quot;],[[156,156],&quot;../../../src/mpot/main.rs.html#217&quot;,&quot;line 217&quot;],[[179,179],&quot;../../../src/mpot/main.rs.html#240&quot;,&quot;line 240&quot;],[[751,751],&quot;../../../src/mpot/main.rs.html#812&quot;,&quot;line 812&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#129">line 129</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.<span class="highlight focus">list_post_policy</span>(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.<span class="highlight">list_post_policy</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.<span class="highlight">list_post_policy</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.<span class="highlight">list_post_policy</span>(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[10,10],&quot;../../../src/mailpot/postfix.rs.html#291&quot;,&quot;line 291&quot;]]"><div class="scraped-example-title">core/src/postfix.rs (<a href="../../../src/mailpot/postfix.rs.html#291">line 291</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>save_maps(<span class="kw-2">&amp;</span><span class="self">self</span>, config: <span class="kw-2">&amp;</span>Configuration) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>db = Connection::open_db(config.clone())<span class="question-mark">?</span>;
        <span class="kw">let </span><span class="prelude-val">Some</span>(postmap) = find_binary_in_path(<span class="string">&quot;postmap&quot;</span>) <span class="kw">else </span>{
            <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(<span class="string">&quot;Could not find postmap binary in PATH.&quot;</span>))));
        };
        <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
        <span class="kw">let </span>lists_post_policies = lists
            .into_iter()
            .map(|l| {
                <span class="kw">let </span>pk = l.pk;
                <span class="prelude-val">Ok</span>((l, db.<span class="highlight focus">list_post_policy</span>(pk)<span class="question-mark">?</span>))
            })
            .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
        <span class="kw">let </span>content = <span class="self">self</span>.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
        <span class="kw">let </span>path = <span class="self">self
            </span>.map_output_path
            .as_deref()
            .unwrap_or(<span class="kw-2">&amp;</span>config.data_path)
            .join(<span class="string">&quot;mailpot_postfix_map&quot;</span>);
        <span class="kw">let </span><span class="kw-2">mut </span>file = BufWriter::new(
            OpenOptions::new()
                .read(<span class="bool-val">true</span>)
                .write(<span class="bool-val">true</span>)
                .create(<span class="bool-val">true</span>)
                .truncate(<span class="bool-val">true</span>)
                .open(<span class="kw-2">&amp;</span>path)
                .context(<span class="macro">format!</span>(<span class="string">&quot;Could not open {}&quot;</span>, path.display()))<span class="question-mark">?</span>,
        );
        file.write_all(content.as_bytes())
            .context(<span class="macro">format!</span>(<span class="string">&quot;Could not write to {}&quot;</span>, path.display()))<span class="question-mark">?</span>;
        file.flush()
            .context(<span class="macro">format!</span>(<span class="string">&quot;Could not write to {}&quot;</span>, path.display()))<span class="question-mark">?</span>;

        <span class="kw">let </span>output = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
            .arg(<span class="string">&quot;-c&quot;</span>)
            .arg(<span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;{} {}&quot;</span>, postmap.display(), path.display()))
            .output()
            .with_context(|| {
                <span class="macro">format!</span>(
                    <span class="string">&quot;Could not execute `postmap` binary in path {}&quot;</span>,
                    postmap.display()
                )
            })<span class="question-mark">?</span>;
        <span class="kw">if </span>!output.status.success() {
            <span class="kw">use </span>std::os::unix::process::ExitStatusExt;
            <span class="kw">if let </span><span class="prelude-val">Some</span>(code) = output.status.code() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} exited with {}.\nstderr was:\n---{}---\nstdout was\n---{}---\n&quot;</span>,
                        code,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            } <span class="kw">else if let </span><span class="prelude-val">Some</span>(signum) = output.status.signal() {
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} was killed with signal {}.\nstderr was:\n---{}---\nstdout \
                         was\n---{}---\n&quot;</span>,
                        signum,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            } <span class="kw">else </span>{
                <span class="kw">return </span><span class="prelude-val">Err</span>(Error::from(ErrorKind::External(anyhow::Error::msg(
                    <span class="macro">format!</span>(
                        <span class="string">&quot;{} failed for unknown reason.\nstderr was:\n---{}---\nstdout \
                         was\n---{}---\n&quot;</span>,
                        postmap.display(),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stderr),
                        String::from_utf8_lossy(<span class="kw-2">&amp;</span>output.stdout)
                    ),
                ))));
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><div class="scraped-example " data-locs="[[[59,59],&quot;../../../src/mailpot/posts.rs.html#181&quot;,&quot;line 181&quot;],[[188,188],&quot;../../../src/mailpot/posts.rs.html#310&quot;,&quot;line 310&quot;],[[611,611],&quot;../../../src/mailpot/posts.rs.html#733&quot;,&quot;line 733&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#181">line 181</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.<span class="highlight focus">list_post_policy</span>(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Process a new mailing list request.
    </span><span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.<span class="highlight">list_post_policy</span>(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Fetch all year and month values for which at least one post exists in
    /// `yyyy-mm` format.
    </span><span class="kw">pub fn </span>months(<span class="kw-2">&amp;</span><span class="self">self</span>, list_pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;String&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT DISTINCT strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) FROM post \
             WHERE list = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>months_iter = stmt.query_map([list_pk], |row| {
            <span class="kw">let </span>val: String = row.get(<span class="number">0</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(val)
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>month <span class="kw">in </span>months_iter {
            <span class="kw">let </span>month = month<span class="question-mark">?</span>;
            ret.push(month);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Find a post by its `Message-ID` email header.
    </span><span class="kw">pub fn </span>list_post_by_message_id(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        message_id: <span class="kw-2">&amp;</span>str,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Post&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT *, strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) AS month_year \
             FROM post WHERE list = ? AND message_id = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>message_id], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Post {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        envelope_from: row.get(<span class="string">&quot;envelope_from&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        message_id: row.get(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                        message: row.get(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                        timestamp: row.get(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                        datetime: row.get(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
                        month_year: row.get(<span class="string">&quot;month_year&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Helper function to send a template reply.
    </span><span class="kw">pub fn </span>send_reply_with_list_template&lt;<span class="lifetime">&#39;ctx</span>, F: Fn() -&gt; Template&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        render_context: TemplateRenderContext&lt;<span class="lifetime">&#39;ctx</span>, F&gt;,
        recipients: <span class="kw">impl </span>Iterator&lt;Item = Cow&lt;<span class="lifetime">&#39;ctx</span>, melib::Address&gt;&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>TemplateRenderContext {
            template,
            default_fn,
            list,
            context,
            queue,
            comment,
        } = render_context;

        <span class="kw">let </span>post_policy = <span class="self">self</span>.<span class="highlight">list_post_policy</span>(list.pk)<span class="question-mark">?</span>;
        <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;

        <span class="kw">let </span>templ = <span class="self">self
            </span>.fetch_template(template, <span class="prelude-val">Some</span>(list.pk))<span class="question-mark">?
            </span>.map(DbVal::into_inner)
            .or_else(|| default_fn.map(|f| f()))
            .ok_or_else(|| -&gt; <span class="kw">crate</span>::Error {
                <span class="macro">format!</span>(<span class="string">&quot;Template with name {template:?} was not found.&quot;</span>).into()
            })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>draft = templ.render(context)<span class="question-mark">?</span>;
        draft.headers.insert(
            melib::HeaderName::new_unchecked(<span class="string">&quot;From&quot;</span>),
            list.request_subaddr(),
        );
        <span class="kw">for </span>addr <span class="kw">in </span>recipients {
            <span class="kw">let </span><span class="kw-2">mut </span>draft = draft.clone();
            draft
                .headers
                .insert(melib::HeaderName::new_unchecked(<span class="string">&quot;To&quot;</span>), addr.to_string());
            list.insert_headers(
                <span class="kw-2">&amp;mut </span>draft,
                post_policy.as_deref(),
                subscription_policy.as_deref(),
            );
            <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                queue,
                <span class="prelude-val">Some</span>(list.pk),
                <span class="prelude-val">None</span>,
                draft.finalise()<span class="question-mark">?</span>.as_bytes(),
                <span class="prelude-val">Some</span>(comment.to_string()),
            )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.remove_list_post_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#132-147">source</a><h4 class="code-header">pub fn <a href="#method.remove_list_post_policy" class="fn">remove_list_post_policy</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    policy_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Remove an existing list policy.</p>
<h5 id="examples"><a href="#examples">Examples</a></h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>db = Connection::open_or_create_db(config).unwrap().trusted();
<span class="kw">let </span>list = db
    .create_list(MailingList {
        pk: <span class="number">0</span>,
        name: <span class="string">&quot;foobar chat&quot;</span>.into(),
        id: <span class="string">&quot;foo-chat&quot;</span>.into(),
        address: <span class="string">&quot;foo-chat@example.com&quot;</span>.into(),
        description: <span class="prelude-val">None</span>,
        topics: <span class="macro">vec!</span>[],
        archive_url: <span class="prelude-val">None</span>,
    })
    .unwrap();

<span class="kw">let </span>pol = db
    .set_list_post_policy(PostPolicy {
        pk: -<span class="number">1</span>,
        list: list.pk(),
        announce_only: <span class="bool-val">false</span>,
        subscription_only: <span class="bool-val">true</span>,
        approval_needed: <span class="bool-val">false</span>,
        open: <span class="bool-val">false</span>,
        custom: <span class="bool-val">false</span>,
    })
    .unwrap();
db.remove_list_post_policy(list.pk(), pol.pk()).unwrap();</code></pre></div>

<div class="example-wrap should_panic"><a href="#" class="tooltip" title="This example panics">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="kw">let </span>db = Connection::open_or_create_db(config).unwrap().trusted();
db.remove_list_post_policy(<span class="number">1</span>, <span class="number">1</span>).unwrap();</code></pre></div>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-19"><a href="#scraped-examples-19">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[266,266],&quot;../../../src/mpot/main.rs.html#327&quot;,&quot;line 327&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#327">line 327</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.<span class="highlight focus">remove_list_post_policy</span>(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.set_list_post_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#150-214">source</a><h4 class="code-header">pub fn <a href="#method.set_list_post_policy" class="fn">set_list_post_policy</a>(
    &amp;self,
    policy: <a class="struct" href="../../models/struct.PostPolicy.html" title="struct mailpot::models::PostPolicy">PostPolicy</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.PostPolicy.html" title="struct mailpot::models::PostPolicy">PostPolicy</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Set the unique post policy for a list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-20"><a href="#scraped-examples-20">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[262,262],&quot;../../../src/mpot/main.rs.html#323&quot;,&quot;line 323&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#323">line 323</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.<span class="highlight focus">set_list_post_policy</span>(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_subscription_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#230-256">source</a><h4 class="code-header">pub fn <a href="#method.list_subscription_policy" class="fn">list_subscription_policy</a>(
    &amp;self,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.SubscriptionPolicy.html" title="struct mailpot::models::SubscriptionPolicy">SubscriptionPolicy</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch the subscription policy of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-21"><a href="#scraped-examples-21">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[73,73],&quot;../../../src/mpot/main.rs.html#134&quot;,&quot;line 134&quot;],[[157,157],&quot;../../../src/mpot/main.rs.html#218&quot;,&quot;line 218&quot;],[[180,180],&quot;../../../src/mpot/main.rs.html#241&quot;,&quot;line 241&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#134">line 134</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.<span class="highlight focus">list_subscription_policy</span>(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.<span class="highlight">list_subscription_policy</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.<span class="highlight">list_subscription_policy</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[60,60],&quot;../../../src/mailpot/posts.rs.html#182&quot;,&quot;line 182&quot;],[[196,196],&quot;../../../src/mailpot/posts.rs.html#318&quot;,&quot;line 318&quot;],[[612,612],&quot;../../../src/mailpot/posts.rs.html#734&quot;,&quot;line 734&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#182">line 182</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.<span class="highlight focus">list_subscription_policy</span>(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Process a new mailing list request.
    </span><span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.<span class="highlight">list_subscription_policy</span>(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Fetch all year and month values for which at least one post exists in
    /// `yyyy-mm` format.
    </span><span class="kw">pub fn </span>months(<span class="kw-2">&amp;</span><span class="self">self</span>, list_pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;String&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT DISTINCT strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) FROM post \
             WHERE list = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>months_iter = stmt.query_map([list_pk], |row| {
            <span class="kw">let </span>val: String = row.get(<span class="number">0</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(val)
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>month <span class="kw">in </span>months_iter {
            <span class="kw">let </span>month = month<span class="question-mark">?</span>;
            ret.push(month);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Find a post by its `Message-ID` email header.
    </span><span class="kw">pub fn </span>list_post_by_message_id(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        message_id: <span class="kw-2">&amp;</span>str,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Post&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT *, strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) AS month_year \
             FROM post WHERE list = ? AND message_id = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>message_id], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Post {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        envelope_from: row.get(<span class="string">&quot;envelope_from&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        message_id: row.get(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                        message: row.get(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                        timestamp: row.get(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                        datetime: row.get(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
                        month_year: row.get(<span class="string">&quot;month_year&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Helper function to send a template reply.
    </span><span class="kw">pub fn </span>send_reply_with_list_template&lt;<span class="lifetime">&#39;ctx</span>, F: Fn() -&gt; Template&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        render_context: TemplateRenderContext&lt;<span class="lifetime">&#39;ctx</span>, F&gt;,
        recipients: <span class="kw">impl </span>Iterator&lt;Item = Cow&lt;<span class="lifetime">&#39;ctx</span>, melib::Address&gt;&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>TemplateRenderContext {
            template,
            default_fn,
            list,
            context,
            queue,
            comment,
        } = render_context;

        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">let </span>subscription_policy = <span class="self">self</span>.<span class="highlight">list_subscription_policy</span>(list.pk)<span class="question-mark">?</span>;

        <span class="kw">let </span>templ = <span class="self">self
            </span>.fetch_template(template, <span class="prelude-val">Some</span>(list.pk))<span class="question-mark">?
            </span>.map(DbVal::into_inner)
            .or_else(|| default_fn.map(|f| f()))
            .ok_or_else(|| -&gt; <span class="kw">crate</span>::Error {
                <span class="macro">format!</span>(<span class="string">&quot;Template with name {template:?} was not found.&quot;</span>).into()
            })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>draft = templ.render(context)<span class="question-mark">?</span>;
        draft.headers.insert(
            melib::HeaderName::new_unchecked(<span class="string">&quot;From&quot;</span>),
            list.request_subaddr(),
        );
        <span class="kw">for </span>addr <span class="kw">in </span>recipients {
            <span class="kw">let </span><span class="kw-2">mut </span>draft = draft.clone();
            draft
                .headers
                .insert(melib::HeaderName::new_unchecked(<span class="string">&quot;To&quot;</span>), addr.to_string());
            list.insert_headers(
                <span class="kw-2">&amp;mut </span>draft,
                post_policy.as_deref(),
                subscription_policy.as_deref(),
            );
            <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                queue,
                <span class="prelude-val">Some</span>(list.pk),
                <span class="prelude-val">None</span>,
                draft.finalise()<span class="question-mark">?</span>.as_bytes(),
                <span class="prelude-val">Some</span>(comment.to_string()),
            )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.remove_list_subscription_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#327-342">source</a><h4 class="code-header">pub fn <a href="#method.remove_list_subscription_policy" class="fn">remove_list_subscription_policy</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    policy_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Remove an existing subscription policy.</p>
<h5 id="examples-1"><a href="#examples-1">Examples</a></h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>db = Connection::open_or_create_db(config).unwrap().trusted();
<span class="kw">let </span>list = db
    .create_list(MailingList {
        pk: <span class="number">0</span>,
        name: <span class="string">&quot;foobar chat&quot;</span>.into(),
        id: <span class="string">&quot;foo-chat&quot;</span>.into(),
        address: <span class="string">&quot;foo-chat@example.com&quot;</span>.into(),
        description: <span class="prelude-val">None</span>,
        topics: <span class="macro">vec!</span>[],
        archive_url: <span class="prelude-val">None</span>,
    })
    .unwrap();
<span class="kw">let </span>pol = db
    .set_list_subscription_policy(SubscriptionPolicy {
        pk: -<span class="number">1</span>,
        list: list.pk(),
        send_confirmation: <span class="bool-val">false</span>,
        open: <span class="bool-val">true</span>,
        manual: <span class="bool-val">false</span>,
        request: <span class="bool-val">false</span>,
        custom: <span class="bool-val">false</span>,
    })
    .unwrap();
db.remove_list_subscription_policy(list.pk(), pol.pk())
    .unwrap();</code></pre></div>

<div class="example-wrap should_panic"><a href="#" class="tooltip" title="This example panics">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="kw">let </span>db = Connection::open_or_create_db(config).unwrap().trusted();
db.remove_list_post_policy(<span class="number">1</span>, <span class="number">1</span>).unwrap();</code></pre></div>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-22"><a href="#scraped-examples-22">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[289,289],&quot;../../../src/mpot/main.rs.html#350&quot;,&quot;line 350&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#350">line 350</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.<span class="highlight focus">remove_list_subscription_policy</span>(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.set_list_subscription_policy" class="method"><a class="srclink rightside" href="../../../src/mailpot/policies.rs.html#345-407">source</a><h4 class="code-header">pub fn <a href="#method.set_list_subscription_policy" class="fn">set_list_subscription_policy</a>(
    &amp;self,
    policy: <a class="struct" href="../../models/struct.SubscriptionPolicy.html" title="struct mailpot::models::SubscriptionPolicy">SubscriptionPolicy</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.SubscriptionPolicy.html" title="struct mailpot::models::SubscriptionPolicy">SubscriptionPolicy</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Set the unique post policy for a list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-23"><a href="#scraped-examples-23">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[285,285],&quot;../../../src/mpot/main.rs.html#346&quot;,&quot;line 346&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#346">line 346</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.<span class="highlight focus">set_list_subscription_policy</span>(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.insert_post" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#39-84">source</a><h4 class="code-header">pub fn <a href="#method.insert_post" class="fn">insert_post</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    message: &amp;[<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u8.html">u8</a>],
    env: &amp;Envelope
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>&gt;</h4></section></summary><div class="docblock"><p>Insert a mailing list post into the database.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-24"><a href="#scraped-examples-24">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[698,698],&quot;../../../src/mpot/main.rs.html#759&quot;,&quot;line 759&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#759">line 759</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.<span class="highlight focus">insert_post</span>(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[86,86],&quot;../../../src/mailpot/posts.rs.html#208&quot;,&quot;line 208&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#208">line 208</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.<span class="highlight focus">insert_post</span>(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.post" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#91-120">source</a><h4 class="code-header">pub fn <a href="#method.post" class="fn">post</a>(&amp;self, env: &amp;Envelope, raw: &amp;[<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u8.html">u8</a>], _dry_run: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.bool.html">bool</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Process a new mailing list post.</p>
<p>In case multiple processes can access the database at any time, use an
<code>EXCLUSIVE</code> transaction before calling this function.
See <a href="../struct.Connection.html#method.transaction" title="method mailpot::connection::Connection::transaction"><code>Connection::transaction</code></a>.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-25"><a href="#scraped-examples-25">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[464,464],&quot;../../../src/mpot/main.rs.html#525&quot;,&quot;line 525&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#525">line 525</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.<span class="highlight focus">post</span>(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.inner_post" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#122-300">source</a><h4 class="code-header">fn <a href="#method.inner_post" class="fn">inner_post</a>(&amp;self, env: &amp;Envelope, raw: &amp;[<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u8.html">u8</a>], _dry_run: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.bool.html">bool</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-26"><a href="#scraped-examples-26">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/posts.rs.html#92&quot;,&quot;line 92&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#92">line 92</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>result = <span class="self">self</span>.<span class="highlight focus">inner_post</span>(env, raw, _dry_run);
        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = result {
            <span class="kw">return match </span><span class="self">self</span>.insert_to_queue(QueueEntry::new(
                Queue::Error,
                <span class="prelude-val">None</span>,
                <span class="prelude-val">Some</span>(Cow::Borrowed(env)),
                raw,
                <span class="prelude-val">Some</span>(err.to_string()),
            )<span class="question-mark">?</span>) {
                <span class="prelude-val">Ok</span>(idx) =&gt; {
                    <span class="macro">log::info!</span>(
                        <span class="string">&quot;Inserted mail from {:?} into error_queue at index {}&quot;</span>,
                        env.from(),
                        idx
                    );
                    <span class="prelude-val">Err</span>(err)
                }
                <span class="prelude-val">Err</span>(err2) =&gt; {
                    <span class="macro">log::error!</span>(
                        <span class="string">&quot;Could not insert mail from {:?} into error_queue: {err2}&quot;</span>,
                        env.from(),
                    );

                    <span class="prelude-val">Err</span>(err.chain_err(|| err2))
                }
            };
        }
        result
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.request" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#303-663">source</a><h4 class="code-header">pub fn <a href="#method.request" class="fn">request</a>(
    &amp;self,
    list: &amp;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.MailingList.html" title="struct mailpot::models::MailingList">MailingList</a>&gt;,
    request: <a class="enum" href="../../mail/enum.ListRequest.html" title="enum mailpot::mail::ListRequest">ListRequest</a>,
    env: &amp;Envelope,
    raw: &amp;[<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.u8.html">u8</a>]
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Process a new mailing list request.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-27"><a href="#scraped-examples-27">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[21,21],&quot;../../../src/mailpot/posts.rs.html#143&quot;,&quot;line 143&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#143">line 143</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.<span class="highlight focus">request</span>(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.months" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#667-683">source</a><h4 class="code-header">pub fn <a href="#method.months" class="fn">months</a>(&amp;self, list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all year and month values for which at least one post exists in
<code>yyyy-mm</code> format.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-28"><a href="#scraped-examples-28">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[10,10],&quot;../../../src/mpot_web/main.rs.html#194&quot;,&quot;line 194&quot;]]"><div class="scraped-example-title">web/src/main.rs (<a href="../../../src/mpot_web/main.rs.html#194">line 194</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">async fn </span>root(
    <span class="kw-2">mut </span>session: WritableSession,
    auth: AuthContext,
    State(state): State&lt;Arc&lt;AppState&gt;&gt;,
) -&gt; <span class="prelude-ty">Result</span>&lt;Html&lt;String&gt;, ResponseError&gt; {
    <span class="kw">let </span>db = Connection::open_db(state.conf.clone())<span class="question-mark">?</span>;
    <span class="kw">let </span>lists_values = db.lists()<span class="question-mark">?</span>;
    <span class="kw">let </span>lists = lists_values
        .iter()
        .map(|list| {
            <span class="kw">let </span>months = db.<span class="highlight focus">months</span>(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>posts = db.list_posts(list.pk, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span>newest = posts.last().and_then(|p| {
                chrono::Utc
                    .timestamp_opt(p.timestamp <span class="kw">as </span>i64, <span class="number">0</span>)
                    .earliest()
                    .map(|d| d.to_string())
            });
            <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>list_obj = MailingList::from(list.clone());
            list_obj.set_safety(list_owners.as_slice(), <span class="kw-2">&amp;</span>state.conf.administrators);
            <span class="prelude-val">Ok</span>(<span class="macro">minijinja::context! </span>{
                newest,
                posts =&gt; <span class="kw-2">&amp;</span>posts,
                months =&gt; <span class="kw-2">&amp;</span>months,
                list =&gt; Value::from_object(list_obj),
            })
        })
        .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;<span class="kw">_</span>&gt;, mailpot::Error&gt;&gt;()<span class="question-mark">?</span>;
    <span class="kw">let </span>crumbs = <span class="macro">vec!</span>[Crumb {
        label: <span class="string">&quot;Home&quot;</span>.into(),
        url: <span class="string">&quot;/&quot;</span>.into(),
    }];

    <span class="kw">let </span>context = <span class="macro">minijinja::context! </span>{
        page_title =&gt; <span class="prelude-ty">Option</span>::&lt;<span class="kw-2">&amp;</span><span class="lifetime">&#39;static </span>str&gt;::None,
        lists =&gt; <span class="kw-2">&amp;</span>lists,
        current_user =&gt; auth.current_user,
        messages =&gt; session.drain_messages(),
        crumbs =&gt; crumbs,
    };
    <span class="prelude-val">Ok</span>(Html(TEMPLATES.get_template(<span class="string">&quot;lists.html&quot;</span>)<span class="question-mark">?</span>.render(context)<span class="question-mark">?</span>))
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_post_by_message_id" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#686-716">source</a><h4 class="code-header">pub fn <a href="#method.list_post_by_message_id" class="fn">list_post_by_message_id</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    message_id: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Post.html" title="struct mailpot::models::Post">Post</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Find a post by its <code>Message-ID</code> email header.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.send_reply_with_list_template" class="method"><a class="srclink rightside" href="../../../src/mailpot/posts.rs.html#719-768">source</a><h4 class="code-header">pub fn <a href="#method.send_reply_with_list_template" class="fn">send_reply_with_list_template</a>&lt;'ctx, F: <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/function/trait.Fn.html" title="trait core::ops::function::Fn">Fn</a>() -&gt; <a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>&gt;(
    &amp;self,
    render_context: <a class="struct" href="../../posts/struct.TemplateRenderContext.html" title="struct mailpot::posts::TemplateRenderContext">TemplateRenderContext</a>&lt;'ctx, F&gt;,
    recipients: impl <a class="trait" href="https://doc.rust-lang.org/nightly/core/iter/traits/iterator/trait.Iterator.html" title="trait core::iter::traits::iterator::Iterator">Iterator</a>&lt;Item = <a class="enum" href="https://doc.rust-lang.org/nightly/alloc/borrow/enum.Cow.html" title="enum alloc::borrow::Cow">Cow</a>&lt;'ctx, Address&gt;&gt;
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Helper function to send a template reply.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-29"><a href="#scraped-examples-29">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[113,128],&quot;../../../src/mailpot/posts.rs.html#235-250&quot;,&quot;lines 235-250&quot;],[[137,152],&quot;../../../src/mailpot/posts.rs.html#259-274&quot;,&quot;lines 259-274&quot;],[[201,215],&quot;../../../src/mailpot/posts.rs.html#323-337&quot;,&quot;lines 323-337&quot;],[[235,249],&quot;../../../src/mailpot/posts.rs.html#357-371&quot;,&quot;lines 357-371&quot;],[[271,286],&quot;../../../src/mailpot/posts.rs.html#393-408&quot;,&quot;lines 393-408&quot;],[[293,309],&quot;../../../src/mailpot/posts.rs.html#415-431&quot;,&quot;lines 415-431&quot;],[[314,331],&quot;../../../src/mailpot/posts.rs.html#436-453&quot;,&quot;lines 436-453&quot;],[[339,352],&quot;../../../src/mailpot/posts.rs.html#461-474&quot;,&quot;lines 461-474&quot;],[[357,371],&quot;../../../src/mailpot/posts.rs.html#479-493&quot;,&quot;lines 479-493&quot;],[[377,389],&quot;../../../src/mailpot/posts.rs.html#499-511&quot;,&quot;lines 499-511&quot;],[[404,416],&quot;../../../src/mailpot/posts.rs.html#526-538&quot;,&quot;lines 526-538&quot;],[[421,434],&quot;../../../src/mailpot/posts.rs.html#543-556&quot;,&quot;lines 543-556&quot;],[[436,448],&quot;../../../src/mailpot/posts.rs.html#558-570&quot;,&quot;lines 558-570&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#235-250">lines 235-250</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.<span class="highlight focus">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Process a new mailing list request.
    </span><span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.<span class="highlight">send_reply_with_list_template</span>(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.insert_to_queue" class="method"><a class="srclink rightside" href="../../../src/mailpot/queue.rs.html#176-203">source</a><h4 class="code-header">pub fn <a href="#method.insert_to_queue" class="fn">insert_to_queue</a>(&amp;self, entry: <a class="struct" href="../../queue/struct.QueueEntry.html" title="struct mailpot::queue::QueueEntry">QueueEntry</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../queue/struct.QueueEntry.html" title="struct mailpot::queue::QueueEntry">QueueEntry</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Insert a received email into a queue.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-30"><a href="#scraped-examples-30">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[563,563],&quot;../../../src/mpot/main.rs.html#624&quot;,&quot;line 624&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#624">line 624</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.<span class="highlight focus">insert_to_queue</span>(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[3,9],&quot;../../../src/mailpot/posts.rs.html#94-100&quot;,&quot;lines 94-100&quot;],[[129,135],&quot;../../../src/mailpot/posts.rs.html#220-226&quot;,&quot;lines 220-226&quot;],[[185,191],&quot;../../../src/mailpot/posts.rs.html#276-282&quot;,&quot;lines 276-282&quot;],[[196,202],&quot;../../../src/mailpot/posts.rs.html#287-293&quot;,&quot;lines 287-293&quot;],[[668,674],&quot;../../../src/mailpot/posts.rs.html#759-765&quot;,&quot;lines 759-765&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#94-100">lines 94-100</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>result = <span class="self">self</span>.inner_post(env, raw, _dry_run);
        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = result {
            <span class="kw">return match </span><span class="self">self</span>.<span class="highlight focus">insert_to_queue</span>(QueueEntry::new(
                Queue::Error,
                <span class="prelude-val">None</span>,
                <span class="prelude-val">Some</span>(Cow::Borrowed(env)),
                raw,
                <span class="prelude-val">Some</span>(err.to_string()),
            )<span class="question-mark">?</span>) {
                <span class="prelude-val">Ok</span>(idx) =&gt; {
                    <span class="macro">log::info!</span>(
                        <span class="string">&quot;Inserted mail from {:?} into error_queue at index {}&quot;</span>,
                        env.from(),
                        idx
                    );
                    <span class="prelude-val">Err</span>(err)
                }
                <span class="prelude-val">Err</span>(err2) =&gt; {
                    <span class="macro">log::error!</span>(
                        <span class="string">&quot;Could not insert mail from {:?} into error_queue: {err2}&quot;</span>,
                        env.from(),
                    );

                    <span class="prelude-val">Err</span>(err.chain_err(|| err2))
                }
            };
        }
        result
    }

    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.list_subscriptions(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.<span class="highlight">insert_to_queue</span>(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.<span class="highlight">insert_to_queue</span>(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.<span class="highlight">insert_to_queue</span>(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Process a new mailing list request.
    </span><span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }

    <span class="doccomment">/// Fetch all year and month values for which at least one post exists in
    /// `yyyy-mm` format.
    </span><span class="kw">pub fn </span>months(<span class="kw-2">&amp;</span><span class="self">self</span>, list_pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;String&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT DISTINCT strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) FROM post \
             WHERE list = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>months_iter = stmt.query_map([list_pk], |row| {
            <span class="kw">let </span>val: String = row.get(<span class="number">0</span>)<span class="question-mark">?</span>;
            <span class="prelude-val">Ok</span>(val)
        })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>ret = <span class="macro">vec!</span>[];
        <span class="kw">for </span>month <span class="kw">in </span>months_iter {
            <span class="kw">let </span>month = month<span class="question-mark">?</span>;
            ret.push(month);
        }
        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Find a post by its `Message-ID` email header.
    </span><span class="kw">pub fn </span>list_post_by_message_id(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        message_id: <span class="kw-2">&amp;</span>str,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;DbVal&lt;Post&gt;&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;SELECT *, strftime(&#39;%Y-%m&#39;, CAST(timestamp AS INTEGER), &#39;unixepoch&#39;) AS month_year \
             FROM post WHERE list = ? AND message_id = ?;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>ret = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>list_pk, <span class="kw-2">&amp;</span>message_id], |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    Post {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        envelope_from: row.get(<span class="string">&quot;envelope_from&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        message_id: row.get(<span class="string">&quot;message_id&quot;</span>)<span class="question-mark">?</span>,
                        message: row.get(<span class="string">&quot;message&quot;</span>)<span class="question-mark">?</span>,
                        timestamp: row.get(<span class="string">&quot;timestamp&quot;</span>)<span class="question-mark">?</span>,
                        datetime: row.get(<span class="string">&quot;datetime&quot;</span>)<span class="question-mark">?</span>,
                        month_year: row.get(<span class="string">&quot;month_year&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .optional()<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(ret)
    }

    <span class="doccomment">/// Helper function to send a template reply.
    </span><span class="kw">pub fn </span>send_reply_with_list_template&lt;<span class="lifetime">&#39;ctx</span>, F: Fn() -&gt; Template&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        render_context: TemplateRenderContext&lt;<span class="lifetime">&#39;ctx</span>, F&gt;,
        recipients: <span class="kw">impl </span>Iterator&lt;Item = Cow&lt;<span class="lifetime">&#39;ctx</span>, melib::Address&gt;&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>TemplateRenderContext {
            template,
            default_fn,
            list,
            context,
            queue,
            comment,
        } = render_context;

        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;

        <span class="kw">let </span>templ = <span class="self">self
            </span>.fetch_template(template, <span class="prelude-val">Some</span>(list.pk))<span class="question-mark">?
            </span>.map(DbVal::into_inner)
            .or_else(|| default_fn.map(|f| f()))
            .ok_or_else(|| -&gt; <span class="kw">crate</span>::Error {
                <span class="macro">format!</span>(<span class="string">&quot;Template with name {template:?} was not found.&quot;</span>).into()
            })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>draft = templ.render(context)<span class="question-mark">?</span>;
        draft.headers.insert(
            melib::HeaderName::new_unchecked(<span class="string">&quot;From&quot;</span>),
            list.request_subaddr(),
        );
        <span class="kw">for </span>addr <span class="kw">in </span>recipients {
            <span class="kw">let </span><span class="kw-2">mut </span>draft = draft.clone();
            draft
                .headers
                .insert(melib::HeaderName::new_unchecked(<span class="string">&quot;To&quot;</span>), addr.to_string());
            list.insert_headers(
                <span class="kw-2">&amp;mut </span>draft,
                post_policy.as_deref(),
                subscription_policy.as_deref(),
            );
            <span class="self">self</span>.<span class="highlight">insert_to_queue</span>(QueueEntry::new(
                queue,
                <span class="prelude-val">Some</span>(list.pk),
                <span class="prelude-val">None</span>,
                draft.finalise()<span class="question-mark">?</span>.as_bytes(),
                <span class="prelude-val">Some</span>(comment.to_string()),
            )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.queue" class="method"><a class="srclink rightside" href="../../../src/mailpot/queue.rs.html#206-236">source</a><h4 class="code-header">pub fn <a href="#method.queue" class="fn">queue</a>(&amp;self, queue: <a class="enum" href="../../queue/enum.Queue.html" title="enum mailpot::queue::Queue">Queue</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../queue/struct.QueueEntry.html" title="struct mailpot::queue::QueueEntry">QueueEntry</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all queue entries.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-31"><a href="#scraped-examples-31">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[483,483],&quot;../../../src/mpot/main.rs.html#544&quot;,&quot;line 544&quot;],[[487,487],&quot;../../../src/mpot/main.rs.html#548&quot;,&quot;line 548&quot;],[[570,570],&quot;../../../src/mpot/main.rs.html#631&quot;,&quot;line 631&quot;],[[583,583],&quot;../../../src/mpot/main.rs.html#644&quot;,&quot;line 644&quot;],[[596,596],&quot;../../../src/mpot/main.rs.html#657&quot;,&quot;line 657&quot;],[[619,619],&quot;../../../src/mpot/main.rs.html#680&quot;,&quot;line 680&quot;],[[632,632],&quot;../../../src/mpot/main.rs.html#693&quot;,&quot;line 693&quot;],[[645,645],&quot;../../../src/mpot/main.rs.html#706&quot;,&quot;line 706&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#544">line 544</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.<span class="highlight focus">queue</span>(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.<span class="highlight">queue</span>(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.<span class="highlight">queue</span>(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.<span class="highlight">queue</span>(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.<span class="highlight">queue</span>(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.<span class="highlight">queue</span>(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.<span class="highlight">queue</span>(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.<span class="highlight">queue</span>(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.delete_from_queue" class="method"><a class="srclink rightside" href="../../../src/mailpot/queue.rs.html#239-285">source</a><h4 class="code-header">pub fn <a href="#method.delete_from_queue" class="fn">delete_from_queue</a>(
    &amp;self,
    queue: <a class="enum" href="../../queue/enum.Queue.html" title="enum mailpot::queue::Queue">Queue</a>,
    index: <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>&gt;
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../queue/struct.QueueEntry.html" title="struct mailpot::queue::QueueEntry">QueueEntry</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Delete queue entries returning the deleted values.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-32"><a href="#scraped-examples-32">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[493,493],&quot;../../../src/mpot/main.rs.html#554&quot;,&quot;line 554&quot;],[[608,608],&quot;../../../src/mpot/main.rs.html#669&quot;,&quot;line 669&quot;],[[657,657],&quot;../../../src/mpot/main.rs.html#718&quot;,&quot;line 718&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#554">line 554</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.<span class="highlight focus">delete_from_queue</span>(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.<span class="highlight">delete_from_queue</span>(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.<span class="highlight">delete_from_queue</span>(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.new_smtp_connection" class="method"><a class="srclink rightside" href="../../../src/mailpot/submission.rs.html#33-42">source</a><h4 class="code-header">pub fn <a href="#method.new_smtp_connection" class="fn">new_smtp_connection</a>(
    &amp;self
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/core/pin/struct.Pin.html" title="struct core::pin::Pin">Pin</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;dyn <a class="trait" href="https://doc.rust-lang.org/nightly/core/future/future/trait.Future.html" title="trait core::future::future::Future">Future</a>&lt;Output = <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;SmtpConnection&gt;&gt; + <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + 'static&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Return an SMTP connection handle if the database connection has one
configured.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-33"><a href="#scraped-examples-33">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[546,546],&quot;../../../src/mpot/main.rs.html#607&quot;,&quot;line 607&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#607">line 607</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.<span class="highlight focus">new_smtp_connection</span>()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_subscriptions" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#36-67">source</a><h4 class="code-header">pub fn <a href="#method.list_subscriptions" class="fn">list_subscriptions</a>(
    &amp;self,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all subscriptions of a mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-34"><a href="#scraped-examples-34">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[49,49],&quot;../../../src/mpot/main.rs.html#110&quot;,&quot;line 110&quot;],[[92,92],&quot;../../../src/mpot/main.rs.html#153&quot;,&quot;line 153&quot;],[[181,181],&quot;../../../src/mpot/main.rs.html#242&quot;,&quot;line 242&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#110">line 110</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.<span class="highlight focus">list_subscriptions</span>(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.<span class="highlight">list_subscriptions</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.<span class="highlight">list_subscriptions</span>(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[55,55],&quot;../../../src/mailpot/posts.rs.html#177&quot;,&quot;line 177&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#177">line 177</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">fn </span>inner_post(<span class="kw-2">&amp;</span><span class="self">self</span>, env: <span class="kw-2">&amp;</span>Envelope, raw: <span class="kw-2">&amp;</span>[u8], _dry_run: bool) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="macro">trace!</span>(<span class="string">&quot;Received envelope to post: {:#?}&quot;</span>, <span class="kw-2">&amp;</span>env);
        <span class="kw">let </span>tos = env.to().to_vec();
        <span class="kw">if </span>tos.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope To: field is empty!&quot;</span>.into());
        }
        <span class="kw">if </span>env.from().is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;Envelope From: field is empty!&quot;</span>.into());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>lists = <span class="self">self</span>.lists()<span class="question-mark">?</span>;
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;No active mailing lists found.&quot;</span>.into());
        }
        <span class="kw">let </span>prev_list_len = lists.len();
        <span class="kw">for </span>t <span class="kw">in </span><span class="kw-2">&amp;</span>tos {
            <span class="kw">if let </span><span class="prelude-val">Some</span>((addr, subaddr)) = t.subaddress(<span class="string">&quot;+&quot;</span>) {
                lists.retain(|list| {
                    <span class="kw">if </span>!addr.contains_address(<span class="kw-2">&amp;</span>list.address()) {
                        <span class="kw">return </span><span class="bool-val">true</span>;
                    }
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = ListRequest::try_from((subaddr.as_str(), env))
                        .and_then(|req| <span class="self">self</span>.request(list, req, env, raw))
                    {
                        <span class="macro">info!</span>(<span class="string">&quot;Processing request returned error: {}&quot;</span>, err);
                    }
                    <span class="bool-val">false
                </span>});
                <span class="kw">if </span>lists.len() != prev_list_len {
                    <span class="comment">// Was request, handled above.
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        lists.retain(|list| {
            <span class="macro">trace!</span>(
                <span class="string">&quot;Is post related to list {}? {}&quot;</span>,
                <span class="kw-2">&amp;</span>list,
                tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
            );

            tos.iter().any(|a| a.contains_address(<span class="kw-2">&amp;</span>list.address()))
        });
        <span class="kw">if </span>lists.is_empty() {
            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                <span class="string">&quot;No relevant mailing list found for these addresses: {:?}&quot;</span>,
                tos
            )
            .into());
        }

        <span class="macro">trace!</span>(<span class="string">&quot;Configuration is {:#?}&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.conf);
        <span class="kw">for </span><span class="kw-2">mut </span>list <span class="kw">in </span>lists {
            <span class="macro">trace!</span>(<span class="string">&quot;Examining list {}&quot;</span>, list.display_name());
            <span class="kw">let </span>filters = <span class="self">self</span>.list_filters(<span class="kw-2">&amp;</span>list);
            <span class="kw">let </span>subscriptions = <span class="self">self</span>.<span class="highlight focus">list_subscriptions</span>(list.pk)<span class="question-mark">?</span>;
            <span class="kw">let </span>owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
            <span class="macro">trace!</span>(<span class="string">&quot;List subscriptions {:#?}&quot;</span>, <span class="kw-2">&amp;</span>subscriptions);
            <span class="kw">let </span><span class="kw-2">mut </span>list_ctx = ListContext {
                post_policy: <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>,
                subscription_policy: <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>,
                list_owners: <span class="kw-2">&amp;</span>owners,
                subscriptions: <span class="kw-2">&amp;</span>subscriptions,
                scheduled_jobs: <span class="macro">vec!</span>[],
                filter_settings: <span class="self">self</span>.get_settings(list.pk)<span class="question-mark">?</span>,
                list: <span class="kw-2">&amp;mut </span>list,
            };
            <span class="kw">let </span><span class="kw-2">mut </span>post = PostEntry {
                message_id: env.message_id().clone(),
                from: env.from()[<span class="number">0</span>].clone(),
                bytes: raw.to_vec(),
                to: env.to().to_vec(),
                action: PostAction::Hold,
            };
            <span class="kw">let </span>result = filters
                .into_iter()
                .fold(<span class="prelude-val">Ok</span>((<span class="kw-2">&amp;mut </span>post, <span class="kw-2">&amp;mut </span>list_ctx)), |p, f| {
                    p.and_then(|(p, c)| f.feed(p, c))
                });
            <span class="macro">trace!</span>(<span class="string">&quot;result {:#?}&quot;</span>, result);

            <span class="kw">let </span>PostEntry { bytes, action, .. } = post;
            <span class="macro">trace!</span>(<span class="string">&quot;Action is {:#?}&quot;</span>, action);
            <span class="kw">let </span>post_env = melib::Envelope::from_bytes(<span class="kw-2">&amp;</span>bytes, <span class="prelude-val">None</span>)<span class="question-mark">?</span>;
            <span class="kw">match </span>action {
                PostAction::Accept =&gt; {
                    <span class="kw">let </span>_post_pk = <span class="self">self</span>.insert_post(list_ctx.list.pk, <span class="kw-2">&amp;</span>bytes, <span class="kw-2">&amp;</span>post_env)<span class="question-mark">?</span>;
                    <span class="macro">trace!</span>(<span class="string">&quot;post_pk is {:#?}&quot;</span>, _post_pk);
                    <span class="kw">for </span>job <span class="kw">in </span>list_ctx.scheduled_jobs.iter() {
                        <span class="macro">trace!</span>(<span class="string">&quot;job is {:#?}&quot;</span>, <span class="kw-2">&amp;</span>job);
                        <span class="kw">if let </span><span class="kw">crate</span>::mail::MailJob::Send { recipients } = job {
                            <span class="macro">trace!</span>(<span class="string">&quot;recipients: {:?}&quot;</span>, <span class="kw-2">&amp;</span>recipients);
                            <span class="kw">if </span>recipients.is_empty() {
                                <span class="macro">trace!</span>(<span class="string">&quot;list has no recipients&quot;</span>);
                            }
                            <span class="kw">for </span>recipient <span class="kw">in </span>recipients {
                                <span class="kw">let </span><span class="kw-2">mut </span>env = post_env.clone();
                                env.set_to(<span class="macro">melib::smallvec::smallvec!</span>[recipient.clone()]);
                                <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                                    Queue::Out,
                                    <span class="prelude-val">Some</span>(list.pk),
                                    <span class="prelude-val">Some</span>(Cow::Owned(env)),
                                    <span class="kw-2">&amp;</span>bytes,
                                    <span class="prelude-val">None</span>,
                                )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
                PostAction::Reject { reason } =&gt; {
                    <span class="macro">log::info!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was rejected.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Reject {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="comment">/* error handled by notifying submitter */
                    </span><span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Defer { reason } =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason);
                    <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list: <span class="kw-2">&amp;</span>list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;Your post to {} was deferred.&quot;</span>, list.id),
                                    details =&gt; <span class="kw-2">&amp;</span>reason,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Deferred,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="macro">format!</span>(<span class="string">&quot;PostAction::Defer {{ reason: {} }}&quot;</span>, reason)),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
                PostAction::Hold =&gt; {
                    <span class="macro">trace!</span>(<span class="string">&quot;PostAction::Hold&quot;</span>);
                    <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                        Queue::Hold,
                        <span class="prelude-val">Some</span>(list.pk),
                        <span class="prelude-val">Some</span>(Cow::Borrowed(<span class="kw-2">&amp;</span>post_env)),
                        <span class="kw-2">&amp;</span>bytes,
                        <span class="prelude-val">Some</span>(<span class="string">&quot;PostAction::Hold&quot;</span>.to_string()),
                    )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }
        }

        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.list_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#70-97">source</a><h4 class="code-header">pub fn <a href="#method.list_subscription" class="fn">list_subscription</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch mailing list subscription.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-35"><a href="#scraped-examples-35">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[51,51],&quot;../../../src/mailpot/subscriptions.rs.html#186&quot;,&quot;line 186&quot;],[[152,152],&quot;../../../src/mailpot/subscriptions.rs.html#287&quot;,&quot;line 287&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#186">line 186</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>add_subscription(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        <span class="kw-2">mut </span>new_val: ListSubscription,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListSubscription&gt;&gt; {
        new_val.list = list_pk;
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(
                <span class="string">&quot;INSERT INTO subscription(list, address, account, name, enabled, digest, \
                 verified, hide_address, receive_duplicates, receive_own_posts, \
                 receive_confirmation) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING *;&quot;</span>,
            )
            .unwrap();
        <span class="kw">let </span>val = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[
                <span class="kw-2">&amp;</span>new_val.list,
                <span class="kw-2">&amp;</span>new_val.address,
                <span class="kw-2">&amp;</span>new_val.account,
                <span class="kw-2">&amp;</span>new_val.name,
                <span class="kw-2">&amp;</span>new_val.enabled,
                <span class="kw-2">&amp;</span>new_val.digest,
                <span class="kw-2">&amp;</span>new_val.verified,
                <span class="kw-2">&amp;</span>new_val.hide_address,
                <span class="kw-2">&amp;</span>new_val.receive_duplicates,
                <span class="kw-2">&amp;</span>new_val.receive_own_posts,
                <span class="kw-2">&amp;</span>new_val.receive_confirmation
            ],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    ListSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        account: row.get(<span class="string">&quot;account&quot;</span>)<span class="question-mark">?</span>,
                        digest: row.get(<span class="string">&quot;digest&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                        verified: row.get(<span class="string">&quot;verified&quot;</span>)<span class="question-mark">?</span>,
                        hide_address: row.get(<span class="string">&quot;hide_address&quot;</span>)<span class="question-mark">?</span>,
                        receive_duplicates: row.get(<span class="string">&quot;receive_duplicates&quot;</span>)<span class="question-mark">?</span>,
                        receive_own_posts: row.get(<span class="string">&quot;receive_own_posts&quot;</span>)<span class="question-mark">?</span>,
                        receive_confirmation: row.get(<span class="string">&quot;receive_confirmation&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;
        <span class="macro">trace!</span>(<span class="string">&quot;add_subscription {:?}.&quot;</span>, <span class="kw-2">&amp;</span>val);
        <span class="comment">// table entry might be modified by triggers, so don&#39;t rely on RETURNING value.
        </span><span class="self">self</span>.<span class="highlight focus">list_subscription</span>(list_pk, val.pk())
    }

    <span class="doccomment">/// Create subscription candidate.
    </span><span class="kw">pub fn </span>add_candidate_subscription(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        <span class="kw-2">mut </span>new_val: ListSubscription,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListCandidateSubscription&gt;&gt; {
        new_val.list = list_pk;
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT INTO candidate_subscription(list, address, name, accepted) VALUES(?, ?, ?, ?) \
             RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>val = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>new_val.list, <span class="kw-2">&amp;</span>new_val.address, <span class="kw-2">&amp;</span>new_val.name, <span class="prelude-val">None</span>::&lt;i64&gt;,],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    ListCandidateSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        accepted: row.get(<span class="string">&quot;accepted&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;
        drop(stmt);

        <span class="macro">trace!</span>(<span class="string">&quot;add_candidate_subscription {:?}.&quot;</span>, <span class="kw-2">&amp;</span>val);
        <span class="comment">// table entry might be modified by triggers, so don&#39;t rely on RETURNING value.
        </span><span class="self">self</span>.candidate_subscription(val.pk())
    }

    <span class="doccomment">/// Fetch subscription candidate by primary key.
    </span><span class="kw">pub fn </span>candidate_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListCandidateSubscription&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM candidate_subscription WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>val = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>_pk: i64 = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="macro">debug_assert_eq!</span>(pk, _pk);
                <span class="prelude-val">Ok</span>(DbVal(
                    ListCandidateSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        accepted: row.get(<span class="string">&quot;accepted&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err)
                        .chain_err(|| NotFound(<span class="string">&quot;Candidate subscription with this pk not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(val)
    }

    <span class="doccomment">/// Accept subscription candidate.
    </span><span class="kw">pub fn </span>accept_candidate_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListSubscription&gt;&gt; {
        <span class="kw">let </span>val = <span class="self">self</span>.connection.query_row(
            <span class="string">&quot;INSERT INTO subscription(list, address, name, enabled, digest, verified, \
             hide_address, receive_duplicates, receive_own_posts, receive_confirmation) SELECT \
             list, address, name, 1, 0, 0, 0, 1, 1, 0 FROM candidate_subscription WHERE pk = ? \
             RETURNING *;&quot;</span>,
            <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    ListSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        account: row.get(<span class="string">&quot;account&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        digest: row.get(<span class="string">&quot;digest&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                        verified: row.get(<span class="string">&quot;verified&quot;</span>)<span class="question-mark">?</span>,
                        hide_address: row.get(<span class="string">&quot;hide_address&quot;</span>)<span class="question-mark">?</span>,
                        receive_duplicates: row.get(<span class="string">&quot;receive_duplicates&quot;</span>)<span class="question-mark">?</span>,
                        receive_own_posts: row.get(<span class="string">&quot;receive_own_posts&quot;</span>)<span class="question-mark">?</span>,
                        receive_confirmation: row.get(<span class="string">&quot;receive_confirmation&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;accept_candidate_subscription {:?}.&quot;</span>, <span class="kw-2">&amp;</span>val);
        <span class="comment">// table entry might be modified by triggers, so don&#39;t rely on RETURNING value.
        </span><span class="kw">let </span>ret = <span class="self">self</span>.<span class="highlight">list_subscription</span>(val.list, val.pk())<span class="question-mark">?</span>;

        <span class="comment">// assert that [ref:accept_candidate] trigger works.
        </span><span class="macro">debug_assert_eq!</span>(<span class="prelude-val">Some</span>(ret.pk), <span class="self">self</span>.candidate_subscription(pk)<span class="question-mark">?</span>.accepted);
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.list_subscription_by_address" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#100-132">source</a><h4 class="code-header">pub fn <a href="#method.list_subscription_by_address" class="fn">list_subscription_by_address</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    address: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch mailing list subscription by their address.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-36"><a href="#scraped-examples-36">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[2,2],&quot;../../../src/mailpot/subscriptions.rs.html#316&quot;,&quot;line 316&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#316">line 316</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>update_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: ListSubscriptionChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>pk = <span class="self">self
            </span>.<span class="highlight focus">list_subscription_by_address</span>(change_set.list, <span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">?
            </span>.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            ListSubscriptionChangeset {
                list: <span class="kw">_</span>,
                address: <span class="kw">_</span>,
                account: <span class="prelude-val">None</span>,
                name: <span class="prelude-val">None</span>,
                digest: <span class="prelude-val">None</span>,
                verified: <span class="prelude-val">None</span>,
                hide_address: <span class="prelude-val">None</span>,
                receive_duplicates: <span class="prelude-val">None</span>,
                receive_own_posts: <span class="prelude-val">None</span>,
                receive_confirmation: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>ListSubscriptionChangeset {
            list,
            address: <span class="kw">_</span>,
            name,
            account,
            digest,
            enabled,
            verified,
            hide_address,
            receive_duplicates,
            receive_own_posts,
            receive_confirmation,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_subscription)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE subscription SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE list = ? AND pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>list, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(account);
        <span class="macro">update!</span>(digest);
        <span class="macro">update!</span>(enabled);
        <span class="macro">update!</span>(verified);
        <span class="macro">update!</span>(hide_address);
        <span class="macro">update!</span>(receive_duplicates);
        <span class="macro">update!</span>(receive_own_posts);
        <span class="macro">update!</span>(receive_confirmation);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[50,50],&quot;../../../src/mailpot/posts.rs.html#353&quot;,&quot;line 353&quot;],[[301,301],&quot;../../../src/mailpot/posts.rs.html#604&quot;,&quot;line 604&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#353">line 353</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.<span class="highlight focus">list_subscription_by_address</span>(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.<span class="highlight">list_subscription_by_address</span>(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.add_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#135-187">source</a><h4 class="code-header">pub fn <a href="#method.add_subscription" class="fn">add_subscription</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    new_val: <a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Add subscription to mailing list.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-37"><a href="#scraped-examples-37">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[116,132],&quot;../../../src/mpot/main.rs.html#177-193&quot;,&quot;lines 177-193&quot;],[[413,413],&quot;../../../src/mpot/main.rs.html#474&quot;,&quot;line 474&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#177-193">lines 177-193</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.<span class="highlight focus">add_subscription</span>(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.<span class="highlight">add_subscription</span>(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[153,153],&quot;../../../src/mailpot/posts.rs.html#456&quot;,&quot;line 456&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#456">line 456</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.<span class="highlight focus">add_subscription</span>(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.add_candidate_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#190-221">source</a><h4 class="code-header">pub fn <a href="#method.add_candidate_subscription" class="fn">add_candidate_subscription</a>(
    &amp;self,
    list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>,
    new_val: <a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListCandidateSubscription.html" title="struct mailpot::models::ListCandidateSubscription">ListCandidateSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Create subscription candidate.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-38"><a href="#scraped-examples-38">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[87,87],&quot;../../../src/mailpot/posts.rs.html#390&quot;,&quot;line 390&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#390">line 390</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.<span class="highlight focus">add_candidate_subscription</span>(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.candidate_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#224-253">source</a><h4 class="code-header">pub fn <a href="#method.candidate_subscription" class="fn">candidate_subscription</a>(
    &amp;self,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListCandidateSubscription.html" title="struct mailpot::models::ListCandidateSubscription">ListCandidateSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch subscription candidate by primary key.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-39"><a href="#scraped-examples-39">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[30,30],&quot;../../../src/mailpot/subscriptions.rs.html#220&quot;,&quot;line 220&quot;],[[100,100],&quot;../../../src/mailpot/subscriptions.rs.html#290&quot;,&quot;line 290&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#220">line 220</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>add_candidate_subscription(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list_pk: i64,
        <span class="kw-2">mut </span>new_val: ListSubscription,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListCandidateSubscription&gt;&gt; {
        new_val.list = list_pk;
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self</span>.connection.prepare(
            <span class="string">&quot;INSERT INTO candidate_subscription(list, address, name, accepted) VALUES(?, ?, ?, ?) \
             RETURNING *;&quot;</span>,
        )<span class="question-mark">?</span>;
        <span class="kw">let </span>val = stmt.query_row(
            <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>new_val.list, <span class="kw-2">&amp;</span>new_val.address, <span class="kw-2">&amp;</span>new_val.name, <span class="prelude-val">None</span>::&lt;i64&gt;,],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    ListCandidateSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        accepted: row.get(<span class="string">&quot;accepted&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;
        drop(stmt);

        <span class="macro">trace!</span>(<span class="string">&quot;add_candidate_subscription {:?}.&quot;</span>, <span class="kw-2">&amp;</span>val);
        <span class="comment">// table entry might be modified by triggers, so don&#39;t rely on RETURNING value.
        </span><span class="self">self</span>.<span class="highlight focus">candidate_subscription</span>(val.pk())
    }

    <span class="doccomment">/// Fetch subscription candidate by primary key.
    </span><span class="kw">pub fn </span>candidate_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListCandidateSubscription&gt;&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>stmt = <span class="self">self
            </span>.connection
            .prepare(<span class="string">&quot;SELECT * FROM candidate_subscription WHERE pk = ?;&quot;</span>)<span class="question-mark">?</span>;
        <span class="kw">let </span>val = stmt
            .query_row(<span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk], |row| {
                <span class="kw">let </span>_pk: i64 = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="macro">debug_assert_eq!</span>(pk, _pk);
                <span class="prelude-val">Ok</span>(DbVal(
                    ListCandidateSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        accepted: row.get(<span class="string">&quot;accepted&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            })
            .map_err(|err| {
                <span class="kw">if </span><span class="macro">matches!</span>(err, rusqlite::Error::QueryReturnedNoRows) {
                    Error::from(err)
                        .chain_err(|| NotFound(<span class="string">&quot;Candidate subscription with this pk not found!&quot;</span>))
                } <span class="kw">else </span>{
                    err.into()
                }
            })<span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(val)
    }

    <span class="doccomment">/// Accept subscription candidate.
    </span><span class="kw">pub fn </span>accept_candidate_subscription(<span class="kw-2">&amp;</span><span class="self">self</span>, pk: i64) -&gt; <span class="prelude-ty">Result</span>&lt;DbVal&lt;ListSubscription&gt;&gt; {
        <span class="kw">let </span>val = <span class="self">self</span>.connection.query_row(
            <span class="string">&quot;INSERT INTO subscription(list, address, name, enabled, digest, verified, \
             hide_address, receive_duplicates, receive_own_posts, receive_confirmation) SELECT \
             list, address, name, 1, 0, 0, 0, 1, 1, 0 FROM candidate_subscription WHERE pk = ? \
             RETURNING *;&quot;</span>,
            <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span>pk],
            |row| {
                <span class="kw">let </span>pk = row.get(<span class="string">&quot;pk&quot;</span>)<span class="question-mark">?</span>;
                <span class="prelude-val">Ok</span>(DbVal(
                    ListSubscription {
                        pk,
                        list: row.get(<span class="string">&quot;list&quot;</span>)<span class="question-mark">?</span>,
                        address: row.get(<span class="string">&quot;address&quot;</span>)<span class="question-mark">?</span>,
                        account: row.get(<span class="string">&quot;account&quot;</span>)<span class="question-mark">?</span>,
                        name: row.get(<span class="string">&quot;name&quot;</span>)<span class="question-mark">?</span>,
                        digest: row.get(<span class="string">&quot;digest&quot;</span>)<span class="question-mark">?</span>,
                        enabled: row.get(<span class="string">&quot;enabled&quot;</span>)<span class="question-mark">?</span>,
                        verified: row.get(<span class="string">&quot;verified&quot;</span>)<span class="question-mark">?</span>,
                        hide_address: row.get(<span class="string">&quot;hide_address&quot;</span>)<span class="question-mark">?</span>,
                        receive_duplicates: row.get(<span class="string">&quot;receive_duplicates&quot;</span>)<span class="question-mark">?</span>,
                        receive_own_posts: row.get(<span class="string">&quot;receive_own_posts&quot;</span>)<span class="question-mark">?</span>,
                        receive_confirmation: row.get(<span class="string">&quot;receive_confirmation&quot;</span>)<span class="question-mark">?</span>,
                    },
                    pk,
                ))
            },
        )<span class="question-mark">?</span>;

        <span class="macro">trace!</span>(<span class="string">&quot;accept_candidate_subscription {:?}.&quot;</span>, <span class="kw-2">&amp;</span>val);
        <span class="comment">// table entry might be modified by triggers, so don&#39;t rely on RETURNING value.
        </span><span class="kw">let </span>ret = <span class="self">self</span>.list_subscription(val.list, val.pk())<span class="question-mark">?</span>;

        <span class="comment">// assert that [ref:accept_candidate] trigger works.
        </span><span class="macro">debug_assert_eq!</span>(<span class="prelude-val">Some</span>(ret.pk), <span class="self">self</span>.<span class="highlight">candidate_subscription</span>(pk)<span class="question-mark">?</span>.accepted);
        <span class="prelude-val">Ok</span>(ret)
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.accept_candidate_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#256-292">source</a><h4 class="code-header">pub fn <a href="#method.accept_candidate_subscription" class="fn">accept_candidate_subscription</a>(
    &amp;self,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Accept subscription candidate.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.remove_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#295-311">source</a><h4 class="code-header">pub fn <a href="#method.remove_subscription" class="fn">remove_subscription</a>(&amp;self, list_pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>, address: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Remove a subscription by their address.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-40"><a href="#scraped-examples-40">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[151,151],&quot;../../../src/mpot/main.rs.html#212&quot;,&quot;line 212&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#212">line 212</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.<span class="highlight focus">remove_subscription</span>(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[219,219],&quot;../../../src/mailpot/posts.rs.html#522&quot;,&quot;line 522&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#522">line 522</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.<span class="highlight focus">remove_subscription</span>(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.update_subscription" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#314-378">source</a><h4 class="code-header">pub fn <a href="#method.update_subscription" class="fn">update_subscription</a>(
    &amp;self,
    change_set: <a class="struct" href="../../models/changesets/struct.ListSubscriptionChangeset.html" title="struct mailpot::models::changesets::ListSubscriptionChangeset">ListSubscriptionChangeset</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Update a mailing list subscription.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-41"><a href="#scraped-examples-41">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[244,244],&quot;../../../src/mpot/main.rs.html#305&quot;,&quot;line 305&quot;],[[320,320],&quot;../../../src/mpot/main.rs.html#381&quot;,&quot;line 381&quot;],[[336,336],&quot;../../../src/mpot/main.rs.html#397&quot;,&quot;line 397&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#305">line 305</a>)</div><div class="code-wrapper"><button class="prev">&pr;</button> <button class="next">&sc;</button><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.<span class="highlight focus">update_subscription</span>(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.<span class="highlight">update_subscription</span>(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.<span class="highlight">update_subscription</span>(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.account" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#381-404">source</a><h4 class="code-header">pub fn <a href="#method.account" class="fn">account</a>(&amp;self, pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Account.html" title="struct mailpot::models::Account">Account</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch account by pk.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.account_by_address" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#407-429">source</a><h4 class="code-header">pub fn <a href="#method.account_by_address" class="fn">account_by_address</a>(
    &amp;self,
    address: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Account.html" title="struct mailpot::models::Account">Account</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch account by address.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-42"><a href="#scraped-examples-42">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[770,770],&quot;../../../src/mpot/main.rs.html#831&quot;,&quot;line 831&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#831">line 831</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.<span class="highlight focus">account_by_address</span>(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[1,1],&quot;../../../src/mailpot/subscriptions.rs.html#551&quot;,&quot;line 551&quot;]]"><div class="scraped-example-title">core/src/subscriptions.rs (<a href="../../../src/mailpot/subscriptions.rs.html#551">line 551</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>update_account(<span class="kw-2">&amp;</span><span class="self">self</span>, change_set: AccountChangeset) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span><span class="prelude-val">Some</span>(acc) = <span class="self">self</span>.<span class="highlight focus">account_by_address</span>(<span class="kw-2">&amp;</span>change_set.address)<span class="question-mark">? </span><span class="kw">else </span>{
            <span class="kw">return </span><span class="prelude-val">Err</span>(NotFound(<span class="string">&quot;account with this address not found!&quot;</span>).into());
        };
        <span class="kw">let </span>pk = acc.pk;
        <span class="kw">if </span><span class="macro">matches!</span>(
            change_set,
            AccountChangeset {
                address: <span class="kw">_</span>,
                name: <span class="prelude-val">None</span>,
                public_key: <span class="prelude-val">None</span>,
                password: <span class="prelude-val">None</span>,
                enabled: <span class="prelude-val">None</span>,
            }
        ) {
            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
        }

        <span class="kw">let </span>AccountChangeset {
            address: <span class="kw">_</span>,
            name,
            public_key,
            password,
            enabled,
        } = change_set;
        <span class="kw">let </span>tx = <span class="self">self</span>.savepoint(<span class="prelude-val">Some</span>(<span class="macro">stringify!</span>(update_account)))<span class="question-mark">?</span>;

        <span class="macro">macro_rules! </span>update {
            (<span class="macro-nonterminal">$field</span>:tt) =&gt; {{
                <span class="kw">if let </span><span class="prelude-val">Some</span>(<span class="macro-nonterminal">$field</span>) = <span class="macro-nonterminal">$field </span>{
                    tx.connection.execute(
                        <span class="macro">concat!</span>(
                            <span class="string">&quot;UPDATE account SET &quot;</span>,
                            <span class="macro">stringify!</span>(<span class="macro-nonterminal">$field</span>),
                            <span class="string">&quot; = ? WHERE pk = ?;&quot;
                        </span>),
                        <span class="macro">rusqlite::params!</span>[<span class="kw-2">&amp;</span><span class="macro-nonterminal">$field</span>, <span class="kw-2">&amp;</span>pk],
                    )<span class="question-mark">?</span>;
                }
            }};
        }
        <span class="macro">update!</span>(name);
        <span class="macro">update!</span>(public_key);
        <span class="macro">update!</span>(password);
        <span class="macro">update!</span>(enabled);

        tx.commit()<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div><div class="scraped-example " data-locs="[[[302,302],&quot;../../../src/mailpot/posts.rs.html#605&quot;,&quot;line 605&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#605">line 605</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.<span class="highlight focus">account_by_address</span>(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.account_subscriptions" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#432-463">source</a><h4 class="code-header">pub fn <a href="#method.account_subscriptions" class="fn">account_subscriptions</a>(
    &amp;self,
    pk: <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.ListSubscription.html" title="struct mailpot::models::ListSubscription">ListSubscription</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all subscriptions of an account by primary key.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-43"><a href="#scraped-examples-43">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[771,771],&quot;../../../src/mpot/main.rs.html#832&quot;,&quot;line 832&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#832">line 832</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.<span class="highlight focus">account_subscriptions</span>(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.accounts" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#466-491">source</a><h4 class="code-header">pub fn <a href="#method.accounts" class="fn">accounts</a>(&amp;self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Account.html" title="struct mailpot::models::Account">Account</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all accounts.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-44"><a href="#scraped-examples-44">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[760,760],&quot;../../../src/mpot/main.rs.html#821&quot;,&quot;line 821&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#821">line 821</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.<span class="highlight focus">accounts</span>()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.add_account" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#494-528">source</a><h4 class="code-header">pub fn <a href="#method.add_account" class="fn">add_account</a>(&amp;self, new_val: <a class="struct" href="../../models/struct.Account.html" title="struct mailpot::models::Account">Account</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../models/struct.Account.html" title="struct mailpot::models::Account">Account</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Add account.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-45"><a href="#scraped-examples-45">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[806,813],&quot;../../../src/mpot/main.rs.html#867-874&quot;,&quot;lines 867-874&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#867-874">lines 867-874</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.<span class="highlight focus">add_account</span>(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[315,322],&quot;../../../src/mailpot/posts.rs.html#618-625&quot;,&quot;lines 618-625&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#618-625">lines 618-625</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.update_account(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.<span class="highlight focus">add_account</span>(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.remove_account" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#531-547">source</a><h4 class="code-header">pub fn <a href="#method.remove_account" class="fn">remove_account</a>(&amp;self, address: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Remove an account by their address.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-46"><a href="#scraped-examples-46">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[831,831],&quot;../../../src/mpot/main.rs.html#892&quot;,&quot;line 892&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#892">line 892</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.<span class="highlight focus">remove_account</span>(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.update_account(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.update_account" class="method"><a class="srclink rightside" href="../../../src/mailpot/subscriptions.rs.html#550-598">source</a><h4 class="code-header">pub fn <a href="#method.update_account" class="fn">update_account</a>(&amp;self, change_set: <a class="struct" href="../../models/changesets/struct.AccountChangeset.html" title="struct mailpot::models::changesets::AccountChangeset">AccountChangeset</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Update an account.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-47"><a href="#scraped-examples-47">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[847,847],&quot;../../../src/mpot/main.rs.html#908&quot;,&quot;line 908&quot;]]"><div class="scraped-example-title">cli/src/main.rs (<a href="../../../src/mpot/main.rs.html#908">line 908</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button><span class="kw">fn </span>run_app(opt: Opt) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">if </span>opt.debug {
        <span class="macro">println!</span>(<span class="string">&quot;DEBUG: {:?}&quot;</span>, <span class="kw-2">&amp;</span>opt);
    }
    <span class="kw">if let </span>Command::SampleConfig { with_smtp } = opt.cmd {
        <span class="kw">let </span><span class="kw-2">mut </span>new = Configuration::new(<span class="string">&quot;/path/to/sqlite.db&quot;</span>);
        new.administrators.push(<span class="string">&quot;admin@example.com&quot;</span>.to_string());
        <span class="kw">if </span>with_smtp {
            new.send_mail = mailpot::SendMail::Smtp(SmtpServerConf {
                hostname: <span class="string">&quot;mail.example.com&quot;</span>.to_string(),
                port: <span class="number">587</span>,
                envelope_from: <span class="string">&quot;&quot;</span>.to_string(),
                auth: SmtpAuth::Auto {
                    username: <span class="string">&quot;user&quot;</span>.to_string(),
                    password: Password::Raw(<span class="string">&quot;hunter2&quot;</span>.to_string()),
                    auth_type: SmtpAuthType::default(),
                    require_auth: <span class="bool-val">true</span>,
                },
                security: SmtpSecurity::StartTLS {
                    danger_accept_invalid_certs: <span class="bool-val">false</span>,
                },
                extensions: Default::default(),
            });
        }
        <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, new.to_toml());
        <span class="kw">return </span><span class="prelude-val">Ok</span>(());
    };
    <span class="kw">let </span>config_path = <span class="kw">if let </span><span class="prelude-val">Some</span>(path) = opt.config.as_ref() {
        path.as_path()
    } <span class="kw">else </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>opt = Opt::command();
        opt.error(
            clap::error::ErrorKind::MissingRequiredArgument,
            <span class="string">&quot;--config is required for mailing list operations&quot;</span>,
        )
        .exit();
    };

    <span class="kw">let </span>config = Configuration::from_file(config_path)<span class="question-mark">?</span>;

    <span class="kw">use </span>Command::<span class="kw-2">*</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>db = Connection::open_or_create_db(config)<span class="question-mark">?</span>.trusted();
    <span class="kw">match </span>opt.cmd {
        SampleConfig { .. } =&gt; {}
        DumpDatabase =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>stdout = std::io::stdout();
            serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>lists)<span class="question-mark">?</span>;
            <span class="kw">for </span>l <span class="kw">in </span><span class="kw-2">&amp;</span>lists {
                serde_json::to_writer_pretty(<span class="kw-2">&amp;mut </span>stdout, <span class="kw-2">&amp;</span>db.list_subscriptions(l.pk)<span class="question-mark">?</span>)<span class="question-mark">?</span>;
            }
        }
        ListLists =&gt; {
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">if </span>lists.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No lists found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>l <span class="kw">in </span>lists {
                    <span class="macro">println!</span>(<span class="string">&quot;- {} {:?}&quot;</span>, l.id, l);
                    <span class="kw">let </span>list_owners = db.list_owners(l.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_post_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tPost policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = db.list_subscription_policy(l.pk)<span class="question-mark">? </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: {}&quot;</span>, s);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tSubscription policy: None&quot;</span>);
                    }
                    <span class="macro">println!</span>();
                }
            }
        }
        List { list_id, cmd } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">use </span>ListCommand::<span class="kw-2">*</span>;
            <span class="kw">match </span>cmd {
                Subscriptions =&gt; {
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscriptions of list {}&quot;</span>, list.id);
                        <span class="kw">for </span>l <span class="kw">in </span>subscriptions {
                            <span class="macro">println!</span>(<span class="string">&quot;- {}&quot;</span>, <span class="kw-2">&amp;</span>l);
                        }
                    }
                }
                AddSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    db.add_subscription(
                        list.pk,
                        ListSubscription {
                            pk: <span class="number">0</span>,
                            list: list.pk,
                            address,
                            account: <span class="prelude-val">None</span>,
                            name,
                            digest: digest.unwrap_or(<span class="bool-val">false</span>),
                            hide_address: hide_address.unwrap_or(<span class="bool-val">false</span>),
                            receive_confirmation: receive_confirmation.unwrap_or(<span class="bool-val">true</span>),
                            receive_duplicates: receive_duplicates.unwrap_or(<span class="bool-val">true</span>),
                            receive_own_posts: receive_own_posts.unwrap_or(<span class="bool-val">false</span>),
                            enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
                            verified: verified.unwrap_or(<span class="bool-val">false</span>),
                        },
                    )<span class="question-mark">?</span>;
                }
                RemoveSubscription { address } =&gt; {
                    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
                    <span class="kw">loop </span>{
                        <span class="macro">println!</span>(
                            <span class="string">&quot;Are you sure you want to remove subscription of {} from list {}? \
                             [Yy/n]&quot;</span>,
                            address, list
                        );
                        input.clear();
                        std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                        <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                            <span class="kw">break</span>;
                        } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                            <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                        }
                    }

                    db.remove_subscription(list.pk, <span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
                }
                Health =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} health:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no owners: you should add at least one.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="kw">for </span>owner <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\tList owner: {}.&quot;</span>, owner);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has post policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no post policy: you should add one.&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(p) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has subscription policy: {p}.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;\tList has no subscription policy: you should add one.&quot;</span>);
                    }
                }
                Info =&gt; {
                    <span class="macro">println!</span>(<span class="string">&quot;{} info:&quot;</span>, list);
                    <span class="kw">let </span>list_owners = db.list_owners(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>post_policy = db.list_post_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscription_policy = db.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">let </span>subscriptions = db.list_subscriptions(list.pk)<span class="question-mark">?</span>;
                    <span class="kw">if </span>subscriptions.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;No subscriptions.&quot;</span>);
                    } <span class="kw">else if </span>subscriptions.len() == <span class="number">1 </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;1 subscription.&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;{} subscriptions.&quot;</span>, subscriptions.len());
                    }
                    <span class="kw">if </span>list_owners.is_empty() {
                        <span class="macro">println!</span>(<span class="string">&quot;List owners: None&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;List owners:&quot;</span>);
                        <span class="kw">for </span>o <span class="kw">in </span>list_owners {
                            <span class="macro">println!</span>(<span class="string">&quot;\t- {}&quot;</span>, o);
                        }
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = post_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Post policy: None&quot;</span>);
                    }
                    <span class="kw">if let </span><span class="prelude-val">Some</span>(s) = subscription_policy {
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: {s}&quot;</span>);
                    } <span class="kw">else </span>{
                        <span class="macro">println!</span>(<span class="string">&quot;Subscription policy: None&quot;</span>);
                    }
                }
                UpdateSubscription {
                    address,
                    subscription_options:
                        SubscriptionOptions {
                            name,
                            digest,
                            hide_address,
                            receive_duplicates,
                            receive_own_posts,
                            receive_confirmation,
                            enabled,
                            verified,
                        },
                } =&gt; {
                    <span class="kw">let </span>name = <span class="kw">if </span>name
                        .as_ref()
                        .map(|s: <span class="kw-2">&amp;</span>String| s.is_empty())
                        .unwrap_or(<span class="bool-val">false</span>)
                    {
                        <span class="prelude-val">None
                    </span>} <span class="kw">else </span>{
                        <span class="prelude-val">Some</span>(name)
                    };
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name,
                        digest,
                        verified,
                        hide_address,
                        receive_duplicates,
                        receive_own_posts,
                        receive_confirmation,
                        enabled,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                AddPostPolicy {
                    announce_only,
                    subscription_only,
                    approval_needed,
                    open,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = PostPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        announce_only,
                        subscription_only,
                        approval_needed,
                        open,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_post_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemovePostPolicy { pk } =&gt; {
                    db.remove_list_post_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed policy with pk = {}&quot;</span>, pk);
                }
                AddSubscriptionPolicy {
                    send_confirmation,
                    open,
                    manual,
                    request,
                    custom,
                } =&gt; {
                    <span class="kw">let </span>policy = SubscriptionPolicy {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        send_confirmation,
                        open,
                        manual,
                        request,
                        custom,
                    };
                    <span class="kw">let </span>new_val = db.set_list_subscription_policy(policy)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new subscribe policy with pk = {}&quot;</span>, new_val.pk());
                }
                RemoveSubscriptionPolicy { pk } =&gt; {
                    db.remove_list_subscription_policy(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed subscribe policy with pk = {}&quot;</span>, pk);
                }
                AddListOwner { address, name } =&gt; {
                    <span class="kw">let </span>list_owner = ListOwner {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address,
                        name,
                    };
                    <span class="kw">let </span>new_val = db.add_list_owner(list_owner)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Added new list owner {}&quot;</span>, new_val);
                }
                RemoveListOwner { pk } =&gt; {
                    db.remove_list_owner(list.pk, pk)<span class="question-mark">?</span>;
                    <span class="macro">println!</span>(<span class="string">&quot;Removed list owner with pk = {}&quot;</span>, pk);
                }
                EnableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        verified: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">true</span>),
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                DisableSubscription { address } =&gt; {
                    <span class="kw">let </span>changeset = ListSubscriptionChangeset {
                        list: list.pk,
                        address,
                        account: <span class="prelude-val">None</span>,
                        name: <span class="prelude-val">None</span>,
                        digest: <span class="prelude-val">None</span>,
                        enabled: <span class="prelude-val">Some</span>(<span class="bool-val">false</span>),
                        verified: <span class="prelude-val">None</span>,
                        hide_address: <span class="prelude-val">None</span>,
                        receive_duplicates: <span class="prelude-val">None</span>,
                        receive_own_posts: <span class="prelude-val">None</span>,
                        receive_confirmation: <span class="prelude-val">None</span>,
                    };
                    db.update_subscription(changeset)<span class="question-mark">?</span>;
                }
                Update {
                    name,
                    id,
                    address,
                    description,
                    archive_url,
                    owner_local_part,
                    request_local_part,
                    verify,
                    hidden,
                    enabled,
                } =&gt; {
                    <span class="kw">let </span>description = <span class="macro">string_opts!</span>(description);
                    <span class="kw">let </span>archive_url = <span class="macro">string_opts!</span>(archive_url);
                    <span class="kw">let </span>owner_local_part = <span class="macro">string_opts!</span>(owner_local_part);
                    <span class="kw">let </span>request_local_part = <span class="macro">string_opts!</span>(request_local_part);
                    <span class="kw">let </span>changeset = MailingListChangeset {
                        pk: list.pk,
                        name,
                        id,
                        address,
                        description,
                        archive_url,
                        owner_local_part,
                        request_local_part,
                        verify,
                        hidden,
                        enabled,
                    };
                    db.update_list(changeset)<span class="question-mark">?</span>;
                }
                ImportMembers {
                    url,
                    username,
                    password,
                    list_id,
                    dry_run,
                    skip_owners,
                } =&gt; {
                    <span class="kw">let </span>conn = import::Mailman3Connection::new(<span class="kw-2">&amp;</span>url, <span class="kw-2">&amp;</span>username, <span class="kw-2">&amp;</span>password).unwrap();
                    <span class="kw">if </span>dry_run {
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="macro">println!</span>(<span class="string">&quot;{} result(s)&quot;</span>, entries.len());
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(
                                <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                    n
                                } <span class="kw">else </span>{
                                    <span class="string">&quot;&quot;
                                </span>},
                                <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                e.email()
                            );
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="macro">println!</span>(<span class="string">&quot;\nOwners: {} result(s)&quot;</span>, entries.len());
                            <span class="kw">for </span>e <span class="kw">in </span>entries {
                                <span class="macro">println!</span>(
                                    <span class="string">&quot;{}{}&lt;{}&gt;&quot;</span>,
                                    <span class="kw">if let </span><span class="prelude-val">Some</span>(n) = e.display_name() {
                                        n
                                    } <span class="kw">else </span>{
                                        <span class="string">&quot;&quot;
                                    </span>},
                                    <span class="kw">if </span>e.display_name().is_none() { <span class="string">&quot;&quot; </span>} <span class="kw">else </span>{ <span class="string">&quot; &quot; </span>},
                                    e.email()
                                );
                            }
                        }
                    } <span class="kw">else </span>{
                        <span class="kw">let </span>entries = conn.users(<span class="kw-2">&amp;</span>list_id).unwrap();
                        <span class="kw">let </span>tx = db.transaction(Default::default()).unwrap();
                        <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_subscription(list.pk)) {
                            tx.add_subscription(list.pk, sub)<span class="question-mark">?</span>;
                        }
                        <span class="kw">if </span>!skip_owners {
                            <span class="kw">let </span>entries = conn.owners(<span class="kw-2">&amp;</span>list_id).unwrap();
                            <span class="kw">for </span>sub <span class="kw">in </span>entries.into_iter().map(|e| e.into_owner(list.pk)) {
                                tx.add_list_owner(sub)<span class="question-mark">?</span>;
                            }
                        }
                        tx.commit()<span class="question-mark">?</span>;
                    }
                }
            }
        }
        CreateList {
            name,
            id,
            address,
            description,
            archive_url,
        } =&gt; {
            <span class="kw">let </span>new = db.create_list(MailingList {
                pk: <span class="number">0</span>,
                name,
                id,
                description,
                topics: <span class="macro">vec!</span>[],
                address,
                archive_url,
            })<span class="question-mark">?</span>;
            <span class="macro">log::trace!</span>(<span class="string">&quot;created new list {:#?}&quot;</span>, new);
            <span class="kw">if </span>!opt.quiet {
                <span class="macro">println!</span>(
                    <span class="string">&quot;Created new list {:?} with primary key {}&quot;</span>,
                    new.id,
                    new.pk()
                );
            }
        }
        Post { dry_run } =&gt; {
            <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;post dry_run{:?}&quot;</span>, dry_run);
            }

            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            std::io::stdin().read_to_string(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
            <span class="kw">match </span>Envelope::from_bytes(input.as_bytes(), <span class="prelude-val">None</span>) {
                <span class="prelude-val">Ok</span>(env) =&gt; {
                    <span class="kw">if </span>opt.debug {
                        <span class="macro">eprintln!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">&amp;</span>env);
                    }
                    tx.post(<span class="kw-2">&amp;</span>env, input.as_bytes(), dry_run)<span class="question-mark">?</span>;
                }
                <span class="prelude-val">Err</span>(err) <span class="kw">if </span>input.trim().is_empty() =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Empty input, abort.&quot;</span>);
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
                <span class="prelude-val">Err</span>(err) =&gt; {
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Could not parse message: {}&quot;</span>, err);
                    <span class="kw">let </span>p = tx.conf().save_message(input)<span class="question-mark">?</span>;
                    <span class="macro">eprintln!</span>(<span class="string">&quot;Message saved at {}&quot;</span>, p.display());
                    <span class="kw">return </span><span class="prelude-val">Err</span>(err.into());
                }
            }
            tx.commit()<span class="question-mark">?</span>;
        }
        FlushQueue { dry_run } =&gt; {
            <span class="kw">let </span>tx = db.transaction(TransactionBehavior::Exclusive).unwrap();
            <span class="kw">let </span>messages = <span class="kw">if </span>opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;flush-queue dry_run {:?}&quot;</span>, dry_run);
                tx.queue(mailpot::queue::Queue::Out)<span class="question-mark">?
                    </span>.into_iter()
                    .map(DbVal::into_inner)
                    .chain(
                        tx.queue(mailpot::queue::Queue::Deferred)<span class="question-mark">?
                            </span>.into_iter()
                            .map(DbVal::into_inner),
                    )
                    .collect()
            } <span class="kw">else </span>{
                tx.delete_from_queue(mailpot::queue::Queue::Out, <span class="macro">vec!</span>[])<span class="question-mark">?
            </span>};
            <span class="kw">if </span>opt.verbose &gt; <span class="number">0 </span>|| opt.debug {
                <span class="macro">println!</span>(<span class="string">&quot;Queue out has {} messages.&quot;</span>, messages.len());
            }

            <span class="kw">let </span><span class="kw-2">mut </span>failures = Vec::with_capacity(messages.len());

            <span class="kw">let </span>send_mail = tx.conf().send_mail.clone();
            <span class="kw">match </span>send_mail {
                mailpot::SendMail::ShellCommand(cmd) =&gt; {
                    <span class="kw">fn </span>submit(cmd: <span class="kw-2">&amp;</span>str, msg: <span class="kw-2">&amp;</span>QueueEntry) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
                        <span class="kw">let </span><span class="kw-2">mut </span>child = std::process::Command::new(<span class="string">&quot;sh&quot;</span>)
                            .arg(<span class="string">&quot;-c&quot;</span>)
                            .arg(cmd)
                            .stdout(Stdio::piped())
                            .stdin(Stdio::piped())
                            .stderr(Stdio::piped())
                            .spawn()
                            .context(<span class="string">&quot;sh command failed to start&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span><span class="kw-2">mut </span>stdin = child.stdin.take().context(<span class="string">&quot;Failed to open stdin&quot;</span>)<span class="question-mark">?</span>;

                        <span class="kw">let </span>builder = std::thread::Builder::new();

                        std::thread::scope(|s| {
                            <span class="kw">let </span>handler = builder
                                .spawn_scoped(s, <span class="kw">move </span>|| {
                                    stdin
                                        .write_all(<span class="kw-2">&amp;</span>msg.message)
                                        .expect(<span class="string">&quot;Failed to write to stdin&quot;</span>);
                                })
                                .context(
                                    <span class="string">&quot;Could not spawn IPC communication thread for SMTP \
                                     ShellCommand process&quot;</span>,
                                )<span class="question-mark">?</span>;

                            handler.join().map_err(|<span class="kw">_</span>| {
                                ErrorKind::External(<span class="macro">mailpot::anyhow::anyhow!</span>(
                                    <span class="string">&quot;Could not join with IPC communication thread for SMTP \
                                     ShellCommand process&quot;
                                </span>))
                            })<span class="question-mark">?</span>;
                            <span class="prelude-val">Ok</span>::&lt;(), Error&gt;(())
                        })<span class="question-mark">?</span>;
                        <span class="prelude-val">Ok</span>(())
                    }
                    <span class="kw">for </span>msg <span class="kw">in </span>messages {
                        <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = submit(<span class="kw-2">&amp;</span>cmd, <span class="kw-2">&amp;</span>msg) {
                            failures.push((err, msg));
                        }
                    }
                }
                mailpot::SendMail::Smtp(<span class="kw">_</span>) =&gt; {
                    <span class="kw">let </span>conn_future = tx.new_smtp_connection()<span class="question-mark">?</span>;
                    failures = smol::future::block_on(smol::spawn(<span class="kw">async move </span>{
                        <span class="kw">let </span><span class="kw-2">mut </span>conn = conn_future.<span class="kw">await</span><span class="question-mark">?</span>;
                        <span class="kw">for </span>msg <span class="kw">in </span>messages {
                            <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = Connection::submit(<span class="kw-2">&amp;mut </span>conn, <span class="kw-2">&amp;</span>msg, dry_run).<span class="kw">await </span>{
                                failures.push((err, msg));
                            }
                        }
                        <span class="prelude-val">Ok</span>::&lt;<span class="kw">_</span>, Error&gt;(failures)
                    }))<span class="question-mark">?</span>;
                }
            }

            <span class="kw">for </span>(err, <span class="kw-2">mut </span>msg) <span class="kw">in </span>failures {
                <span class="macro">log::error!</span>(<span class="string">&quot;Message {msg:?} failed with: {err}. Inserting to Deferred queue.&quot;</span>);

                msg.queue = mailpot::queue::Queue::Deferred;
                tx.insert_to_queue(msg)<span class="question-mark">?</span>;
            }

            tx.commit()<span class="question-mark">?</span>;
        }
        ErrorQueue { cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>errors {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>errors = db.queue(mailpot::queue::Queue::Error)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    errors.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>errors.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Error queue is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting error queue elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(mailpot::queue::Queue::Error, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>errors {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        Queue { queue, cmd } =&gt; <span class="kw">match </span>cmd {
            QueueCommand::List =&gt; {
                <span class="kw">let </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(
                            <span class="string">&quot;- {} {} {} {} {}&quot;</span>,
                            e.pk, e.datetime, e.from_address, e.to_addresses, e.subject
                        );
                    }
                }
            }
            QueueCommand::Print { index } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>e <span class="kw">in </span>entries {
                        <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                    }
                }
            }
            QueueCommand::Delete { index, quiet } =&gt; {
                <span class="kw">let </span><span class="kw-2">mut </span>entries = db.queue(queue)<span class="question-mark">?</span>;
                <span class="kw">if </span>!index.is_empty() {
                    entries.retain(|el| index.contains(<span class="kw-2">&amp;</span>el.pk()));
                }
                <span class="kw">if </span>entries.is_empty() {
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Queue {queue} is empty.&quot;</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="kw">if </span>!quiet {
                        <span class="macro">println!</span>(<span class="string">&quot;Deleting queue {queue} elements {:?}&quot;</span>, <span class="kw-2">&amp;</span>index);
                    }
                    db.delete_from_queue(queue, index)<span class="question-mark">?</span>;
                    <span class="kw">if </span>!quiet {
                        <span class="kw">for </span>e <span class="kw">in </span>entries {
                            <span class="macro">println!</span>(<span class="string">&quot;{e:?}&quot;</span>);
                        }
                    }
                }
            }
        },
        ImportMaildir {
            list_id,
            <span class="kw-2">mut </span>maildir_path,
        } =&gt; {
            <span class="kw">let </span>list = <span class="kw">match </span><span class="macro">list!</span>(db, list_id) {
                <span class="prelude-val">Some</span>(v) =&gt; v,
                <span class="prelude-val">None </span>=&gt; {
                    <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;No list with id or pk {} was found&quot;</span>, list_id).into());
                }
            };
            <span class="kw">if </span>!maildir_path.is_absolute() {
                maildir_path = std::env::current_dir()
                    .expect(<span class="string">&quot;could not detect current directory&quot;</span>)
                    .join(<span class="kw-2">&amp;</span>maildir_path);
            }

            <span class="kw">fn </span>get_file_hash(file: <span class="kw-2">&amp;</span>std::path::Path) -&gt; EnvelopeHash {
                <span class="kw">let </span><span class="kw-2">mut </span>hasher = DefaultHasher::default();
                file.hash(<span class="kw-2">&amp;mut </span>hasher);
                EnvelopeHash(hasher.finish())
            }
            <span class="kw">let </span><span class="kw-2">mut </span>buf = Vec::with_capacity(<span class="number">4096</span>);
            <span class="kw">let </span>files =
                melib::backends::maildir::MaildirType::list_mail_in_maildir_fs(maildir_path, <span class="bool-val">true</span>)<span class="question-mark">?</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>ctr = <span class="number">0</span>;
            <span class="kw">for </span>file <span class="kw">in </span>files {
                <span class="kw">let </span>hash = get_file_hash(<span class="kw-2">&amp;</span>file);
                <span class="kw">let </span><span class="kw-2">mut </span>reader = std::io::BufReader::new(std::fs::File::open(<span class="kw-2">&amp;</span>file)<span class="question-mark">?</span>);
                buf.clear();
                reader.read_to_end(<span class="kw-2">&amp;mut </span>buf)<span class="question-mark">?</span>;
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(<span class="kw-2">mut </span>env) = Envelope::from_bytes(buf.as_slice(), <span class="prelude-val">Some</span>(file.flags())) {
                    env.set_hash(hash);
                    db.insert_post(list.pk, <span class="kw-2">&amp;</span>buf, <span class="kw-2">&amp;</span>env)<span class="question-mark">?</span>;
                    ctr += <span class="number">1</span>;
                }
            }
            <span class="macro">println!</span>(<span class="string">&quot;Inserted {} posts to {}.&quot;</span>, ctr, list_id);
        }
        UpdatePostfixConfig {
            master_cf,
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            pfconf.save_maps(db.conf())<span class="question-mark">?</span>;
            pfconf.save_master_cf_entry(db.conf(), config_path, master_cf.as_deref())<span class="question-mark">?</span>;
        }
        PrintPostfixConfig {
            config:
                PostfixConfig {
                    user,
                    group,
                    binary_path,
                    process_limit,
                    map_output_path,
                    transport_name,
                },
        } =&gt; {
            <span class="kw">let </span>pfconf = mailpot::postfix::PostfixConfiguration {
                user: user.into(),
                group: group.map(Into::into),
                binary_path,
                process_limit,
                map_output_path,
                transport_name: transport_name.map(std::borrow::Cow::from),
            };
            <span class="kw">let </span>lists = db.lists()<span class="question-mark">?</span>;
            <span class="kw">let </span>lists_post_policies = lists
                .into_iter()
                .map(|l| {
                    <span class="kw">let </span>pk = l.pk;
                    <span class="prelude-val">Ok</span>((l, db.list_post_policy(pk)<span class="question-mark">?</span>))
                })
                .collect::&lt;<span class="prelude-ty">Result</span>&lt;Vec&lt;(DbVal&lt;MailingList&gt;, <span class="prelude-ty">Option</span>&lt;DbVal&lt;PostPolicy&gt;&gt;)&gt;&gt;&gt;()<span class="question-mark">?</span>;
            <span class="kw">let </span>maps = pfconf.generate_maps(<span class="kw-2">&amp;</span>lists_post_policies);
            <span class="kw">let </span>mastercf = pfconf.generate_master_cf_entry(db.conf(), config_path);

            <span class="macro">println!</span>(<span class="string">&quot;{maps}\n\n{mastercf}\n&quot;</span>);
        }
        Accounts =&gt; {
            <span class="kw">let </span>accounts = db.accounts()<span class="question-mark">?</span>;
            <span class="kw">if </span>accounts.is_empty() {
                <span class="macro">println!</span>(<span class="string">&quot;No accounts found.&quot;</span>);
            } <span class="kw">else </span>{
                <span class="kw">for </span>a <span class="kw">in </span>accounts {
                    <span class="macro">println!</span>(<span class="string">&quot;- {:?}&quot;</span>, a);
                }
            }
        }
        AccountInfo { address } =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Some</span>(acc) = db.account_by_address(<span class="kw-2">&amp;</span>address)<span class="question-mark">? </span>{
                <span class="kw">let </span>subs = db.account_subscriptions(acc.pk())<span class="question-mark">?</span>;
                <span class="kw">if </span>subs.is_empty() {
                    <span class="macro">println!</span>(<span class="string">&quot;No subscriptions found.&quot;</span>);
                } <span class="kw">else </span>{
                    <span class="kw">for </span>s <span class="kw">in </span>subs {
                        <span class="kw">let </span>list = db
                            .list(s.list)
                            .unwrap_or_else(|err| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}\n\n{err}&quot;</span>,
                                    s.list, s
                                )
                            })
                            .unwrap_or_else(|| {
                                <span class="macro">panic!</span>(
                                    <span class="string">&quot;Found subscription with list_pk = {} but no such list \
                                     exists.\nListSubscription = {:?}&quot;</span>,
                                    s.list, s
                                )
                            });
                        <span class="macro">println!</span>(<span class="string">&quot;- {:?} {}&quot;</span>, s, list);
                    }
                }
            } <span class="kw">else </span>{
                <span class="macro">println!</span>(<span class="string">&quot;account with this address not found!&quot;</span>);
            };
        }
        AddAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            db.add_account(Account {
                pk: <span class="number">0</span>,
                name,
                address,
                public_key,
                password,
                enabled: enabled.unwrap_or(<span class="bool-val">true</span>),
            })<span class="question-mark">?</span>;
        }
        RemoveAccount { address } =&gt; {
            <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
            <span class="kw">loop </span>{
                <span class="macro">println!</span>(
                    <span class="string">&quot;Are you sure you want to remove account with address {}? [Yy/n]&quot;</span>,
                    address
                );
                input.clear();
                std::io::stdin().read_line(<span class="kw-2">&amp;mut </span>input)<span class="question-mark">?</span>;
                <span class="kw">if </span>input.trim() == <span class="string">&quot;Y&quot; </span>|| input.trim() == <span class="string">&quot;y&quot; </span>|| input.trim() == <span class="string">&quot;&quot; </span>{
                    <span class="kw">break</span>;
                } <span class="kw">else if </span>input.trim() == <span class="string">&quot;n&quot; </span>{
                    <span class="kw">return </span><span class="prelude-val">Ok</span>(());
                }
            }

            db.remove_account(<span class="kw-2">&amp;</span>address)<span class="question-mark">?</span>;
        }
        UpdateAccount {
            address,
            password,
            name,
            public_key,
            enabled,
        } =&gt; {
            <span class="kw">let </span>changeset = AccountChangeset {
                address,
                name,
                public_key,
                password,
                enabled,
            };
            db.<span class="highlight focus">update_account</span>(changeset)<span class="question-mark">?</span>;
        }
        Repair {
            fix,
            all,
            <span class="kw-2">mut </span>datetime_header_value,
            <span class="kw-2">mut </span>remove_empty_accounts,
            <span class="kw-2">mut </span>remove_accepted_subscription_requests,
            <span class="kw-2">mut </span>warn_list_no_owner,
        } =&gt; {
            <span class="kw">type </span>LintFn =
                <span class="kw">fn</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;_ </span><span class="kw-2">mut </span>mailpot::Connection, bool) -&gt; std::result::Result&lt;(), mailpot::Error&gt;;
            <span class="kw">let </span>dry_run = !fix;
            <span class="kw">if </span>all {
                datetime_header_value = <span class="bool-val">true</span>;
                remove_empty_accounts = <span class="bool-val">true</span>;
                remove_accepted_subscription_requests = <span class="bool-val">true</span>;
                warn_list_no_owner = <span class="bool-val">true</span>;
            }

            <span class="kw">if </span>!(datetime_header_value
                | remove_empty_accounts
                | remove_accepted_subscription_requests
                | warn_list_no_owner)
            {
                <span class="kw">return </span><span class="prelude-val">Err</span>(
                    <span class="string">&quot;No lints selected: specify them with flag arguments. See --help&quot;</span>.into(),
                );
            }

            <span class="kw">if </span>dry_run {
                <span class="macro">println!</span>(<span class="string">&quot;running without making modifications (dry run)&quot;</span>);
            }

            <span class="kw">for </span>(flag, lint_fn) <span class="kw">in </span>[
                (datetime_header_value, datetime_header_value_lint <span class="kw">as </span>LintFn),
                (remove_empty_accounts, remove_empty_accounts_lint <span class="kw">as _</span>),
                (
                    remove_accepted_subscription_requests,
                    remove_accepted_subscription_requests_lint <span class="kw">as _</span>,
                ),
                (warn_list_no_owner, warn_list_no_owner_lint <span class="kw">as _</span>),
            ] {
                <span class="kw">if </span>flag {
                    lint_fn(<span class="kw-2">&amp;mut </span>db, dry_run)<span class="question-mark">?</span>;
                }
            }
        }
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div></div></div><details class="toggle more-examples-toggle"><summary class="hideme"><span>More examples</span></summary><div class="hide-more">Hide additional examples</div><div class="more-scraped-examples"><div class="toggle-line"><div class="toggle-line-inner"></div></div><div class="scraped-example " data-locs="[[[311,311],&quot;../../../src/mailpot/posts.rs.html#614&quot;,&quot;line 614&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#614">line 614</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        list: <span class="kw-2">&amp;</span>DbVal&lt;MailingList&gt;,
        request: ListRequest,
        env: <span class="kw-2">&amp;</span>Envelope,
        raw: <span class="kw-2">&amp;</span>[u8],
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">match </span>request {
            ListRequest::Help =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;help action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;
                <span class="kw">let </span>subject = <span class="macro">format!</span>(<span class="string">&quot;Help for {}&quot;</span>, list.name);
                <span class="kw">let </span>details = list
                    .generate_help_email(post_policy.as_deref(), subscription_policy.as_deref());
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="self">self</span>.send_reply_with_list_template(
                        TemplateRenderContext {
                            template: Template::GENERIC_HELP,
                            default_fn: <span class="prelude-val">Some</span>(Template::default_generic_help),
                            list,
                            context: <span class="macro">minijinja::context! </span>{
                                list =&gt; <span class="kw-2">&amp;</span>list,
                                subject =&gt; <span class="kw-2">&amp;</span>subject,
                                details =&gt; <span class="kw-2">&amp;</span>details,
                            },
                            queue: Queue::Out,
                            comment: <span class="string">&quot;Help request&quot;</span>.into(),
                        },
                        std::iter::once(Cow::Borrowed(f)),
                    )<span class="question-mark">?</span>;
                }
            }
            ListRequest::Subscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;subscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">let </span>approval_needed = post_policy
                    .as_ref()
                    .map(|p| p.approval_needed)
                    .unwrap_or(<span class="bool-val">false</span>);
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if </span><span class="self">self
                        </span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from)
                        .is_ok()
                    {
                        <span class="comment">/* send error notice to e-mail sender */
                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    subject =&gt; <span class="macro">format!</span>(<span class="string">&quot;You are already subscribed to {}.&quot;</span>, list.id),
                                    details =&gt; <span class="string">&quot;No action has been taken since you are already subscribed to the list.&quot;</span>,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Address {} is already subscribed to list {}&quot;</span>, f, list.id).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                        <span class="kw">continue</span>;
                    }

                    <span class="kw">let </span>subscription = ListSubscription {
                        pk: <span class="number">0</span>,
                        list: list.pk,
                        address: f.get_email(),
                        account: <span class="prelude-val">None</span>,
                        name: f.get_display_name(),
                        digest: <span class="bool-val">false</span>,
                        hide_address: <span class="bool-val">false</span>,
                        receive_duplicates: <span class="bool-val">true</span>,
                        receive_own_posts: <span class="bool-val">false</span>,
                        receive_confirmation: <span class="bool-val">true</span>,
                        enabled: !approval_needed,
                        verified: <span class="bool-val">true</span>,
                    };
                    <span class="kw">if </span>approval_needed {
                        <span class="kw">match </span><span class="self">self</span>.add_candidate_subscription(list.pk, subscription) {
                            <span class="prelude-val">Ok</span>(v) =&gt; {
                                <span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER,
                                        default_fn: <span class="prelude-val">Some</span>(
                                            Template::default_subscription_request_owner,
                                        ),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            candidate =&gt; <span class="kw-2">&amp;</span>v,
                                        },
                                        queue: Queue::Out,
                                        comment: Template::SUBSCRIPTION_REQUEST_NOTICE_OWNER.into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">Err</span>(err) =&gt; {
                                <span class="macro">log::error!</span>(
                                    <span class="string">&quot;Could not create candidate subscription for {f:?}: {err}&quot;
                                </span>);
                                <span class="comment">/* send error notice to e-mail sender */
                                </span><span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::GENERIC_FAILURE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    std::iter::once(Cow::Borrowed(f)),
                                )<span class="question-mark">?</span>;

                                <span class="comment">/* send error details to list owners */

                                </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                                <span class="self">self</span>.send_reply_with_list_template(
                                    TemplateRenderContext {
                                        template: Template::ADMIN_NOTICE,
                                        default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                        list,
                                        context: <span class="macro">minijinja::context! </span>{
                                            list =&gt; <span class="kw-2">&amp;</span>list,
                                            details =&gt; err.to_string(),
                                        },
                                        queue: Queue::Out,
                                        comment: <span class="macro">format!</span>(
                                            <span class="string">&quot;Could not create candidate subscription for {f:?}: \
                                             {err}&quot;
                                        </span>)
                                        .into(),
                                    },
                                    list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                                )<span class="question-mark">?</span>;
                            }
                        }
                    } <span class="kw">else if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.add_subscription(list.pk, subscription) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>);

                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not create subscription for {f:?}: {err}&quot;</span>)
                                    .into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="macro">log::trace!</span>(
                            <span class="string">&quot;Added subscription to list {list:?} for address {f:?}, sending \
                             confirmation.&quot;
                        </span>);
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::SUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_subscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::SUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Unsubscribe =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unsubscribe action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">if let </span><span class="prelude-val">Err</span>(err) = <span class="self">self</span>.remove_subscription(list.pk, <span class="kw-2">&amp;</span>f.get_email()) {
                        <span class="macro">log::error!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>);
                        <span class="comment">/* send error notice to e-mail sender */

                        </span><span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::GENERIC_FAILURE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_generic_failure),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;

                        <span class="comment">/* send error details to list owners */

                        </span><span class="kw">let </span>list_owners = <span class="self">self</span>.list_owners(list.pk)<span class="question-mark">?</span>;
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::ADMIN_NOTICE,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_admin_notice),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                    details =&gt; err.to_string(),
                                },
                                queue: Queue::Out,
                                comment: <span class="macro">format!</span>(<span class="string">&quot;Could not unsubscribe {f:?}: {err}&quot;</span>).into(),
                            },
                            list_owners.iter().map(|owner| Cow::Owned(owner.address())),
                        )<span class="question-mark">?</span>;
                    } <span class="kw">else </span>{
                        <span class="self">self</span>.send_reply_with_list_template(
                            TemplateRenderContext {
                                template: Template::UNSUBSCRIPTION_CONFIRMATION,
                                default_fn: <span class="prelude-val">Some</span>(Template::default_unsubscription_confirmation),
                                list,
                                context: <span class="macro">minijinja::context! </span>{
                                    list =&gt; <span class="kw-2">&amp;</span>list,
                                },
                                queue: Queue::Out,
                                comment: Template::UNSUBSCRIPTION_CONFIRMATION.into(),
                            },
                            std::iter::once(Cow::Borrowed(f)),
                        )<span class="question-mark">?</span>;
                    }
                }
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req == <span class="string">&quot;owner&quot; </span>=&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-owner mail action for addresses {:?} in list {}&quot;</span>,
                    env.from(),
                    list
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;list-owner emails are not implemented yet.&quot;</span>.into());
                <span class="comment">//FIXME: mail to list-owner
                /*
                for _owner in self.list_owners(list.pk)? {
                        self.insert_to_queue(
                            Queue::Out,
                            Some(list.pk),
                            None,
                            draft.finalise()?.as_bytes(),
                            &quot;list-owner-forward&quot;.to_string(),
                        )?;
                }
                */
            </span>}
            ListRequest::Other(<span class="kw-2">ref </span>req) <span class="kw">if </span>req.trim().eq_ignore_ascii_case(<span class="string">&quot;password&quot;</span>) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;list-request password set action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">let </span>body = env.body_bytes(raw);
                <span class="kw">let </span>password = body.text();
                <span class="comment">// TODO: validate SSH public key with `ssh-keygen`.
                </span><span class="kw">for </span>f <span class="kw">in </span>env.from() {
                    <span class="kw">let </span>email_from = f.get_email();
                    <span class="kw">if let </span><span class="prelude-val">Ok</span>(sub) = <span class="self">self</span>.list_subscription_by_address(list.pk, <span class="kw-2">&amp;</span>email_from) {
                        <span class="kw">match </span><span class="self">self</span>.account_by_address(<span class="kw-2">&amp;</span>email_from)<span class="question-mark">? </span>{
                            <span class="prelude-val">Some</span>(_acc) =&gt; {
                                <span class="kw">let </span>changeset = AccountChangeset {
                                    address: email_from.clone(),
                                    name: <span class="prelude-val">None</span>,
                                    public_key: <span class="prelude-val">None</span>,
                                    password: <span class="prelude-val">Some</span>(password.clone()),
                                    enabled: <span class="prelude-val">None</span>,
                                };
                                <span class="self">self</span>.<span class="highlight focus">update_account</span>(changeset)<span class="question-mark">?</span>;
                            }
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="comment">// Create new account.
                                </span><span class="self">self</span>.add_account(Account {
                                    pk: <span class="number">0</span>,
                                    name: sub.name.clone(),
                                    address: sub.address.clone(),
                                    public_key: <span class="prelude-val">None</span>,
                                    password: password.clone(),
                                    enabled: sub.enabled,
                                })<span class="question-mark">?</span>;
                            }
                        }
                    }
                }
            }
            ListRequest::RetrieveMessages(<span class="kw-2">ref </span>message_ids) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve messages {message_ids:?} action for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::RetrieveArchive(<span class="kw-2">ref </span>from, <span class="kw-2">ref </span>to) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;retrieve archive action from {from:?} to {to:?} for addresses {:?} in list \
                     {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;message retrievals are not implemented yet.&quot;</span>.into());
            }
            ListRequest::ChangeSetting(<span class="kw-2">ref </span>setting, <span class="kw-2">ref </span>toggle) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;change setting {setting}, request with value {toggle:?} for addresses {:?} \
                     in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="string">&quot;setting digest options via e-mail is not implemented yet.&quot;</span>.into());
            }
            ListRequest::Other(<span class="kw-2">ref </span>req) =&gt; {
                <span class="macro">trace!</span>(
                    <span class="string">&quot;unknown request action {req} for addresses {:?} in list {list}&quot;</span>,
                    env.from(),
                );
                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Unknown request {req}.&quot;</span>).into());
            }
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details></div></details><details class="toggle method-toggle" open><summary><section id="method.fetch_templates" class="method"><a class="srclink rightside" href="../../../src/mailpot/templates.rs.html#216-241">source</a><h4 class="code-header">pub fn <a href="#method.fetch_templates" class="fn">fetch_templates</a>(&amp;self) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch all.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.fetch_template" class="method"><a class="srclink rightside" href="../../../src/mailpot/templates.rs.html#244-291">source</a><h4 class="code-header">pub fn <a href="#method.fetch_template" class="fn">fetch_template</a>(
    &amp;self,
    template: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>,
    list_pk: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>&gt;
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>&gt;&gt;&gt;</h4></section></summary><div class="docblock"><p>Fetch a named template.</p>
</div><div class="docblock scraped-example-list"><span></span><h5 id="scraped-examples-48"><a href="#scraped-examples-48">Examples found in repository</a><a class="scrape-help" href="../../../scrape-examples-help.html">?</a></h5><div class="scraped-example " data-locs="[[[18,18],&quot;../../../src/mailpot/posts.rs.html#737&quot;,&quot;line 737&quot;]]"><div class="scraped-example-title">core/src/posts.rs (<a href="../../../src/mailpot/posts.rs.html#737">line 737</a>)</div><div class="code-wrapper"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
</pre></div><pre class="rust"><code><button class="expand">&varr;</button>    <span class="kw">pub fn </span>send_reply_with_list_template&lt;<span class="lifetime">&#39;ctx</span>, F: Fn() -&gt; Template&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        render_context: TemplateRenderContext&lt;<span class="lifetime">&#39;ctx</span>, F&gt;,
        recipients: <span class="kw">impl </span>Iterator&lt;Item = Cow&lt;<span class="lifetime">&#39;ctx</span>, melib::Address&gt;&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
        <span class="kw">let </span>TemplateRenderContext {
            template,
            default_fn,
            list,
            context,
            queue,
            comment,
        } = render_context;

        <span class="kw">let </span>post_policy = <span class="self">self</span>.list_post_policy(list.pk)<span class="question-mark">?</span>;
        <span class="kw">let </span>subscription_policy = <span class="self">self</span>.list_subscription_policy(list.pk)<span class="question-mark">?</span>;

        <span class="kw">let </span>templ = <span class="self">self
            </span>.<span class="highlight focus">fetch_template</span>(template, <span class="prelude-val">Some</span>(list.pk))<span class="question-mark">?
            </span>.map(DbVal::into_inner)
            .or_else(|| default_fn.map(|f| f()))
            .ok_or_else(|| -&gt; <span class="kw">crate</span>::Error {
                <span class="macro">format!</span>(<span class="string">&quot;Template with name {template:?} was not found.&quot;</span>).into()
            })<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>draft = templ.render(context)<span class="question-mark">?</span>;
        draft.headers.insert(
            melib::HeaderName::new_unchecked(<span class="string">&quot;From&quot;</span>),
            list.request_subaddr(),
        );
        <span class="kw">for </span>addr <span class="kw">in </span>recipients {
            <span class="kw">let </span><span class="kw-2">mut </span>draft = draft.clone();
            draft
                .headers
                .insert(melib::HeaderName::new_unchecked(<span class="string">&quot;To&quot;</span>), addr.to_string());
            list.insert_headers(
                <span class="kw-2">&amp;mut </span>draft,
                post_policy.as_deref(),
                subscription_policy.as_deref(),
            );
            <span class="self">self</span>.insert_to_queue(QueueEntry::new(
                queue,
                <span class="prelude-val">Some</span>(list.pk),
                <span class="prelude-val">None</span>,
                draft.finalise()<span class="question-mark">?</span>.as_bytes(),
                <span class="prelude-val">Some</span>(comment.to_string()),
            )<span class="question-mark">?</span>)<span class="question-mark">?</span>;
        }
        <span class="prelude-val">Ok</span>(())
    }</code></pre></div></div></div></div></details><details class="toggle method-toggle" open><summary><section id="method.add_template" class="method"><a class="srclink rightside" href="../../../src/mailpot/templates.rs.html#294-342">source</a><h4 class="code-header">pub fn <a href="#method.add_template" class="fn">add_template</a>(&amp;self, template: <a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../models/struct.DbVal.html" title="struct mailpot::models::DbVal">DbVal</a>&lt;<a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>Insert a named template.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.remove_template" class="method"><a class="srclink rightside" href="../../../src/mailpot/templates.rs.html#345-367">source</a><h4 class="code-header">pub fn <a href="#method.remove_template" class="fn">remove_template</a>(
    &amp;self,
    template: &amp;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.str.html">str</a>,
    list_pk: <a class="enum" href="https://doc.rust-lang.org/nightly/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.i64.html">i64</a>&gt;
) -&gt; <a class="type" href="../../errors/type.Result.html" title="type mailpot::errors::Result">Result</a>&lt;<a class="struct" href="../../templates/struct.Template.html" title="struct mailpot::templates::Template">Template</a>&gt;</h4></section></summary><div class="docblock"><p>Remove a named template.</p>
</div></details></div><h2 id="trait-implementations" class="small-section-header">Trait Implementations<a href="#trait-implementations" class="anchor">§</a></h2><div id="trait-implementations-list"><details class="toggle implementors-toggle" open><summary><section id="impl-Debug-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#890">source</a><a href="#impl-Debug-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html" title="trait core::fmt::Debug">Debug</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.fmt" class="method trait-impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#890">source</a><a href="#method.fmt" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html#tymethod.fmt" class="fn">fmt</a>(&amp;self, f: &amp;mut <a class="struct" href="https://doc.rust-lang.org/nightly/core/fmt/struct.Formatter.html" title="struct core::fmt::Formatter">Formatter</a>&lt;'_&gt;) -&gt; <a class="type" href="https://doc.rust-lang.org/nightly/core/fmt/type.Result.html" title="type core::fmt::Result">Result</a></h4></section></summary><div class='docblock'>Formats the value using the given formatter. <a href="https://doc.rust-lang.org/nightly/core/fmt/trait.Debug.html#tymethod.fmt">Read more</a></div></details></div></details><details class="toggle implementors-toggle" open><summary><section id="impl-Deref-for-Savepoint%3C'_%3E" class="impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#980-987">source</a><a href="#impl-Deref-for-Savepoint%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/deref/trait.Deref.html" title="trait core::ops::deref::Deref">Deref</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'_&gt;</h3></section></summary><div class="impl-items"><details class="toggle" open><summary><section id="associatedtype.Target" class="associatedtype trait-impl"><a href="#associatedtype.Target" class="anchor">§</a><h4 class="code-header">type <a href="https://doc.rust-lang.org/nightly/core/ops/deref/trait.Deref.html#associatedtype.Target" class="associatedtype">Target</a> = <a class="struct" href="../struct.Connection.html" title="struct mailpot::connection::Connection">Connection</a></h4></section></summary><div class='docblock'>The resulting type after dereferencing.</div></details><details class="toggle method-toggle" open><summary><section id="method.deref" class="method trait-impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#984-986">source</a><a href="#method.deref" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/ops/deref/trait.Deref.html#tymethod.deref" class="fn">deref</a>(&amp;self) -&gt; &amp;<a class="struct" href="../struct.Connection.html" title="struct mailpot::connection::Connection">Connection</a></h4></section></summary><div class='docblock'>Dereferences the value.</div></details></div></details><details class="toggle implementors-toggle" open><summary><section id="impl-Drop-for-Savepoint%3C'_%3E" class="impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#898-902">source</a><a href="#impl-Drop-for-Savepoint%3C'_%3E" class="anchor">§</a><h3 class="code-header">impl <a class="trait" href="https://doc.rust-lang.org/nightly/core/ops/drop/trait.Drop.html" title="trait core::ops::drop::Drop">Drop</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'_&gt;</h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.drop" class="method trait-impl"><a class="srclink rightside" href="../../../src/mailpot/connection.rs.html#899-901">source</a><a href="#method.drop" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/ops/drop/trait.Drop.html#tymethod.drop" class="fn">drop</a>(&amp;mut self)</h4></section></summary><div class='docblock'>Executes the destructor for this type. <a href="https://doc.rust-lang.org/nightly/core/ops/drop/trait.Drop.html#tymethod.drop">Read more</a></div></details></div></details></div><h2 id="synthetic-implementations" class="small-section-header">Auto Trait Implementations<a href="#synthetic-implementations" class="anchor">§</a></h2><div id="synthetic-implementations-list"><section id="impl-RefUnwindSafe-for-Savepoint%3C'conn%3E" class="impl"><a href="#impl-RefUnwindSafe-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; !<a class="trait" href="https://doc.rust-lang.org/nightly/core/panic/unwind_safe/trait.RefUnwindSafe.html" title="trait core::panic::unwind_safe::RefUnwindSafe">RefUnwindSafe</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section><section id="impl-Send-for-Savepoint%3C'conn%3E" class="impl"><a href="#impl-Send-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; !<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section><section id="impl-Sync-for-Savepoint%3C'conn%3E" class="impl"><a href="#impl-Sync-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; !<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section><section id="impl-Unpin-for-Savepoint%3C'conn%3E" class="impl"><a href="#impl-Unpin-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Unpin.html" title="trait core::marker::Unpin">Unpin</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section><section id="impl-UnwindSafe-for-Savepoint%3C'conn%3E" class="impl"><a href="#impl-UnwindSafe-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;'conn&gt; !<a class="trait" href="https://doc.rust-lang.org/nightly/core/panic/unwind_safe/trait.UnwindSafe.html" title="trait core::panic::unwind_safe::UnwindSafe">UnwindSafe</a> for <a class="struct" href="struct.Savepoint.html" title="struct mailpot::connection::transaction::Savepoint">Savepoint</a>&lt;'conn&gt;</h3></section></div><h2 id="blanket-implementations" class="small-section-header">Blanket Implementations<a href="#blanket-implementations" class="anchor">§</a></h2><div id="blanket-implementations-list"><details class="toggle implementors-toggle"><summary><section id="impl-Any-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/any.rs.html#201">source</a><a href="#impl-Any-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/any/trait.Any.html" title="trait core::any::Any">Any</a> for T<span class="where fmt-newline">where
    T: 'static + ?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>,</span></h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.type_id" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/any.rs.html#202">source</a><a href="#method.type_id" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/any/trait.Any.html#tymethod.type_id" class="fn">type_id</a>(&amp;self) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/core/any/struct.TypeId.html" title="struct core::any::TypeId">TypeId</a></h4></section></summary><div class='docblock'>Gets the <code>TypeId</code> of <code>self</code>. <a href="https://doc.rust-lang.org/nightly/core/any/trait.Any.html#tymethod.type_id">Read more</a></div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-Borrow%3CT%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/borrow.rs.html#208">source</a><a href="#impl-Borrow%3CT%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/borrow/trait.Borrow.html" title="trait core::borrow::Borrow">Borrow</a>&lt;T&gt; for T<span class="where fmt-newline">where
    T: ?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>,</span></h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.borrow" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/borrow.rs.html#210">source</a><a href="#method.borrow" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/borrow/trait.Borrow.html#tymethod.borrow" class="fn">borrow</a>(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.reference.html">&amp;T</a></h4></section></summary><div class='docblock'>Immutably borrows from an owned value. <a href="https://doc.rust-lang.org/nightly/core/borrow/trait.Borrow.html#tymethod.borrow">Read more</a></div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-BorrowMut%3CT%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/borrow.rs.html#216">source</a><a href="#impl-BorrowMut%3CT%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/borrow/trait.BorrowMut.html" title="trait core::borrow::BorrowMut">BorrowMut</a>&lt;T&gt; for T<span class="where fmt-newline">where
    T: ?<a class="trait" href="https://doc.rust-lang.org/nightly/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a>,</span></h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.borrow_mut" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/borrow.rs.html#217">source</a><a href="#method.borrow_mut" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/borrow/trait.BorrowMut.html#tymethod.borrow_mut" class="fn">borrow_mut</a>(&amp;mut self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/nightly/std/primitive.reference.html">&amp;mut T</a></h4></section></summary><div class='docblock'>Mutably borrows from an owned value. <a href="https://doc.rust-lang.org/nightly/core/borrow/trait.BorrowMut.html#tymethod.borrow_mut">Read more</a></div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-From%3CT%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#722">source</a><a href="#impl-From%3CT%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.From.html" title="trait core::convert::From">From</a>&lt;T&gt; for T</h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.from" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#725">source</a><a href="#method.from" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/convert/trait.From.html#tymethod.from" class="fn">from</a>(t: T) -&gt; T</h4></section></summary><div class="docblock"><p>Returns the argument unchanged.</p>
</div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-Into%3CU%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#706">source</a><a href="#impl-Into%3CU%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T, U&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.Into.html" title="trait core::convert::Into">Into</a>&lt;U&gt; for T<span class="where fmt-newline">where
    U: <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.From.html" title="trait core::convert::From">From</a>&lt;T&gt;,</span></h3></section></summary><div class="impl-items"><details class="toggle method-toggle" open><summary><section id="method.into" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#715">source</a><a href="#method.into" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/convert/trait.Into.html#tymethod.into" class="fn">into</a>(self) -&gt; U</h4></section></summary><div class="docblock"><p>Calls <code>U::from(self)</code>.</p>
<p>That is, this conversion is whatever the implementation of
<code><a href="https://doc.rust-lang.org/nightly/core/convert/trait.From.html" title="trait core::convert::From">From</a>&lt;T&gt; for U</code> chooses to do.</p>
</div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-TryFrom%3CU%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#762">source</a><a href="#impl-TryFrom%3CU%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T, U&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html" title="trait core::convert::TryFrom">TryFrom</a>&lt;U&gt; for T<span class="where fmt-newline">where
    U: <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.Into.html" title="trait core::convert::Into">Into</a>&lt;T&gt;,</span></h3></section></summary><div class="impl-items"><details class="toggle" open><summary><section id="associatedtype.Error" class="associatedtype trait-impl"><a href="#associatedtype.Error" class="anchor">§</a><h4 class="code-header">type <a href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html#associatedtype.Error" class="associatedtype">Error</a> = <a class="enum" href="https://doc.rust-lang.org/nightly/core/convert/enum.Infallible.html" title="enum core::convert::Infallible">Infallible</a></h4></section></summary><div class='docblock'>The type returned in the event of a conversion error.</div></details><details class="toggle method-toggle" open><summary><section id="method.try_from" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#769">source</a><a href="#method.try_from" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html#tymethod.try_from" class="fn">try_from</a>(value: U) -&gt; <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;T, &lt;T as <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html" title="trait core::convert::TryFrom">TryFrom</a>&lt;U&gt;&gt;::<a class="associatedtype" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html#associatedtype.Error" title="type core::convert::TryFrom::Error">Error</a>&gt;</h4></section></summary><div class='docblock'>Performs the conversion.</div></details></div></details><details class="toggle implementors-toggle"><summary><section id="impl-TryInto%3CU%3E-for-Savepoint%3C'conn%3E" class="impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#747">source</a><a href="#impl-TryInto%3CU%3E-for-Savepoint%3C'conn%3E" class="anchor">§</a><h3 class="code-header">impl&lt;T, U&gt; <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryInto.html" title="trait core::convert::TryInto">TryInto</a>&lt;U&gt; for T<span class="where fmt-newline">where
    U: <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html" title="trait core::convert::TryFrom">TryFrom</a>&lt;T&gt;,</span></h3></section></summary><div class="impl-items"><details class="toggle" open><summary><section id="associatedtype.Error-1" class="associatedtype trait-impl"><a href="#associatedtype.Error-1" class="anchor">§</a><h4 class="code-header">type <a href="https://doc.rust-lang.org/nightly/core/convert/trait.TryInto.html#associatedtype.Error" class="associatedtype">Error</a> = &lt;U as <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html" title="trait core::convert::TryFrom">TryFrom</a>&lt;T&gt;&gt;::<a class="associatedtype" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html#associatedtype.Error" title="type core::convert::TryFrom::Error">Error</a></h4></section></summary><div class='docblock'>The type returned in the event of a conversion error.</div></details><details class="toggle method-toggle" open><summary><section id="method.try_into" class="method trait-impl"><a class="srclink rightside" href="https://doc.rust-lang.org/nightly/src/core/convert/mod.rs.html#754">source</a><a href="#method.try_into" class="anchor">§</a><h4 class="code-header">fn <a href="https://doc.rust-lang.org/nightly/core/convert/trait.TryInto.html#tymethod.try_into" class="fn">try_into</a>(self) -&gt; <a class="enum" href="https://doc.rust-lang.org/nightly/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;U, &lt;U as <a class="trait" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html" title="trait core::convert::TryFrom">TryFrom</a>&lt;T&gt;&gt;::<a class="associatedtype" href="https://doc.rust-lang.org/nightly/core/convert/trait.TryFrom.html#associatedtype.Error" title="type core::convert::TryFrom::Error">Error</a>&gt;</h4></section></summary><div class='docblock'>Performs the conversion.</div></details></div></details></div></section></div></main></body></html>